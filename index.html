<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cost of Living Calculator</title>

    <!-- Favicon for browsers -->
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/100/6366f1/money-bag.png">
    <link rel="shortcut icon" type="image/png" href="https://img.icons8.com/ios-filled/100/6366f1/money-bag.png">

    <!-- Apple Touch Icon and Web App Meta Tags for iOS Home Screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CoL Calc">
    <!-- Explicitly specify size for apple-touch-icon -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/100/6366f1/money-bag.png">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text color */
            overflow-x: hidden; /* Prevent horizontal scrolling */
            overflow-y: scroll; /* Always show vertical scrollbar to prevent layout shifts */
            touch-action: manipulation; /* Prevent double tap to zoom */
        }
        /* New style to prevent body scrolling when modal is open */
        body.modal-open {
            overflow: hidden;
            position: fixed; /* Prevent scrolling when modal is open */
            width: 100%; /* Maintain width when scrollbar is removed */
        }
        .container {
            max-width: 1200px; /* Wider container for calendar */
            margin: 2rem auto; /* Default margin for desktop */
            padding: 1.5rem; /* Default padding */
            background-color: #ffffff;
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* Softer shadow */
        }
        /* Responsive padding and margin for container */
        @media (max-width: 767px) { /* For screens smaller than md (768px) */
            .container {
                padding: 1rem; /* Smaller padding on mobile */
                margin-top: 1rem; /* Reduced top margin on mobile */
                margin-bottom: 1rem; /* Reduced bottom margin on mobile */
            }
        }
        /* General section title style */
        .section-title {
            font-size: 2rem; /* Increased slightly */
            font-weight: 700; /* Bold */
            color: #1e293b; /* Even darker title color */
            margin-bottom: 1.5rem; /* Default margin for when it's a standalone section title */
            /* text-align: center; Removed, now controlled by utility classes on h1 */
        }
        /* Specific adjustments for section-title when it's part of the nav-header */
        .nav-header .section-title {
            margin-bottom: 0; /* Remove vertical margin when inside the header flex container */
            /* text-align: center; Removed, now controlled by utility classes on h1 */
        }

        /* Adjusted heading sizes */
        h2 { /* Applies to: Welcome to..., Pay Estimator, Universal Credit Estimator, Add Transaction for..., Edit Transaction, Update Current Balance, Add Estimated Pay..., Add Estimated UC..., Menu */
            font-size: 1.5rem; /* text-xl */
            font-weight: 700; /* Changed from 2000 to 700 for bold */
            color: #1e293b;
            margin-bottom: 1rem;
            text-align: center; 
        }
        h3 { /* Applies to: Current Balance, Amount Available..., Upcoming Payment, Today's Transactions, Existing Transactions, Add New Transaction, 1. Update Your Balance... */
            font-size: 1.25rem; /* text-lg */
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }

        /* Custom class for headings matching overview current balance style */
        .heading-match-overview {
            font-size: 1.25rem; /* Matches text-xl */
            font-weight: 700; /* Matches font-bold */
            color: #1e293b; /* Matches current h2/h3 color */
            margin-bottom: 1.5rem; /* One line of text space (approx. 1.5rem for 1.25rem text) */
            text-align: center; /* Keep centered */
        }

        /* Updated span.font-semibold to have the requested color */
        span.font-semibold {
            color: #1e293b; 
        }

        .input-group label {
            font-weight: 500;
            color: #475569;
        }
        .input-group input, .input-group select {
            border: 1px solid #cbd5e1; /* Light gray border */
            border-radius: 0.5rem; /* Rounded input fields */
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #6366f1; /* Indigo focus color */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Soft focus ring */
        }
        .btn-primary {
            background-color: #6366f1; /* Indigo button */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #4f46e5; /* Darker indigo on hover */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #e2e8f0; /* Light gray button */
            color: #475569;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* Darker gray on hover */
            transform: translateY(-1px);
        }
        .btn-delete {
            background-color: #ef4444; /* Red delete button */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.8rem;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-delete:hover {
            background-color: #dc2626; /* Darker red on hover */
        }
        .btn-edit {
            background-color: #3b82f6; /* Blue edit button */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.8rem;
            transition: background-color 0.2s ease-in-out;
            /* margin-left: 0.5rem; Removed, now handled by gap on parent */
        }
        .btn-edit:hover {
            background-color: #2563eb; /* Darker blue on hover */
        }
        /* New style for icon buttons */
        .btn-icon {
            background: none;
            border: none;
            color: #3b82f6; /* Blue, matching btn-edit */
            cursor: pointer;
            padding: 0.1rem; /* Adjusted padding as requested */
            border-radius: 0.3rem;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex; /* Ensure it aligns well with text */
            align-items: center;
            justify-content: center;
        }
        .btn-icon:hover {
            background-color: #eff6ff; /* Light blue on hover */
        }
        .btn-icon svg {
            width: 1.1rem; /* Adjusted from 1.25rem (w-5) to 1.1rem */
            height: 1.1rem; /* Adjusted from 1.25rem (h-5) to 1.1rem */
            fill: currentColor;
        }
        /* Renamed class to avoid conflict with Tailwind */
        .svg-align-baseline {
            vertical-align: baseline;
        }

        .list-item {
            background-color: #f8fafc; /* Lighter background for list items */
            border: 1px solid #e2e8f0; /* Lighter border */
            border-radius: 0.75rem; /* Rounded list items */
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        .summary-card {
            background-color: #e0f2fe; /* Light blue for summary */
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .summary-card.positive {
            background-color: #d1fae5; /* Green for positive cash flow */
            color: #065f46;
        }
        .summary-card.negative {
            background-color: #fee2e2; /* Red for negative cash flow */
            color: #991b1b;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible; /* Ensure visibility when shown */
        }

        /* Calendar specific styles */
        .calendar-header {
            display: grid; /* Changed to grid */
            grid-template-columns: 1fr auto 1fr; /* For centering title on desktop */
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }
        /* New classes for calendar grid elements to allow for distinct styling and zooming */
        .calendar-grid-header-row,
        .calendar-grid-days {
            display: grid;
            grid-template-columns: repeat(7, minmax(80px, 1fr)); /* Default for monthly view */
            gap: 0.5rem;
        }
        .calendar-grid-header-row {
            margin-bottom: 0.5rem; /* Space between headers and days */
        }

        /* Wrapper for zoomable content - removed manual zoom, but keeping wrapper for structure */
        #calendarContentWrapper {
            /* transform-origin: top left; */ /* Removed */
            /* transition: transform 0.2s ease-in-out; */ /* Removed */
        }

        .calendar-day-header {
            /* Removed text-align: center; as flexbox will handle it */
            font-weight: 600;
            color: #475569;
            padding: 0.75rem; /* Match calendar-day padding */
            border: 1px solid transparent; /* Mimic calendar-day border for box model consistency */
            border-radius: 0.75rem; /* Match calendar-day border-radius for consistency */
            box-sizing: border-box; /* Ensure padding/border included in width */
            min-width: 0; /* Allow shrinking in grid */
            
            /* Added Flexbox for robust centering */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .calendar-day {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem; /* Ensure this is consistent */
            min-height: 120px; /* Increased height for content */
            display: flex;
            flex-direction: column;
            align-items: center; /* Changed from flex-start to center for alignment */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            position: relative; /* For cumulative total positioning */
            min-width: 0; /* Allow grid items to shrink */
            box-sizing: border-box; /* Include padding/border in width */
        }
        .calendar-day:hover {
            background-color: #eff6ff; /* Light blue on hover */
            border-color: #93c5fd; /* Light blue border on hover */
        }
        .calendar-day.today {
            border: 2px solid #6366f1; /* Highlight today */
            background-color: rgba(224, 231, 255, 0.5); /* Lighter indigo background with transparency */
        }
        .calendar-day.inactive {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }
        .calendar-day-number {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #1e293b;
        }
        /* Adjusted font size for monthly view content */
        .calendar-day-transactions {
            font-size: 0.5rem; /* Set font size to 0.5rem */
            color: #64748b;
            flex-grow: 1; /* Allows content to take available space */
            width: 100%;
            overflow-y: auto; /* Enable scrolling for many transactions */
            max-height: 60px; /* Limit height of transaction list */
            text-align: center; /* Center transaction text */
        }
        .calendar-day-transactions p {
            margin-bottom: 0.2rem;
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Show ellipsis */
        }
        .calendar-day-cumulative {
            font-size: 0.5rem; /* Default for mobile */
            color: #64748b;
            flex-grow: 1; /* Allows content to take available space */
            width: 100%;
            overflow-y: auto; /* Enable scrolling for many transactions */
            max-height: 60px; /* Limit height of transaction list */
            text-align: center; /* Center transaction text */
        }
        /* Desktop: Increase font size for cumulative balance */
        @media (min-width: 768px) {
            .calendar-day-cumulative {
                font-size: 1rem; /* Larger font for desktop */
            }
        }
        .calendar-day-cumulative.positive {
            color: #065f46; /* Green for positive */
        }
        .calendar-day-cumulative.negative {
            color: #991b1b; /* Red for negative */
        }

        /* Daily View specific styles */
        .calendar-grid-days.daily-view-active { /* New class for daily view container */
            position: relative;
            overflow: hidden;
            height: 400px; /* Fixed height for daily view container to prevent height jump */
            display: block; /* Override grid display for daily view */
        }
        .daily-view-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.2s ease-out; /* Smooth snap-back transition */
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box; /* Include padding/border in width/height */
        }
        .daily-view-content > .calendar-day { /* Target the actual day element inside the content wrapper */
            width: 100%;
            height: 100%; /* Make it fill the parent */
            box-sizing: border-box;
            cursor: default; /* Remove pointer cursor for the whole day */
        }

        .calendar-daily-view-container .calendar-day {
            min-height: 300px; /* Larger height for daily view */
            padding: 1.5rem;
            /* Changed to column flex for internal layout */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to the top */
            align-items: stretch; /* Stretch children to fill width */
            cursor: default; /* Remove pointer cursor for the whole day */
        }
        .calendar-daily-view-container .calendar-day-transactions {
            max-height: 180px; /* Set a max height for the scrollable area */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
            margin-bottom: 1rem;
            font-size: 0.75rem; /* Revert to original size for daily view */
            text-align: left; /* Align text to the left for daily view transactions */
        }
        .calendar-daily-view-container .calendar-day-transactions .modal-transaction-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 0.5rem;
        }
        .calendar-daily-view-container .calendar-day-transactions .modal-transaction-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .calendar-daily-view-container .calendar-day-transactions .text-xs {
            font-size: 0.7rem; /* Slightly smaller for details */
        }
        .calendar-daily-view-container .calendar-day-cumulative {
            align-self: flex-start; /* Position at bottom left for daily view */
            font-size: 1.2rem; /* Revert to original size for daily view */
            margin-top: 1rem;
        }
        /* Changed from add-transaction-daily-btn to btn-primary */
        .calendar-daily-view-container .btn-primary {
            width: 100%;
            margin-top: auto; /* Pushes the button to the bottom */
            touch-action: manipulation; /* Ensure touch events are handled directly */
        }


        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2); /* More transparent */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
            /* Allow internal scrolling for modal content */
            max-height: 90vh; /* Limit height to viewport height */
            overflow-y: auto; /* Enable scrolling within the modal */
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        /* Removed .modal-close-btn CSS as it's no longer used for the 'X' button */
        /* .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }
        .modal-close-btn:hover {
            color: #1e293b;
        } */
        .modal-transaction-list {
            max-height: 200px; /* Limit height of transactions in modal */
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
        }
        .modal-transaction-item:last-child {
            border-bottom: none;
        }

        /* Edit Modal specific styles */
        .edit-scope-options label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }
        .edit-scope-options input[type="radio"] {
            margin-right: 0.5rem;
        }

        /* Tab styles */
        .tab-buttons {
            display: flex;
            justify-content: center; /* Centered on desktop */
            margin-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .tab-button.active {
            color: #6366f1;
            border-color: #6366f1;
        }
        .tab-content {
            display: none;
            width: 100%; /* Ensure it takes full available width */
            box-sizing: border-box; /* Include padding/border in width */
            /* Removed overflow-x: hidden to allow shadows to spill out */
        }
        .tab-content.active {
            display: block;
        }

        /* Overview specific styles */
        .overview-card {
            background-color: #fff;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem; /* Reduced from 1.5rem */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); /* More pronounced shadow */
        }
        .overview-card h3 {
            font-size: 1.1rem; /* Adjusted for consistency */
            font-weight: 600; /* Already font-semibold, which maps to 600 */
            color: #1e293b;
            margin-bottom: 1rem;
        }
        .overview-card p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        /* Removed .overview-card .value specific styles as they are now handled by individual spans */
        /* .overview-card .value {
            font-weight: 700;
            color: #334155;
            font-size: 1.1rem;
        } */
        .overview-card .value-display .positive {
            color: #065f46;
        }
        .overview-card .value-display .negative {
            color: #991b1b;
        }
        /* New styles for the balance display elements */
        .value-display {
            display: flex;
            align-items: baseline; /* Align text at the baseline */
            justify-content: flex-end; /* Push content to the right */
            width: 8rem; /* Fixed width for the entire value display (e.g., 128px) */
            font-weight: 700; /* Bold for all parts */
            font-size: 1.25rem; /* text-xl equivalent */
            line-height: 1.75rem; /* line-height for text-xl */
        }
        /* Removed .value-display .sign as it's now directly controlled by flex-end on parent */
        .value-display .currency {
            /* No fixed width, let it take its natural width */
            padding-right: 0.1rem; /* Small space between currency and number */
        }
        .value-display .amount {
            /* No fixed width, let it take its natural width */
            text-align: right; /* Right-align the number for decimal alignment */
        }

        .overview-transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px dashed #e2e8f0;
            font-size: 0.9rem;
        }
        .overview-transaction-item:last-child {
            border-bottom: none;
        }

        /* Pay Estimator specific styles */
        .pay-estimator-result, .uc-calculator-result {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        .pay-estimator-result p, .uc-calculator-result p {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .pay-estimator-result .label, .uc-calculator-result .label {
            font-weight: 500;
            color: #475569;
        }
        .pay-estimator-result .value, .uc-calculator-result .value {
            font-weight: 600;
            color: #1e293b;
        }
        .pay-estimator-result .net-pay, .uc-calculator-result .net-payment {
            font-size: 1.25rem;
            font-weight: 700;
            color: #065f46; /* Green for net pay */
            margin-top: 1rem;
            border-top: 1px solid #cbd5e1;
            padding-top: 1rem;
        }

        /* Universal Credit specific styles */
        .uc-input-group {
            margin-bottom: 1rem;
        }
        .uc-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #475569;
        }
        .uc-input-group input[type="number"],
        .uc-input-group select {
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out;
        }
        .uc-input-group input[type="radio"] {
            margin-right: 0.5rem;
        }
        .uc-input-group .radio-option {
            display: inline-flex;
            align-items: center;
            margin-right: 1rem;
        }
        .uc-input-group .with-button {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .uc-input-group .with-button input {
            flex-grow: 1;
        }
        .uc-input-group .import-btn {
            background-color: #4f46e5; /* Darker indigo for import button */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem; /* text-sm */
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            white-space: nowrap; /* Prevent text wrapping */
        }
        .uc-input-group .import-btn:hover {
            background-color: #3730a3; /* Even darker indigo on hover */
            transform: translateY(-1px);
        }

        .uc-calculator-result .negative {
            color: #991b1b;
        }
        /* Getting Started specific styles */
        .getting-started-section {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .getting-started-section h3 {
            font-size: 1.25rem; /* Adjusted for consistency */
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }
        .getting-started-section p {
            font-size: 0.95rem;
            color: #475569;
            line-height: 1.5;
        }

        /* Custom class for 1.5rem indentation */
        .indent-1-5rem {
            margin-left: 1.5rem;
        }

        /* Responsive Calendar Adjustments for Monthly View on Mobile */
        @media (max-width: 767px) {
            .calendar-grid-header-row,
            .calendar-grid-days {
                grid-template-columns: repeat(7, 1fr); /* Force equal width columns on mobile */
                gap: 0.4rem; /* Increased gap slightly for better separation */
            }
            .calendar-day {
                min-height: 100px; /* Slightly reduce height for mobile monthly view */
                padding: 0.5rem; /* Reduce padding */
            }
            .calendar-day-number {
                font-size: 0.9rem; /* Smaller day number */
            }
            .calendar-day-transactions,
            .calendar-day-cumulative {
                font-size: 0.5rem; /* Smaller transaction text */
                max-height: 45px; /* Adjust max height for transaction list */
            }
            .nav-header .section-title {
                font-size: 1.5rem; /* Slightly larger for mobile header */
            }
            /* Mobile modal heading sizes */
            #mobileNavModal .modal-content h2 {
                font-size: 1.5rem; /* Keep consistent with other h2 */
            }

            /* Calendar Header for Mobile (buttons hidden) */
            .calendar-header {
                grid-template-columns: auto; /* Only one column for the title */
                justify-content: center; /* Center the title */
            }
        }

        /* Navigation Menu Styles */
        .nav-header {
            display: flex;
            justify-content: center; /* Centered title */
            align-items: center;
            margin-bottom: 1rem;
            position: relative; /* For absolute positioning of children */
        }

        .menu-toggle-btn {
            display: none; /* Hidden by default on desktop */
            background: none;
            border: none;
            color: #6366f1;
            cursor: pointer;
            padding: 0.5rem; /* Reduced padding for a tighter button */
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            /* Style for SVG icon */
            align-items: center;
            justify-content: center;
            width: 48px; /* Larger width for icon */
            height: 48px; /* Larger height for icon */
            position: absolute; /* Position absolutely */
            right: 0; /* Align to the right */
            top: 50%;
            transform: translateY(-50%);
        }
        .menu-toggle-btn:hover {
            background-color: #e0e7ff;
        }

        /* Hamburger icon SVG styling */
        .menu-toggle-btn svg {
            width: 32px; /* Adjust size of the SVG icon */
            height: 32px;
            fill: currentColor; /* Use button's text color for the icon */
        }

        /* Desktop: Tab buttons are always visible, hamburger is hidden */
        .tab-buttons {
            display: flex; /* Always flex on desktop */
            justify-content: center; /* Centered on desktop */
            margin-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        @media (max-width: 767px) {
            .menu-toggle-btn {
                display: flex; /* Show menu button on mobile */
            }
            .tab-buttons {
                display: none; /* Hide tab buttons on mobile */
            }
            /* Mobile Navigation Modal specific styles */
            #mobileNavModal .modal-content {
                width: 90%;
                max-width: 400px; /* Slightly narrower for mobile menu */
                padding: 1.5rem;
            }
            .mobile-nav-buttons {
                display: flex;
                flex-direction: column;
                gap: 0.75rem; /* Space between buttons */
            }
            .mobile-nav-button {
                background-color: #6366f1; /* Indigo for buttons, matching btn-primary */
                color: white; /* White text */
                padding: 0.75rem 1.5rem; /* Match btn-primary padding */
                border-radius: 0.5rem; /* Match btn-primary border-radius */
                font-size: 1rem; /* Match btn-primary font size */
                font-weight: 600; /* Match btn-primary font weight */
                text-align: center;
                transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Match btn-primary shadow */
            }
            .mobile-nav-button:hover {
                background-color: #4f46e5; /* Darker indigo on hover, matching btn-primary */
                transform: translateY(-1px);
            }
            .mobile-nav-button.active {
                background-color: #4f46e5; /* Darker indigo for active button */
                color: white;
            }
        }
        /* Custom CSS for checkbox color */
        input[type="checkbox"]#addAdjustForNonWorkingDays:checked,
        input[type="checkbox"]#editAdjustForNonWorkingDays:checked {
            accent-color: #4f46e5; /* Explicitly set the desired color for the checkboxes */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-header">
            <!-- Reintroduced line break for mobile view -->
            <h1 class="section-title flex-grow text-center">
                The Cost of Living Calculator
            </h1>
            <button id="menuToggleBtn" class="menu-toggle-btn">
                <!-- Hamburger Icon SVG -->
                <svg viewBox="0 0 27 27" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                </svg>
            </button>
        </div>

        <!-- Tab Buttons Container (Desktop Only) -->
        <!-- This div now only contains the desktop tab buttons and is hidden on mobile via CSS -->
        <div class="tab-buttons" id="desktopTabButtons">
            <button class="tab-button" data-tab="getting-started">Getting Started</button>
            <button class="tab-button active" data-tab="overview">Overview</button>
            <button class="tab-button" data-tab="calendar">Calendar</button>
            <button class="tab-button" data-tab="pay-estimator">Pay Estimator</button>
            <button class="tab-button" data-tab="universal-credit">UC Estimator</button>
        </div>

        <!-- Getting Started Tab Content (New Tab) -->
        <div id="getting-startedTabContent" class="tab-content">
            <h2 class="heading-match-overview">Welcome to The Cost of Living Calculator!</h2>
            <p class="text-gray-600 mb-6 indent-1-5rem">This tool helps you manage your finances by tracking income and expenses, estimating future cash flow, and calculating potential earnings and benefits. Here's a quick guide to help you get started and make the most of the app:</p>

            <div class="getting-started-section">
                <h3>1. Update Your Balance (Overview Tab)</h3>
                <p>First, navigate to the **Overview** tab. Here, you'll find a section to "Update Balance". Enter your current bank balance to ensure all future calculations are accurate. This sets your starting point for understanding your cash flow.</p>
            </div>

            <div class="getting-started-section">
                <h3>2. Enter Your Regular Income and Outgoings (Calendar Tab)</h3>
                <p>Next, switch to the **Calendar** tab. Click on any day to add your regular income (like salary or benefits) and recurring expenses (like rent, bills, or subscriptions). You can set these transactions to repeat daily, weekly, bi-weekly, four-weekly, or monthly. By doing this, the calendar will automatically project your future balance, showing you exactly where your money is expected to go and when.</p>
            </div>

            <div class="getting-started-section">
                <h3>3. Estimate Your Pay (Pay Estimator Tab)</h3>
                <p>If you want to understand your take-home pay, visit the **Pay Estimator** tab. Input your pay rate (hourly, daily, weekly, monthly, or annually) and frequency. The calculator will provide a breakdown of your estimated gross pay, National Insurance, and Income Tax deductions, giving you your net pay. You can then easily add this estimated net pay as an "income" transaction to your Calendar.</p>
            </div>

            <div class="getting-started-section">
                <h3>4. Estimate Your Universal Credit (UC Estimator Tab)</h3>
                <p>For a simplified estimate of your potential Universal Credit payment, go to the **UC Estimator** tab. Enter details about your household, children, disability status, monthly rent, and importantly, your monthly net earnings. You can quickly import your estimated net earnings directly from the Pay Estimator. The calculated UC payment can then be added to your Calendar to see its impact on your overall finances.</p>
            </div>

            <p class="text-gray-600 mt-6 indent-1-5rem">By following these steps, you'll gain a clear picture of your financial situation, helping you plan and manage your money effectively!</p>
        </div>

        <!-- Overview Tab Content -->
        <div id="overviewTabContent" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <!-- Changed gap-6 to gap-4 -->
                <!-- Current Balance and Amount Available for Spending -->
                <div class="overview-card md:col-span-2">
                    <div class="flex flex-col gap-4"> <!-- New flex container for the balance rows -->
                        <!-- Current Balance Row -->
                        <div class="flex justify-between items-center w-full">
                            <p class="font-semibold text-xl flex-shrink-0">Current Balance:</p>
                            <div class="flex items-center"> <!-- Wrapper for value and button -->
                                <div id="currentBalanceDisplay" class="value-display">
                                    <span id="currentBalanceSign" class="sign"></span>
                                    <span id="currentBalanceCurrency" class="currency">£</span>
                                    <span id="currentBalanceValue" class="amount">0.00</span>
                                </div>
                                <button id="updateBalanceBtn" class="btn-icon ml-2 flex-shrink-0">
                                    <!-- SVG for edit icon -->
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 27 27" stroke-width="3" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14.25v4.5m-6.75-6.75h.008v.008H12v-.008Z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <!-- Amount Available Row -->
                        <div class="flex justify-between items-center w-full">
                            <p class="font-semibold text-xl flex-shrink-0">Amount Available:</p>
                            <div class="flex items-center"> <!-- Wrapper for value and button -->
                                <div id="lowestBalanceDisplay" class="value-display">
                                    <span id="lowestBalanceSign" class="sign"></span>
                                    <span id="lowestBalanceCurrency" class="currency">£</span>
                                    <span id="lowestBalanceValue" class="amount">0.00</span>
                                </div>
                                <button id="amountAvailableHelpBtn" class="ml-2 text-indigo-500 hover:text-indigo-700 focus:outline-none flex-shrink-0">
                                    <!-- Changed class from align-text-bottom to svg-align-baseline -->
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 27 27" stroke-width="3" stroke="currentColor" class="w-5 h-5 inline-block svg-align-baseline">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="overview-card md:col-span-2">
                    <h3 class="font-semibold text-base md:text-lg">Upcoming Payment</h3> <!-- Added font-semibold and text-base for mobile, text-lg for desktop -->
                    <!-- Added mt-4 for consistent spacing from h3 -->
                    <p id="overviewNextIncomeStatement" class="text-sm text-gray-600 text-left mt-4"></p>
                </div>

                <!-- New grid for Today's Transactions and Monthly Income vs. Expenses -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:col-span-2"> <!-- Changed gap-6 to gap-4 -->
                    <div class="overview-card">
                        <h3 class="font-semibold text-base md:text-lg">Today's Transactions</h3> <!-- Added font-semibold and text-base for mobile, text-lg for desktop -->
                        <!-- Removed mt-4 from this div, added pt-0 to p inside for spacing control -->
                        <div id="overviewTodaysTransactionsList">
                            <!-- Changed py-4 to pt-0 for the p tag inside -->
                            <p class="text-gray-500 text-left pt-0 text-sm">No transactions for today.</p>
                        </div>
                    </div>
                    <div class="overview-card">
                        <h3 class="font-semibold text-base md:text-lg">Monthly Income vs. Expenses</h3> <!-- Added font-semibold and text-base for mobile, text-lg for desktop -->
                        <div id="pieChartContainer" class="relative w-full h-64">
                            <canvas id="incomeExpensePieChart" class="w-full h-full"></canvas>
                            <!-- Removed px-6 pt-6 for alignment, inset-0 and flex properties handle positioning -->
                            <p id="pieChartDescription" class="absolute inset-0 flex items-start justify-start bg-white bg-opacity-90 rounded-lg text-gray-500 text-left text-sm">
                                This chart illustrates the proportion of your income versus expenses for the current month. Add transactions to see your financial breakdown.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Tab Content -->
        <div id="calendarTabContent" class="tab-content">
            <!-- Calendar Header (Month/Year and Nav Buttons) -->
            <div class="calendar-header mb-4 p-2">
                <!-- Added md:block to show on medium screens and up, hidden by default on small screens -->
                <button id="prevMonthBtn" class="btn-secondary px-4 py-2 rounded-lg justify-self-start hidden md:block">&lt; Prev</button>
                <h2 id="currentMonthYear" class="text-xl font-semibold text-gray-800 text-center flex-grow"></h2>
                <!-- Added md:block to show on medium screens and up, hidden by default on small screens -->
                <button id="nextMonthBtn" class="btn-secondary px-4 py-2 rounded-lg justify-self-end hidden md:block">Next &gt;</button>
            </div>

            <!-- Calendar View Toggle Switch -->
            <div class="flex justify-center items-center mb-4">
                <span class="text-sm text-gray-600 mr-2">Monthly View</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="calendarViewToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                </label>
                <span class="text-sm text-gray-600 ml-2">Daily View</span>
            </div>

            <!-- Calendar Grid Container (removed overflow-x-auto) -->
            <!-- Adjusted padding for mobile: px-2 py-4 -->
            <div class="mb-8 px-2 py-4 md:p-6 bg-gray-50 rounded-xl shadow-inner">
                <div id="calendarContentWrapper">
                    <!-- The header row is now explicitly a grid for alignment -->
                    <div class="calendar-grid-header-row">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                    </div>
                    <div id="calendarDays" class="calendar-grid-days"></div>
                </div>
            </div>

            <!-- New: Clear All Transactions Button -->
            <div class="flex justify-center mt-6">
                <button id="clearAllTransactionsBtn" class="btn-secondary">Clear All Transactions</button>
            </div>
        </div>

        <!-- Pay Estimator Tab Content -->
        <div id="pay-estimatorTabContent" class="tab-content">
            <h2 class="heading-match-overview">Pay Estimator</h2>
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="payRateAmount" class="block text-sm mb-1">Rate Amount (£):</label>
                        <input type="number" id="payRateAmount" placeholder="e.g., 15.00" step="0.01" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="payRateUnit" class="block text-sm mb-1">Rate Unit:</label>
                        <select id="payRateUnit" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="hourly">Hourly</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="annually">Annually</option>
                            <option value="project">Per Project</option>
                        </select>
                    </div>
                    <div class="input-group" id="contractedUnitsGroup">
                        <label for="contractedUnits" class="block text-sm mb-1" id="contractedUnitsLabel">Hours per Week:</label>
                        <input type="number" id="contractedUnits" placeholder="e.g., 40" step="0.1" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="payFrequency" class="block text-sm mb-1">Pay Frequency:</label>
                        <select id="payFrequency" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="weekly">Weekly</option>
                            <option value="bi-weekly">Bi-weekly</option>
                            <option value="four-weekly">Four Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="annually">Annually</option>
                        </select>
                    </div>
                </div>
                <button id="calculatePayBtn" class="btn-primary w-full">Calculate Pay</button>
            </div>

            <div id="payEstimatorResults" class="pay-estimator-result hidden">
                <p><span class="label">Gross Pay:</span> <span id="grossPayResult" class="value">£0.00</span></p>
                <p><span class="label">National Insurance:</span> <span id="niDeductionResult" class="value">£0.00</span></p>
                <p><span class="label">Income Tax:</span> <span id="taxDeductionResult" class="value">£0.00</span></p>
                <p class="net-pay"><span class="label">Net Pay:</span> <span id="netPayResult" class="value">£0.00</span></p>
                <button id="addEstimatedPayToCalendarBtn" class="btn-primary w-full mt-4">Add Net Pay to Calendar</button>
            </div>
        </div>

        <!-- Universal Credit Tab Content (New Tab) -->
        <div id="universal-creditTabContent" class="tab-content">
            <h2 class="heading-match-overview">Universal Credit Estimator</h2>
            <p class="text-sm text-gray-600 mb-4">This is a simplified estimator based on UK 2024/2025 Universal Credit rates. It does not account for all complex rules, deductions, or other benefits.</p>
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="uc-input-group md:col-span-2">
                        <label class="block text-sm mb-1">Are you claiming as a single person or a couple?</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="radio-option">
                                <input type="radio" name="ucClaimStatus" value="single" checked> Single
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="ucClaimStatus" value="couple"> Couple
                            </label>
                        </div>
                    </div>

                    <div class="uc-input-group" id="ucAgeGroupSingle">
                        <label class="block text-sm mb-1">Your Age Group:</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="radio-option">
                                <input type="radio" name="ucAge" value="under25" checked> Under 25
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="ucAge" value="25over"> 25 or Over
                            </label>
                        </div>
                    </div>

                    <div class="uc-input-group hidden" id="ucAgeGroupCouple">
                        <label class="block text-sm mb-1">Age Group (Person 1):</label>
                        <div class="flex flex-wrap gap-4 mb-2">
                            <label class="radio-option">
                                <input type="radio" name="ucAgeP1" value="under25" checked> Under 25
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="ucAgeP1" value="25over"> 25 or Over
                            </label>
                        </div>
                        <label class="block text-sm mb-1">Age Group (Person 2):</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="radio-option">
                                <input type="radio" name="ucAgeP2" value="under25" checked> Under 25
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="ucAgeP2" value="25over"> 25 or Over
                            </label>
                        </div>
                    </div>

                    <div class="uc-input-group">
                        <label for="ucNumChildren" class="block text-sm mb-1">Number of Children:</label>
                        <input type="number" id="ucNumChildren" value="0" min="0" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="uc-input-group">
                        <label for="ucChildBornBefore2017" class="block text-sm mb-1">Is at least one child born before 6 April 2017?</label>
                        <input type="checkbox" id="ucChildBornBefore2017" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <span class="text-xs text-gray-500 ml-2">(If checked, the higher child element will apply to one child born before this date, and the standard rate to any other children.)</span>
                    </div>

                    <div class="uc-input-group">
                        <label for="ucMonthlyRent" class="block text-sm mb-1">Monthly Rent (£):</label>
                        <input type="number" id="ucMonthlyRent" value="0.00" step="0.01" min="0" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div class="uc-input-group">
                        <label for="ucDisabilityStatus" class="block text-sm mb-1">Disability Status:</label>
                        <select id="ucDisabilityStatus" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="none">None</option>
                            <option value="lcw">Limited Capability for Work (LCW)</option>
                            <option value="lcwra">Limited Capability for Work & Work-Related Activity (LCWRA)</option>
                        </select>
                    </div>

                    <div class="uc-input-group md:col-span-2">
                        <label for="ucMonthlyEarnings" class="block text-sm mb-1">Monthly Net Earnings (after tax/NI) (£):</label>
                        <div class="with-button">
                            <input type="number" id="ucMonthlyEarnings" value="0.00" step="0.01" min="0" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <button id="importPayEstimatorEarningsBtn" class="import-btn">Import from Pay Estimator</button>
                        </div>
                    </div>
                </div>
                <button id="calculateUCBtn" class="btn-primary w-full">Calculate Universal Credit</button>
            </div>

            <div id="ucCalculatorResults" class="uc-calculator-result hidden">
                <p><span class="label">Standard Allowance:</span> <span id="ucStandardAllowance" class="value">£0.00</span></p>
                <p><span class="label">Child Elements:</span> <span id="ucChildElements" class="value">£0.00</span></p>
                <p><span class="label">Disability Element:</span> <span id="ucDisabilityElement" class="value">£0.00</span></p>
                <p><span class="label">Housing Element:</span> <span id="ucHousingElement" class="value">£0.00</span></p>
                <p><span class="label">Total Elements:</span> <span id="ucTotalElements" class="value">£0.00</span></p>
                <p class="mt-4"><span class="label">Work Allowance Applied:</span> <span id="ucWorkAllowance" class="value">£0.00</span></p>
                <p><span class="label">Earnings Deduction:</span> <span id="ucEarningsDeduction" class="value">£0.00</span></p>
                <p class="net-payment"><span class="label">Estimated Monthly UC:</span> <span id="ucNetPayment" class="value">£0.00</span></p>
                <button id="addEstimatedUCtoCalendarBtn" class="btn-primary w-full mt-4">Add Estimated UC to Calendar</button>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <!-- Close button moved inside the content div -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <h2 class="heading-match-overview">Add New Transaction for <span id="addModalDate"></span></h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="addTransactionType" class="block text-sm mb-1">Type:</label>
                        <select id="addTransactionType" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="addTransactionName" class="block text-sm mb-1">Name/Source:</label>
                        <input type="text" id="addTransactionName" placeholder="e.g., Rent, Salary, Initial Funds" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="addTransactionAmount" class="block text-sm mb-1">Amount (£):</label>
                        <input type="number" id="addTransactionAmount" placeholder="e.g., 1200.00" step="0.01" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group" id="addTransactionRepeatGroup">
                        <label for="addTransactionRepeat" class="block text-sm mb-1">Repeat:</label>
                        <select id="addTransactionRepeat" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="none">None</option>
                            <option value="daily">Every Day</option>
                            <option value="weekly">Every Week</option>
                            <option value="bi-weekly">Every Two Weeks</option>
                            <option value="four-weekly">Every Four Weeks</option>
                            <option value="monthly">Monthly (same day)</option>
                        </select>
                    </div>
                    <!-- Adjusted: Removed 'input-group' class from this div -->
                    <div class="md:col-span-2 mb-4 hidden" id="addAdjustForNonWorkingDaysGroup">
                        <label for="addAdjustForNonWorkingDays" class="flex items-center text-sm mb-1">
                            <input type="checkbox" id="addAdjustForNonWorkingDays" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2">
                            Adjust for Weekends/Bank Holidays
                        </label>
                        <p class="text-xs text-gray-500 mt-1">If checked, future payments will shift to the next working day if they fall on a weekend or bank holiday.</p>
                    </div>
                    <!-- End Date for Recurring Transactions -->
                    <div class="input-group md:col-span-2 hidden" id="addEndDateGroup">
                        <label for="addTransactionEndDate" class="block text-sm mb-1">End Date (Optional):</label>
                        <input type="date" id="addTransactionEndDate" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <button id="addTransactionBtn" class="btn-primary w-full" touch-action="manipulation">Add Transaction</button>
                <button id="closeAddModalBtn" class="btn-secondary w-full mt-4">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <!-- Close button moved inside the content div -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <h2 class="heading-match-overview">Edit Transaction</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="editTransactionType" class="block text-sm mb-1">Type:</label>
                        <select id="editTransactionType" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="editTransactionName" class="block text-sm mb-1">Name/Source:</label>
                        <input type="text" id="editTransactionName" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="editTransactionAmount" class="block text-sm mb-1">Amount (£):</label>
                        <input type="number" id="editTransactionAmount" step="0.01" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group" id="editTransactionRepeatGroup">
                        <label for="editTransactionRepeat" class="block text-sm mb-1">Repeat:</label>
                        <select id="editTransactionRepeat" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="none">None</option>
                            <option value="daily">Every Day</option>
                            <option value="weekly">Every Week</option>
                            <option value="bi-weekly">Every Two Weeks</option>
                            <option value="four-weekly">Every Four Weeks</option>
                            <option value="monthly">Monthly (same day)</option>
                        </select>
                    </div>
                    <!-- Adjusted: Removed 'input-group' class from this div -->
                    <div class="md:col-span-2 mb-4 hidden" id="editAdjustForNonWorkingDaysGroup">
                        <label for="editAdjustForNonWorkingDays" class="flex items-center text-sm mb-1">
                            <input type="checkbox" id="editAdjustForNonWorkingDays" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 mr-2">
                            Adjust for Weekends/Bank Holidays
                        </label>
                        <p class="text-xs text-gray-500 mt-1">If checked, future payments will shift to the next working day if they fall on a weekend or bank holiday.</p>
                    </div>
                    <!-- End Date for Recurring Transactions -->
                    <div class="input-group md:col-span-2 hidden" id="editEndDateGroup">
                        <label for="editTransactionEndDate" class="block text-sm mb-1">End Date (Optional):</label>
                        <input type="date" id="editTransactionEndDate" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <button id="saveEditedTransactionBtn" class="btn-primary w-full" touch-action="manipulation">Save Changes</button>
                <button id="closeEditModalBtn" class="btn-secondary w-full mt-4">Close</button>
            </div>
        </div>
    </div>

    <!-- Update Balance Modal -->
    <div id="updateBalanceModal" class="modal">
        <div class="modal-content">
            <!-- Close button moved inside the content div -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <h2 class="heading-match-overview">Update Current Balance</h2>
                <div class="input-group mb-4">
                    <label for="newBalanceAmount" class="block text-sm mb-1">Your Current Bank Balance (£):</label>
                    <input type="number" id="newBalanceAmount" placeholder="e.g., 1500.00" step="0.01" class="focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button id="saveBalanceBtn" class="btn-primary w-full" touch-action="manipulation">Save Balance</button>
                <button id="closeUpdateBalanceModalBtn" class="btn-secondary w-full mt-4">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirm Pay Add Modal (New Modal) -->
    <div id="confirmPayAddModal" class="modal">
        <div class="modal-content">
            <!-- Close button moved inside the content div -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <h2 class="heading-match-overview">Add Estimated Pay to Calendar</h2>
                <p class="mb-4 text-lg">Estimated Net Pay: <span id="modalEstimatedNetPay" class="font-bold text-green-700">£0.00</span></p>
                <div class="input-group mb-4">
                    <label for="nextPayDateInput" class="block text-sm mb-1">Next Pay Day:</label>
                    <input type="date" id="nextPayDateInput" class="focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="input-group mb-4">
                    <label for="confirmPayFrequencySelect" class="block text-sm mb-1">Repeat Frequency:</label>
                    <select id="confirmPayFrequencySelect" class="focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="weekly">Weekly</option>
                        <option value="bi-weekly">Bi-weekly</option>
                        <option value="four-weekly">Four Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="annually">Annually</option>
                    </select>
                </div>
                <button id="confirmAddPayBtn" class="btn-primary w-full" touch-action="manipulation">Confirm Add to Calendar</button>
                <button id="closeConfirmPayAddModalBtn" class="btn-secondary w-full mt-4">Close</button>
            </div>
        </div>
    </div>

    <!-- Confirm UC Add Modal (New Modal) -->
    <div id="confirmUcAddModal" class="modal">
        <div class="modal-content">
            <!-- Close button moved inside the content div -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <h2 class="heading-match-overview">Add Estimated UC to Calendar</h2>
                <p class="mb-4 text-lg">Estimated Monthly UC: <span id="modalEstimatedUcPayment" class="font-bold text-green-700">£0.00</span></p>
                <div class="input-group mb-4">
                    <label for="nextUcPayDateInput" class="block text-sm mb-1">Next UC Payment Day:</label>
                    <input type="date" id="nextUcPayDateInput" class="focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="input-group mb-4">
                    <label for="confirmUcFrequencySelect" class="block text-sm mb-1">Repeat Frequency:</label>
                    <select id="confirmUcFrequencySelect" class="focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <button id="confirmAddUcBtn" class="btn-primary w-full" touch-action="manipulation">Confirm Add to Calendar</button>
                <button id="closeConfirmUcAddModalBtn" class="btn-secondary w-full mt-4">Close</button>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation Modal (New) -->
    <div id="mobileNavModal" class="modal">
        <div class="modal-content">
            <!-- This modal retains its specific close button at the bottom -->
            <div class="mobile-nav-buttons">
                <button class="mobile-nav-button" data-tab="getting-started">Getting Started</button>
                <button class="mobile-nav-button" data-tab="overview">Overview</button>
                <button class="mobile-nav-button" data-tab="calendar">Calendar</button>
                <button class="mobile-nav-button" data-tab="pay-estimator">Pay Estimator</button>
                <button class="mobile-nav-button" data-tab="universal-credit">UC Estimator</button>
                <!-- New Close button -->
                <button id="closeMobileNavBtnBottom" class="mobile-nav-button mt-4 bg-gray-800 hover:bg-gray-700">Close</button>
            </div>
        </div>
    </div>

    <!-- Amount Available Help Modal -->
    <div id="amountAvailableHelpModal" class="modal">
        <div class="modal-content">
            <!-- Close button moved inside the content div -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <h2 class="heading-match-overview">Understanding 'Amount Available'</h2>
                <p class="text-gray-700">This figure represents the lowest your projected balance will drop before your next expected income. It helps you understand how much you can comfortably spend without risking a negative balance before your next significant payment arrives.</p>
                <p class="text-gray-700 mt-4">The calculation considers your current balance and all your upcoming expenses and incomes up to the point of your next anticipated income transaction (up to 2 years in the future). If no future income is found, it will prompt you to add one.</p>
                <button id="closeAmountAvailableHelpModalBtn" class="btn-secondary w-full mt-4">Close</button>
            </div>
        </div>
    </div>

    <!-- New: Delete Confirmation Modal for Recurring Transactions -->
    <div id="deleteConfirmationModal" class="modal">
        <div class="modal-content">
            <!-- Close button moved inside the content div -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner text-center">
                <h2 class="heading-match-overview">Delete Recurring Transaction</h2>
                <p class="mb-6 text-lg">How would you like to delete this transaction?</p>
                <div class="flex flex-col gap-4">
                    <button id="deleteThisEventOnlyBtn" class="btn-primary">Delete This Event Only</button>
                    <!-- Updated class from btn-delete to btn-primary -->
                    <button id="deleteThisAndFutureEventsBtn" class="btn-primary">Delete This and All Future Events</button>
                </div>
                <button id="closeDeleteConfirmationModalBtn" class="btn-secondary w-full mt-4">Close</button>
            </div>
        </div>
    </div>

    <!-- New: Clear All Transactions Confirmation Modal -->
    <div id="clearTransactionsConfirmModal" class="modal">
        <div class="modal-content">
            <!-- Close button removed -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner text-center">
                <h2 class="heading-match-overview">Clear All Transactions</h2>
                <p class="mb-6 text-lg">Are you sure you want to delete ALL transactions and reset your balance? This action cannot be undone.</p>
                <div class="flex justify-center gap-4">
                    <button id="confirmClearTransactionsYesBtn" class="btn-delete">Yes, Clear All</button>
                    <button id="confirmClearTransactionsNoBtn" class="btn-secondary">No, Keep Them</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Box for notifications -->
    <div id="messageBox" class="message-box"></div>

    <script>
        console.log("Script execution started."); // Added for debugging
        // Function to show a temporary message box
        function showMessage(message, duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let balanceUpdates = JSON.parse(localStorage.getItem('balanceUpdates')) || []; // New storage for balance updates

        // UK Bank Holidays (YYYY-MM-DD format) - Will be fetched dynamically
        let bankHolidays = []; 

        // Fetch bank holidays from GOV.UK API
        async function fetchBankHolidays() {
            try {
                const response = await fetch('https://www.gov.uk/bank-holidays.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                // Extract dates for England and Wales
                bankHolidays = data['england-and-wales'].events.map(event => event.date);
                console.log('Bank holidays fetched:', bankHolidays);
                // Re-render calendar and overview after fetching holidays
                updateCalendarView();
                renderOverview();
            } catch (error) {
                console.error('Error fetching bank holidays:', error);
                showMessage('Failed to load bank holidays. Using pre-defined list if available.', 5000);
                // Fallback to a small pre-defined list if fetching fails, or keep it empty if no fallback
            }
        }


        const calendarDaysEl = document.getElementById('calendarDays');
        const calendarContentWrapper = document.getElementById('calendarContentWrapper'); // New wrapper for zoomable content
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const calendarGridHeaderRow = document.querySelector('.calendar-grid-header-row'); // Get the header row element

        // New Calendar View Variables
        let currentCalendarView = 'monthly'; // 'monthly' or 'daily'
        let currentDailyDate = new Date(); // Tracks the date for daily view

        // Tab Elements
        const desktopTabButtons = document.querySelectorAll('#desktopTabButtons .tab-button'); // Select desktop tab buttons
        const gettingStartedTabContent = document.getElementById('getting-startedTabContent'); // New tab content
        const calendarTabContent = document.getElementById('calendarTabContent');
        const overviewTabContent = document.getElementById('overviewTabContent');
        const payEstimatorTabContent = document.getElementById('pay-estimatorTabContent');
        const universalCreditTabContent = document.getElementById('universal-creditTabContent'); // New UC tab

        // Add Transaction Modal Elements
        const addTransactionModal = document.getElementById('addTransactionModal');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const addModalDateEl = document.getElementById('addModalDate');
        const addTransactionTypeInput = document.getElementById('addTransactionType');
        const addTransactionNameInput = document.getElementById('addTransactionName');
        const addTransactionAmountInput = document.getElementById('addTransactionAmount');
        const addTransactionRepeatInput = document.getElementById('addTransactionRepeat');
        const addTransactionRepeatGroup = document.getElementById('addTransactionRepeatGroup');
        // New: Adjust for Non-Working Days Checkbox elements
        const addAdjustForNonWorkingDaysGroup = document.getElementById('addAdjustForNonWorkingDaysGroup');
        const addAdjustForNonWorkingDaysCheckbox = document.getElementById('addAdjustForNonWorkingDays');
        const addEndDateGroup = document.getElementById('addEndDateGroup'); // New
        const addTransactionEndDateInput = document.getElementById('addTransactionEndDate'); // New
        const addTransactionBtn = document.getElementById('addTransactionBtn');

        // Edit Transaction Modal Elements
        const editTransactionModal = document.getElementById('editTransactionModal');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const editTransactionTypeInput = document.getElementById('editTransactionType');
        const editTransactionNameInput = document.getElementById('editTransactionName');
        const editTransactionAmountInput = document.getElementById('editTransactionAmount'); 
        const editTransactionRepeatInput = document.getElementById('editTransactionRepeat');
        const editTransactionRepeatGroup = document.getElementById('editTransactionRepeatGroup');
        // New: Adjust for Non-Working Days Checkbox elements for Edit Modal
        const editAdjustForNonWorkingDaysGroup = document.getElementById('editAdjustForNonWorkingDaysGroup');
        const editAdjustForNonWorkingDaysCheckbox = document.getElementById('editAdjustForNonWorkingDays');
        const editEndDateGroup = document.getElementById('editEndDateGroup'); // New
        const editTransactionEndDateInput = document.getElementById('editTransactionEndDate'); // New
        const saveEditedTransactionBtn = document.getElementById('saveEditedTransactionBtn');

        // Overview Elements
        // Changed IDs for new span elements
        const currentBalanceDisplay = document.getElementById('currentBalanceDisplay');
        const currentBalanceSign = document.getElementById('currentBalanceSign');

        const lowestBalanceDisplay = document.getElementById('lowestBalanceDisplay');
        const lowestBalanceSign = document.getElementById('lowestBalanceSign');

        const overviewNextIncomeStatementEl = document.getElementById('overviewNextIncomeStatement');
        const overviewTodaysTransactionsListEl = document.getElementById('overviewTodaysTransactionsList');
        const updateBalanceBtn = document.getElementById('updateBalanceBtn');
        // Chart elements
        const incomeExpensePieChartCanvas = document.getElementById('incomeExpensePieChart');
        const pieChartDescription = document.getElementById('pieChartDescription');
        let incomeExpensePieChartInstance = null; // To hold the Chart.js instance


        // Update Balance Modal Elements
        const updateBalanceModal = document.getElementById('updateBalanceModal');
        const closeUpdateBalanceModalBtn = document.getElementById('closeUpdateBalanceModalBtn');
        const newBalanceAmountInput = document.getElementById('newBalanceAmount');
        const saveBalanceBtn = document.getElementById('saveBalanceBtn');

        // Pay Estimator Elements
        const payRateAmountInput = document.getElementById('payRateAmount');
        const payRateUnitSelect = document.getElementById('payRateUnit');
        const contractedUnitsGroup = document.getElementById('contractedUnitsGroup');
        const contractedUnitsLabel = document.getElementById('contractedUnitsLabel');
        const contractedUnitsInput = document.getElementById('contractedUnits');
        const payFrequencySelect = document.getElementById('payFrequency'); 
        const calculatePayBtn = document.getElementById('calculatePayBtn');
        const payEstimatorResultsDiv = document.getElementById('payEstimatorResults');
        const grossPayResultSpan = document.getElementById('grossPayResult');
        const niDeductionResultSpan = document.getElementById('niDeductionResult');
        const taxDeductionResultSpan = document.getElementById('taxDeductionResult');
        const netPayResultSpan = document.getElementById('netPayResult');
        const addEstimatedPayToCalendarBtn = document.getElementById('addEstimatedPayToCalendarBtn');

        // Confirm Pay Add Modal Elements
        const confirmPayAddModal = document.getElementById('confirmPayAddModal');
        const closeConfirmPayAddModalBtn = document.getElementById('closeConfirmPayAddModalBtn');
        const modalEstimatedNetPaySpan = document.getElementById('modalEstimatedNetPay');
        const nextPayDateInput = document.getElementById('nextPayDateInput');
        const confirmPayFrequencySelect = document.getElementById('confirmPayFrequencySelect');
        const confirmAddPayBtn = document.getElementById('confirmAddPayBtn'); 

        // Universal Credit Elements (New)
        const ucClaimStatusRadios = document.querySelectorAll('input[name="ucClaimStatus"]');
        const ucAgeGroupSingleDiv = document.getElementById('ucAgeGroupSingle');
        const ucAgeGroupCoupleDiv = document.getElementById('ucAgeGroupCouple');
        const ucAgeRadios = document.querySelectorAll('input[name="ucAge"]'); // For single claim
        const ucAgeP1Radios = document.querySelectorAll('input[name="ucAgeP1"]');
        const ucAgeP2Radios = document.querySelectorAll('input[name="ucAgeP2"]'); // Fixed: Added missing " and )
        const ucNumChildrenInput = document.getElementById('ucNumChildren');
        const ucChildBornBefore2017Checkbox = document.getElementById('ucChildBornBefore2017');
        const ucDisabilityStatusSelect = document.getElementById('ucDisabilityStatus');
        const ucMonthlyRentInput = document.getElementById('ucMonthlyRent');
        const ucMonthlyEarningsInput = document.getElementById('ucMonthlyEarnings');
        const calculateUCBtn = document.getElementById('calculateUCBtn');
        const ucCalculatorResultsDiv = document.getElementById('ucCalculatorResults');
        const ucStandardAllowanceSpan = document.getElementById('ucStandardAllowance');
        const ucChildElementsSpan = document.getElementById('ucChildElements');
        const ucDisabilityElementSpan = document.getElementById('ucDisabilityElement');
        const ucHousingElementSpan = document.getElementById('ucHousingElement');
        const ucTotalElementsSpan = document.getElementById('ucTotalElements');
        const ucWorkAllowanceSpan = document.getElementById('ucWorkAllowance');
        const ucEarningsDeductionSpan = document.getElementById('ucEarningsDeduction');
        const ucNetPaymentSpan = document.getElementById('ucNetPayment');
        const addEstimatedUCtoCalendarBtn = document.getElementById('addEstimatedUCtoCalendarBtn');
        const importPayEstimatorEarningsBtn = document.getElementById('importPayEstimatorEarningsBtn'); // New import button

        // Confirm UC Add Modal Elements (New)
        const confirmUcAddModal = document.getElementById('confirmUcAddModal');
        const modalEstimatedUcPaymentSpan = document.getElementById('modalEstimatedUcPayment');
        const nextUcPayDateInput = document.getElementById('nextUcPayDateInput');
        const confirmUcFrequencySelect = document.getElementById('confirmUcFrequencySelect');
        const confirmAddUcBtn = document.getElementById('confirmAddUcBtn'); 
        const closeConfirmUcAddModalBtn = document.getElementById('closeConfirmUcAddModalBtn'); // Corrected: Ensure this is selected

        const calendarViewToggle = document.getElementById('calendarViewToggle'); // New toggle switch element
        const menuToggleBtn = document.getElementById('menuToggleBtn'); // New menu toggle button

        // Mobile Nav Modal Elements (New)
        const mobileNavModal = document.getElementById('mobileNavModal');
        const mobileNavButtons = document.querySelectorAll('#mobileNavModal .mobile-nav-button'); // Select buttons inside mobile nav modal
        const closeMobileNavBtnBottom = document.getElementById('closeMobileNavBtnBottom'); // New close button for mobile nav

        // Amount Available Help Modal Elements
        const amountAvailableHelpBtn = document.getElementById('amountAvailableHelpBtn');
        const amountAvailableHelpModal = document.getElementById('amountAvailableHelpModal');
        const closeAmountAvailableHelpModalBtn = document.getElementById('closeAmountAvailableHelpModalBtn');

        // New: Delete Confirmation Modal Elements
        const deleteConfirmationModal = document.getElementById('deleteConfirmationModal');
        const closeDeleteConfirmationModalBtn = document.getElementById('closeDeleteConfirmationModalBtn');
        const deleteThisEventOnlyBtn = document.getElementById('deleteThisEventOnlyBtn');
        const deleteThisAndFutureEventsBtn = document.getElementById('deleteThisAndFutureEventsBtn');

        // New: Clear All Transactions Confirmation Modal
        const clearTransactionsConfirmModal = document.getElementById('clearTransactionsConfirmModal');
        // Removed closeClearTransactionsConfirmModalBtn as per user request
        const confirmClearTransactionsYesBtn = document.getElementById('confirmClearTransactionsYesBtn');
        const confirmClearTransactionsNoBtn = document.getElementById('confirmClearTransactionsNoBtn');


        let selectedDate = null; // Date of the day clicked on the calendar
        let editingTransactionId = null; // ID of the transaction being edited
        let editingTransactionInstanceDate = null; // The specific date of the instance being edited
        let transactionToDeleteId = null; // ID of the transaction to delete (for recurring modal)
        let transactionToDeleteInstanceDate = null; // Instance date of the transaction to delete (for recurring modal)


        let estimatedNetPayValue = 0; // To store net pay from estimator
        let estimatedPayFrequencyValue = 'weekly'; // To store frequency from estimator
        let estimatedUcPaymentValue = 0; // To store UC payment from estimator

        // Global references for current and adjacent day elements in daily view
        let currentDailyContentEl = null;
        let adjacentDailyContentEl = null;
        
        // Scrollbar width calculation for modal fix
        let scrollbarWidth = 0;
        function getScrollbarWidth() {
            const outer = document.createElement('div');
            outer.style.visibility = 'hidden';
            outer.style.overflow = 'scroll';
            outer.style.msOverflowStyle = 'scrollbar';
            document.body.appendChild(outer);
            const inner = document.createElement('div');
            outer.appendChild(inner);
            const width = outer.offsetWidth - inner.offsetWidth;
            outer.parentNode.removeChild(outer);
            return width;
        }

        // Generic modal open/close functions to handle scrollbar shift
        function openModal(modalElement) {
            if (scrollbarWidth === 0) {
                scrollbarWidth = getScrollbarWidth();
            }
            document.body.style.paddingRight = `${scrollbarWidth}px`;
            document.body.classList.add('modal-open');
            modalElement.classList.add('show');
        }

        function closeModal(modalElement) {
            modalElement.classList.remove('show');
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = ''; // Reset padding
        }


        // --- Date Utility Functions ---
        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getFirstDayOfMonth(year, month) {
            return new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday, etc.
        }

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        // Checks if a given date is a weekend (Sat/Sun) or a bank holiday
        function isNonWorkingDay(date) {
            const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
            if (dayOfWeek === 0 || dayOfWeek === 6) { // Weekend
                return true;
            }
            const formattedDate = formatDate(date);
            if (bankHolidays.includes(formattedDate)) { // Bank Holiday
                return true;
            }
            return false;
        }

        // Finds the next available working day, including the current date if it's a working day
        function getNextWorkingDay(date) {
            let currentCheckDate = new Date(date);
            currentCheckDate.setHours(0, 0, 0, 0); // Normalize to start of day

            while (isNonWorkingDay(currentCheckDate)) {
                currentCheckDate.setDate(currentCheckDate.getDate() + 1);
            }
            return currentCheckDate;
        }

        /**
         * Calculates the next occurrence date for a recurring transaction after a given start date.
         * @param {Date} startDate - The date from which to calculate the next occurrence.
         * @param {string} repeatFrequency - The repeat frequency ('daily', 'weekly', 'bi-weekly', 'four-weekly', 'monthly').
         * @returns {Date|null} The date of the next occurrence, or null if invalid frequency.
         */
        function getNextOccurrence(startDate, repeatFrequency) {
            let nextDate = new Date(startDate);
            nextDate.setHours(0, 0, 0, 0); // Normalize

            switch (repeatFrequency) {
                case 'daily':
                    nextDate.setDate(nextDate.getDate() + 1);
                    break;
                case 'weekly':
                    nextDate.setDate(nextDate.getDate() + 7);
                    break;
                case 'bi-weekly':
                    nextDate.setDate(nextDate.getDate() + 14);
                    break;
                case 'four-weekly':
                    nextDate.setDate(nextDate.getDate() + 28);
                    break;
                case 'monthly':
                    const originalDay = nextDate.getDate();
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    // If the original day doesn't exist in the next month (e.g., Jan 31 -> Feb),
                    // set it to the last day of the next month.
                    if (nextDate.getDate() !== originalDay) {
                        nextDate = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0); // Last day of current month
                    }
                    break;
                default:
                    return null; // No repeat or invalid frequency
            }
            return nextDate;
        }

        /**
         * Determines the effective date for a nominal transaction occurrence.
         * This function implements the rule: first instance respects user's assignment,
         * only future recurring occurrences shift if they fall on non-working days and adjustment is enabled.
         * @param {Object} transaction - The transaction object.
         * @param {Date} nominalDate - The date the transaction would nominally fall on.
         * @returns {Date} The actual effective date for this occurrence.
         */
        function getEffectiveDateForNominalDate(transaction, nominalDate) {
            const t = transaction;
            const nominal = new Date(nominalDate);
            nominal.setHours(0,0,0,0);

            const transactionStartDate = parseDate(t.date);
            transactionStartDate.setHours(0,0,0,0);

            // If the nominal date is the *exact* transaction start date, it always respects the user's assignment.
            // This applies even if adjustForNonWorkingDays is true and it's a non-working day.
            if (formatDate(nominal) === formatDate(transactionStartDate)) {
                return nominal;
            }

            // For all *subsequent* occurrences of a recurring transaction:
            // If adjustment is on AND it's a non-working day, shift it.
            if (t.adjustForNonWorkingDays && isNonWorkingDay(nominal)) {
                return getNextWorkingDay(nominal);
            }

            // Otherwise (adjustment is off, or it's a working day, or it's a non-recurring transaction),
            // the effective date is the nominal date.
            return nominal;
        }

        /**
         * Returns an array of transactions effective on a specific date,
         * including adjusted transactions with modified names for clarity.
         * @param {string} dateString - The date in YYYY-MM-DD format.
         * @returns {Array} List of transactions effective on that date.
         */
        function getTransactionsEffectiveOnDateList(dateString) {
            const selectedDayDate = parseDate(dateString);
            selectedDayDate.setHours(0, 0, 0, 0);

            // console.log(`--- getTransactionsEffectiveOnDateList called for: ${dateString} ---`);

            const effectiveTransactions = [];

            const validRepeatFrequencies = ['none', 'daily', 'weekly', 'bi-weekly', 'four-weekly', 'monthly'];

            transactions.forEach(t => {
                // console.log(`Processing transaction: ID=${t.id}, Name="${t.name}", Repeat="${t.repeat}", StartDate="${t.date}", AdjustNonWorkingDays=${t.adjustForNonWorkingDays}, EndDate=${t.endDate}`);

                if (!validRepeatFrequencies.includes(t.repeat)) {
                    console.warn(`Invalid repeat frequency "${t.repeat}" found for transaction ID: ${t.id}, Name: ${t.name}. Defaulting to 'none'.`);
                    t.repeat = 'none';
                }

                const transactionStartDate = parseDate(t.date);
                transactionStartDate.setHours(0,0,0,0);

                // Define a window around the selectedDayDate to check for nominal occurrences
                // that might shift *to* selectedDayDate.
                // We need to check nominal dates up to 10 days prior and 10 days after,
                // to account for potential shifts (e.g., Sat/Sun -> Mon, or multiple bank holidays).
                const windowStart = new Date(selectedDayDate);
                windowStart.setDate(windowStart.getDate() - 10);
                windowStart.setHours(0,0,0,0);

                const windowEnd = new Date(selectedDayDate);
                windowEnd.setDate(windowEnd.getDate() + 10);
                windowEnd.setHours(0,0,0,0);


                if (t.repeat === 'none') {
                    const effectiveDate = getEffectiveDateForNominalDate(t, transactionStartDate);
                    // console.log(`  Non-repeating: NominalDate=${formatDate(transactionStartDate)}, EffectiveDate=${formatDate(effectiveDate)}`);
                    if (formatDate(effectiveDate) === formatDate(selectedDayDate)) {
                        const transactionCopy = { ...t };
                        if (formatDate(effectiveDate) !== formatDate(transactionStartDate)) {
                            transactionCopy.name = `${t.name} (from ${transactionStartDate.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' })}`;
                        }
                        effectiveTransactions.push(transactionCopy);
                        // console.log(`  Added non-repeating transaction (ID: ${t.id}) to effective list for ${dateString}.`);
                    }
                } else {
                    // For repeating transactions, generate occurrences from the start date
                    let currentNominalOccurrence = new Date(transactionStartDate);
                    currentNominalOccurrence.setHours(0,0,0,0);

                    // Advance currentNominalOccurrence until it's at or before the windowStart,
                    // ensuring we don't miss any occurrences that might shift into our window.
                    // This loop finds the *first* nominal occurrence that could potentially be relevant.
                    while (currentNominalOccurrence.getTime() < windowStart.getTime()) {
                        const next = getNextOccurrence(currentNominalOccurrence, t.repeat);
                        // If no next occurrence or it's past the transaction's end date, break
                        if (!next || (t.endDate && next.getTime() > parseDate(t.endDate).getTime())) {
                            currentNominalOccurrence = null;
                            break;
                        }
                        currentNominalOccurrence = next;
                    }

                    if (currentNominalOccurrence) { // If we found a starting point within or before the window
                        // Now iterate through nominal occurrences within and slightly beyond the window
                        while (currentNominalOccurrence.getTime() <= windowEnd.getTime()) {
                            // Stop if we've gone past the transaction's end date (if any)
                            if (t.endDate && currentNominalOccurrence.getTime() > parseDate(t.endDate).getTime()) {
                                // console.log(`  NominalDate ${formatDate(currentNominalOccurrence)} is past transaction endDate ${t.endDate}. Breaking loop.`);
                                break;
                            }

                            const effectiveDate = getEffectiveDateForNominalDate(t, currentNominalOccurrence);
                            // console.log(`  Repeating: NominalDate=${formatDate(currentNominalOccurrence)}, EffectiveDate=${formatDate(effectiveDate)}`);

                            // If this effective date matches our target selectedDayDate
                            if (formatDate(effectiveDate) === formatDate(selectedDayDate)) {
                                const transactionCopy = { ...t };
                                if (formatDate(effectiveDate) !== formatDate(currentNominalOccurrence)) {
                                    transactionCopy.name = `${t.name} (from ${currentNominalOccurrence.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' })}`;
                                }
                                effectiveTransactions.push(transactionCopy);
                                // console.log(`  Added repeating transaction (ID: ${t.id}) to effective list for ${dateString}.`);
                            }

                            // Move to the next nominal occurrence in the series
                            const next = getNextOccurrence(currentNominalOccurrence, t.repeat);
                            if (!next) {
                                // console.log(`  getNextOccurrence returned null for ${formatDate(currentNominalOccurrence)} with repeat "${t.repeat}". Breaking loop.`);
                                break;
                            }
                            currentNominalOccurrence = next;
                        }
                    }
                }
            });
            // console.log(`--- Finished processing for: ${dateString}. Found ${effectiveTransactions.length} effective transactions. ---`);
            return effectiveTransactions.sort((a, b) => a.name.localeCompare(b.name));
        }

        /**
         * Calculates the cumulative balance up to a specific target date (inclusive).
         * This function now incorporates manual balance updates and correct transaction adjustment logic.
         * Returns the final balance.
         */
        function calculateBalanceUpToDate(targetDate) {
            // Use the in-memory 'transactions' and 'balanceUpdates' arrays directly
            targetDate.setHours(0, 0, 0, 0); // Normalize target date

            let cumulativeBalance = 0;
            let effectiveCalculationStartDate = null;
            let balanceUpdateOnTargetDate = false;

            // 1. Find the most recent balance update on or before the targetDate
            const relevantBalanceUpdate = balanceUpdates // Use global 'balanceUpdates' array
                .filter(update => parseDate(update.date).getTime() <= targetDate.getTime())
                .sort((a, b) => parseDate(b.date).getTime() - parseDate(a.date).getTime())[0];

            if (relevantBalanceUpdate) {
                cumulativeBalance = relevantBalanceUpdate.amount;
                effectiveCalculationStartDate = parseDate(relevantBalanceUpdate.date);
                effectiveCalculationStartDate.setHours(0,0,0,0);

                if (effectiveCalculationStartDate.getTime() === targetDate.getTime()) {
                    balanceUpdateOnTargetDate = true; // The balance for targetDate is explicitly set
                }
            } else {
                // No balance update found on or before targetDate.
                // Start from the earliest transaction date, or today if no transactions.
                // If there are no transactions at all, the effective calculation start date is today.
                if (transactions.length > 0) { // Use global 'transactions' array
                    effectiveCalculationStartDate = transactions.reduce((minDate, t) => {
                        const txDate = parseDate(t.date);
                        return txDate < minDate ? txDate : minDate;
                    }, parseDate(transactions[0].date)); // Initialize with first transaction date
                    effectiveCalculationStartDate.setHours(0,0,0,0);
                } else {
                    // No balance updates and no transactions. Balance is 0.
                    return 0;
                }
            }

            // If the effective start date is after the target date, return the initial balance.
            // This handles cases where the only balance update is after the target date.
            if (effectiveCalculationStartDate.getTime() > targetDate.getTime()) {
                return cumulativeBalance;
            }

            // If there was a balance update *on* the target date, we don't need to iterate and add transactions for that day.
            // The `cumulativeBalance` is already the final balance for that day.
            if (balanceUpdateOnTargetDate) {
                return cumulativeBalance;
            }

            let currentDateIterator = new Date(effectiveCalculationStartDate);
            // If the balance update was *before* the target date, we need to start iterating from the day *after* the balance update.
            if (relevantBalanceUpdate && effectiveCalculationStartDate.getTime() < targetDate.getTime()) {
                currentDateIterator.setDate(currentDateIterator.getDate() + 1);
            }


            while (currentDateIterator.getTime() <= targetDate.getTime()) {
                let dailyNet = 0;
                const currentDayDate = new Date(currentDateIterator); // Create a new Date object for current day
                // CORRECTED: Call getTransactionsEffectiveOnDateList once for the day
                const transactionsForCurrentDay = getTransactionsEffectiveOnDateList(formatDate(currentDayDate));
                
                transactionsForCurrentDay.forEach(t => {
                    dailyNet += (t.type === 'income' ? t.amount : -t.amount);
                });

                cumulativeBalance += dailyNet; // Apply daily net for all days in the iteration range
                currentDateIterator.setDate(currentDateIterator.getDate() + 1);
            }
            return cumulativeBalance;
        }


        // --- Calendar Rendering ---
        function renderCalendar() {
            // Ensure calendarDaysEl is ready for monthly view
            calendarDaysEl.innerHTML = ''; // Clear existing content
            calendarContentWrapper.classList.remove('calendar-daily-view-container');
            calendarGridHeaderRow.style.display = 'grid';
            calendarDaysEl.classList.remove('daily-view-active');
            // Ensure calendarDaysEl has the grid class itself if it somehow lost it, though CSS should handle this
            calendarDaysEl.classList.add('calendar-grid-days'); // Make sure this class is always on the main container for monthly view
            calendarDaysEl.style.transform = 'translateX(0)'; // Reset transform for monthly view container
            calendarDaysEl.style.transition = 'none'; // Disable transition before new content is rendered

            currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const firstDayIndex = getFirstDayOfMonth(currentYear, currentMonth); // 0 for Sunday, 1 for Monday, etc.

            // Add blank days for the start of the month
            for (let i = 0; i < firstDayIndex; i++) {
                const blankDay = document.createElement('div');
                blankDay.className = 'calendar-day inactive';
                calendarDaysEl.appendChild(blankDay);
            }

            const today = new Date();
            const todayFormatted = formatDate(today);

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const formattedDate = formatDate(date);

                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.dataset.date = formattedDate;

                if (formattedDate === todayFormatted) {
                    dayEl.classList.add('today');
                }
                
                // Add styling for non-working days
                if (isNonWorkingDay(date)) {
                    dayEl.classList.add('bg-gray-200', 'text-gray-500'); // Example styling
                }

                // Only render cumulative balance in monthly view
                dayEl.innerHTML = `<div class="calendar-day-number">${day}</div><div class="calendar-day-cumulative"></div>`;

                const cumulativeEl = dayEl.querySelector('.calendar-day-cumulative');

                // Get the balance for this specific day using the new calculation logic
                const balanceForThisDay = calculateBalanceUpToDate(date);
                
                // Format cumulative balance: abbreviate if >= 1000, rounding down to 1 decimal place
                let formattedCumulativeBalance;
                if (Math.abs(balanceForThisDay) >= 1000) {
                    // Round down to nearest 1 decimal place for thousands
                    formattedCumulativeBalance = `£${(Math.floor(balanceForThisDay / 100) / 10).toFixed(1)}k`;
                } else {
                    // Round down to the nearest whole pound for display
                    formattedCumulativeBalance = `£${Math.floor(balanceForThisDay).toFixed(0)}`;
                }
                
                cumulativeEl.textContent = formattedCumulativeBalance;
                if (balanceForThisDay >= 0) { /* Use original balance for color logic */
                    cumulativeEl.classList.add('positive');
                    cumulativeEl.classList.remove('negative');
                } else {
                    cumulativeEl.classList.add('negative');
                    cumulativeEl.classList.remove('positive');
                }

                // Changed: Clicking a day in monthly view now opens daily view
                dayEl.addEventListener('click', () => {
                    currentCalendarView = 'daily';
                    currentDailyDate = date; // Set the clicked date as the current daily date
                    calendarViewToggle.checked = true; // Update the toggle switch
                    updateCalendarView(); // Re-render in daily view
                });
                calendarDaysEl.appendChild(dayEl);
            }
        }

        // Function to render the daily view content into a container
        function renderDailyViewContent(date, parentElement, initialTransform = 'translateX(0)') {
            const formattedDate = formatDate(date);
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day today'; // Always highlight current day in daily view
            dayEl.dataset.date = formattedDate;

            // Display full date in the day number area, now including weekday
            dayEl.innerHTML = `
                <div class="calendar-day-number">${date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
                <div class="calendar-day-transactions"></div>
                <div class="calendar-day-cumulative"></div>
                <button class="btn-primary">Add New Transaction</button> <!-- Changed class to btn-primary -->
            `;

            const transactionsForDayEl = dayEl.querySelector('.calendar-day-transactions');
            const cumulativeEl = dayEl.querySelector('.calendar-day-cumulative');
            const addTransactionDailyBtn = dayEl.querySelector('.btn-primary'); // Select by new class

            const balanceForThisDay = calculateBalanceUpToDate(date);
            // Round down to the nearest whole pound for display in daily view
            const roundedBalanceForDisplay = Math.floor(balanceForThisDay);

            const transactionsOnThisDayForDisplay = getTransactionsEffectiveOnDateList(formattedDate);

            if (transactionsOnThisDayForDisplay.length > 0) {
                transactionsForDayEl.innerHTML = ''; // Clear "No entries"
                transactionsOnThisDayForDisplay.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'modal-transaction-item flex justify-between items-center py-1';
                    const repeatText = t.repeat !== 'none' ? ` (Repeats ${t.repeat})` : '';
                    const displayType = t.type === 'income' ? '+' : '-' ;
                    const displayAmount = `${displayType}£${t.amount.toFixed(2)}`;
                    // Removed adjustText from display as it's now handled by the (from X) name modification
                    // const adjustText = t.repeat !== 'none' ? (t.adjustForNonWorkingDays ? ' (Adjusts for non-working days)' : ' (Unaffected by non-working days)') : '';


                    div.innerHTML = `
                        <div>
                            <p class="font-semibold text-sm">${t.name}</p>
                            <p class="text-xs text-gray-600">${displayAmount}${repeatText}</p>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="btn-edit" data-id="${t.id}" data-instance-date="${formattedDate}">Edit</button>
                            <button class="btn-delete" data-id="${t.id}" data-instance-date="${formattedDate}">Delete</button>
                        </div>
                    `;
                    div.querySelector('.btn-edit').addEventListener('click', (e) => {
                        openEditTransactionModal(parseInt(e.target.dataset.id), e.target.dataset.instanceDate);
                    });
                    div.querySelector('.btn-delete').addEventListener('click', (e) => {
                        const transactionIdToDelete = parseInt(e.target.dataset.id);
                        const transactionInstanceDate = e.target.dataset.instanceDate;
                        const originalTx = transactions.find(tx => tx.id === transactionIdToDelete);

                        if (originalTx && originalTx.repeat !== 'none') {
                            // If it's a recurring transaction, open the confirmation modal
                            transactionToDeleteId = transactionIdToDelete;
                            transactionToDeleteInstanceDate = transactionInstanceDate;
                            openModal(deleteConfirmationModal);
                        } else {
                            // If it's a non-recurring transaction, delete directly
                            transactions = transactions.filter(tx => tx.id !== transactionIdToDelete);
                            localStorage.setItem('transactions', JSON.stringify(transactions));
                            showMessage('Transaction deleted!');
                            updateCalendarView(); // Re-render daily view after deletion
                            renderOverview(); // Re-render overview
                        }
                    });
                    transactionsForDayEl.appendChild(div);
                });
            } else {
                transactionsForDayEl.innerHTML = '<p class="text-gray-400 text-left py-4">No entries</p>'; // Changed to text-left
            }

            cumulativeEl.textContent = `£${roundedBalanceForDisplay.toFixed(0)}`;
            if (roundedBalanceForDisplay >= 0) {
                cumulativeEl.classList.add('positive');
                cumulativeEl.classList.remove('negative');
            } else {
                cumulativeEl.classList.add('negative');
                cumulativeEl.classList.remove('positive');
            }

            addTransactionDailyBtn.addEventListener('click', () => openAddTransactionModal(formattedDate));

            const dailyViewContentWrapper = document.createElement('div');
            dailyViewContentWrapper.className = 'daily-view-content';
            dailyViewContentWrapper.style.transform = initialTransform;
            dailyViewContentWrapper.appendChild(dayEl);
            parentElement.appendChild(dailyViewContentWrapper);

            return dailyViewContentWrapper; // Return the new wrapper element
        }

        function updateCalendarView() {
            if (currentCalendarView === 'monthly') {
                // Clean up daily view elements if switching from daily
                if (currentDailyContentEl && currentDailyContentEl.parentNode) {
                    currentDailyContentEl.parentNode.removeChild(currentDailyContentEl);
                    currentDailyContentEl = null;
                }
                if (adjacentDailyContentEl && adjacentDailyContentEl.parentNode) {
                    adjacentDailyContentEl.parentNode.removeChild(adjacentDailyContentEl);
                    adjacentDailyContentEl = null;
                }
                
                // Clear calendarDaysEl before rendering new month content
                calendarDaysEl.innerHTML = ''; 
                calendarContentWrapper.classList.remove('calendar-daily-view-container');
                calendarGridHeaderRow.style.display = 'grid';
                calendarDaysEl.classList.remove('daily-view-active');
                // Ensure calendarDaysEl has the grid class itself if it somehow lost it, though CSS should handle this
                calendarDaysEl.classList.add('calendar-grid-days'); // Make sure this class is always on the main container for monthly view
                calendarDaysEl.style.transform = 'translateX(0)'; // Reset transform for monthly view container
                calendarDaysEl.style.transition = 'none'; // Disable transition before new content is rendered

                currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });

                const daysInMonth = getDaysInMonth(currentYear, currentMonth);
                const firstDayIndex = getFirstDayOfMonth(currentYear, currentMonth); // 0 for Sunday, 1 for Monday, etc.

                // Add blank days for the start of the month
                for (let i = 0; i < firstDayIndex; i++) {
                    const blankDay = document.createElement('div');
                    blankDay.className = 'calendar-day inactive';
                    calendarDaysEl.appendChild(blankDay);
                }

                const today = new Date();
                const todayFormatted = formatDate(today);

                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const formattedDate = formatDate(date);

                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.dataset.date = formattedDate;

                    if (formattedDate === todayFormatted) {
                        dayEl.classList.add('today');
                    }
                    
                    // Add styling for non-working days
                    if (isNonWorkingDay(date)) {
                        dayEl.classList.add('bg-gray-200', 'text-gray-500'); // Example styling
                    }

                    // Only render cumulative balance in monthly view
                    dayEl.innerHTML = `<div class="calendar-day-number">${day}</div><div class="calendar-day-cumulative"></div>`;

                    const cumulativeEl = dayEl.querySelector('.calendar-day-cumulative');

                    // Get the balance for this specific day using the new calculation logic
                    const balanceForThisDay = calculateBalanceUpToDate(date);
                    
                    // Format cumulative balance: abbreviate if >= 1000, rounding down to 1 decimal place
                    let formattedCumulativeBalance;
                    if (Math.abs(balanceForThisDay) >= 1000) {
                        // Round down to nearest 1 decimal place for thousands
                        formattedCumulativeBalance = `£${(Math.floor(balanceForThisDay / 100) / 10).toFixed(1)}k`;
                    } else {
                        // Round down to the nearest whole pound for display
                        formattedCumulativeBalance = `£${Math.floor(balanceForThisDay).toFixed(0)}`;
                    }
                    
                    cumulativeEl.textContent = formattedCumulativeBalance;
                    if (balanceForThisDay >= 0) { /* Use original balance for color logic */
                        cumulativeEl.classList.add('positive');
                        cumulativeEl.classList.remove('negative');
                    } else {
                        cumulativeEl.classList.add('negative');
                        cumulativeEl.classList.remove('positive');
                    }

                    // Changed: Clicking a day in monthly view now opens daily view
                    dayEl.addEventListener('click', () => {
                        currentCalendarView = 'daily';
                        currentDailyDate = date; // Set the clicked date as the current daily date
                        calendarViewToggle.checked = true; // Update the toggle switch
                        updateCalendarView(); // Re-render in daily view
                    });
                    calendarDaysEl.appendChild(dayEl);
                }
            } else { // daily view
                // Ensure calendarDaysEl is set up for daily view
                calendarDaysEl.innerHTML = ''; // Clear any existing content
                calendarContentWrapper.classList.add('calendar-daily-view-container');
                calendarGridHeaderRow.style.display = 'none';
                calendarDaysEl.classList.add('daily-view-active'); // Add new class for styling
                
                // Render the current day
                currentDailyContentEl = renderDailyViewContent(currentDailyDate, calendarDaysEl);

                // Update header to only show month and year
                currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });
            }
        }

        calendarViewToggle.addEventListener('change', () => {
            currentCalendarView = calendarViewToggle.checked ? 'daily' : 'monthly';
            if (currentCalendarView === 'daily') {
                // When switching to daily view, set the currentDailyDate to the first day of the current month,
                // or today's date if today is within the current month.
                const today = new Date();
                if (today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                    currentDailyDate = new Date(currentYear, currentMonth, today.getDate());
                } else {
                    currentDailyDate = new Date(currentYear, currentMonth, 1);
                }
            }
            updateCalendarView();
        });

        // Event handlers for navigation buttons
        prevMonthBtn.addEventListener('click', () => {
            if (currentCalendarView === 'monthly') {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateCalendarView();
            } else { // daily view
                // Simulate a swipe to the right for "Prev Day"
                if (currentDailyContentEl) currentDailyContentEl.style.transition = 'transform 0.2s ease-out';
                if (adjacentDailyContentEl) adjacentDailyContentEl.style.transition = 'transform 0.2s ease-out';

                const prevDay = new Date(currentDailyDate);
                prevDay.setDate(prevDay.getDate() - 1);
                
                // If there's an existing adjacent element, remove it
                if (adjacentDailyContentEl && adjacentDailyContentEl.parentNode) {
                    adjacentDailyContentEl.parentNode.removeChild(adjacentDailyContentEl);
                    adjacentDailyContentEl = null;
                }
                adjacentDailyContentEl = renderDailyViewContent(prevDay, calendarDaysEl, 'translateX(-100%)'); // Render new day off-screen left

                if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(100%)'; // Slide current day out right
                if (adjacentDailyContentEl) adjacentDailyContentEl.style.transform = 'translateX(0)'; // Slide new day in

                // Update date after animation starts
                currentDailyDate.setDate(currentDailyDate.getDate() - 1);
                currentMonth = currentDailyDate.getMonth();
                currentYear = currentDailyDate.getFullYear();
                // Always update header to only show month and year
                currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });
                // Clean up old element after transition
                if (currentDailyContentEl) {
                    currentDailyContentEl.addEventListener('transitionend', function handler() {
                        currentDailyContentEl.removeEventListener('transitionend', handler);
                        if (currentDailyContentEl.parentNode) {
                            currentDailyContentEl.parentNode.removeChild(currentDailyContentEl);
                        }
                        // The adjacentDailyContentEl becomes the new current
                        currentDailyContentEl = adjacentDailyContentEl;
                        adjacentDailyContentEl = null; // Clear adjacent
                    }, { once: true }); // Use once: true to ensure listener is removed
                }
            }
        });

        nextMonthBtn.addEventListener('click', () => {
            if (currentCalendarView === 'monthly') {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                updateCalendarView();
            } else { // daily view
                // Simulate a swipe to the left for "Next Day"
                if (currentDailyContentEl) currentDailyContentEl.style.transition = 'transform 0.2s ease-out';
                if (adjacentDailyContentEl) adjacentDailyContentEl.style.transition = 'transform 0.2s ease-out';

                const nextDay = new Date(currentDailyDate);
                nextDay.setDate(nextDay.getDate() + 1);

                // If there's an existing adjacent element, remove it
                if (adjacentDailyContentEl && adjacentDailyContentEl.parentNode) {
                    adjacentDailyContentEl.parentNode.removeChild(adjacentDailyContentEl);
                    adjacentDailyContentEl = null;
                }
                adjacentDailyContentEl = renderDailyViewContent(nextDay, calendarDaysEl, 'translateX(100%)'); // Render new day off-screen right

                if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(-100%)'; // Slide current day out left
                if (adjacentDailyContentEl) adjacentDailyContentEl.style.transform = 'translateX(0)'; // Slide new day in

                // Update date after animation starts
                currentDailyDate.setDate(currentDailyDate.getDate() + 1);
                currentMonth = currentDailyDate.getMonth();
                currentYear = currentDailyDate.getFullYear();
                // Always update header to only show month and year
                currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });

                // Clean up old element after transition
                if (currentDailyContentEl) {
                    currentDailyContentEl.addEventListener('transitionend', function handler() {
                        currentDailyContentEl.removeEventListener('transitionend', handler);
                        if (currentDailyContentEl.parentNode) {
                            currentDailyContentEl.parentNode.removeChild(currentDailyContentEl);
                        }
                        // The adjacentDailyContentEl becomes the new current
                        currentDailyContentEl = adjacentDailyContentEl;
                        adjacentDailyContentEl = null; // Clear adjacent
                    }, { once: true }); // Use once: true to ensure listener is removed
                }
            }
        });

        // Mobile swipe/scroll gesture handling
        function isMobileView() {
            return window.innerWidth < 768; // Tailwind's 'md' breakpoint
        }

        let touchStartX = 0;
        let touchStartY = 0;
        let touchCurrentX = 0;
        let touchCurrentY = 0;
        let isGestureActive = false;
        let gestureType = 'none'; // 'none', 'swipe', 'scroll'
        const gestureThreshold = 10; // Minimum pixels to move to detect a gesture

        calendarContentWrapper.addEventListener('touchstart', (e) => {
            if (isMobileView()) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY; // Store initial Y
                touchCurrentX = touchStartX;
                touchCurrentY = touchStartY;
                isGestureActive = true;
                gestureType = 'none'; // Reset gesture type
                
                // Disable transitions at the start of any touch to allow direct manipulation
                if (currentCalendarView === 'daily') {
                    if (currentDailyContentEl) currentDailyContentEl.style.transition = 'none';
                    if (adjacentDailyContentEl) adjacentDailyContentEl.style.transition = 'none'; // Ensure adjacent is also non-transitioning
                } else if (currentCalendarView === 'monthly') {
                    if (calendarDaysEl) calendarDaysEl.style.transition = 'none';
                }
            }
        }, { passive: false }); // passive: false is crucial for preventDefault

        calendarContentWrapper.addEventListener('touchmove', (e) => {
            if (isMobileView() && isGestureActive) {
                touchCurrentX = e.touches[0].clientX;
                touchCurrentY = e.touches[0].clientY;
                const deltaX = touchCurrentX - touchStartX;
                const deltaY = touchCurrentY - touchStartY;

                if (gestureType === 'none') {
                    // Determine gesture type after minimum movement
                    if (Math.abs(deltaX) > gestureThreshold || Math.abs(deltaY) > gestureThreshold) {
                        if (Math.abs(deltaX) > Math.abs(deltaY)) {
                            gestureType = 'swipe';
                            e.preventDefault(); // Prevent vertical scroll if it's a horizontal swipe
                        } else {
                            gestureType = 'scroll';
                            // Do NOT preventDefault, allow native scrolling
                        }
                    }
                }

                if (gestureType === 'swipe') {
                    e.preventDefault(); // Ensure default is prevented for horizontal swipes

                    if (currentCalendarView === 'daily') {
                        if (currentDailyContentEl) {
                            currentDailyContentEl.style.transform = `translateX(${deltaX}px)`;
                        }

                        // Pre-render adjacent day if not already rendered
                        if (!adjacentDailyContentEl) {
                            const adjacentDate = new Date(currentDailyDate);
                            if (deltaX < 0) { // Swiping left, so next day
                                adjacentDate.setDate(adjacentDate.getDate() + 1);
                                adjacentDailyContentEl = renderDailyViewContent(adjacentDate, calendarDaysEl, `translateX(${window.innerWidth}px)`);
                            } else { // Swiping right, so previous day
                                adjacentDate.setDate(adjacentDate.getDate() - 1);
                                adjacentDailyContentEl = renderDailyViewContent(adjacentDate, calendarDaysEl, `translateX(-${window.innerWidth}px)`);
                            }
                            if (adjacentDailyContentEl) {
                                adjacentDailyContentEl.style.transition = 'none'; // Disable transition for the new element
                            }
                        }

                        if (adjacentDailyContentEl) {
                            const initialAdjacentOffset = (deltaX < 0) ? window.innerWidth : -window.innerWidth;
                            adjacentDailyContentEl.style.transform = `translateX(${deltaX + initialAdjacentOffset}px)`;
                        }
                    } else if (currentCalendarView === 'monthly') {
                        // Monthly view swipe logic: apply transform directly to calendarDaysEl
                        if (calendarDaysEl) {
                            calendarDaysEl.style.transform = `translateX(${deltaX}px)`;
                        }
                    }
                }
                // If gestureType is 'scroll', we do nothing here, letting the browser handle it.
            }
        }, { passive: false }); // passive: false is crucial for preventDefault

        calendarContentWrapper.addEventListener('touchend', () => {
            if (isMobileView() && isGestureActive) {
                isGestureActive = false;
                const swipeThreshold = window.innerWidth / 3; // Swipe a third of the screen width
                const swipeDistance = touchCurrentX - touchStartX;

                // Re-enable transitions for snap-back/slide animations
                if (currentCalendarView === 'daily') {
                    if (currentDailyContentEl) currentDailyContentEl.style.transition = 'transform 0.2s ease-out';
                    if (adjacentDailyContentEl) adjacentDailyContentEl.style.transition = 'transform 0.2s ease-out';
                } else if (currentCalendarView === 'monthly') {
                    if (calendarDaysEl) calendarDaysEl.style.transition = 'transform 0.2s ease-in-out';
                }

                if (gestureType === 'swipe') {
                    if (Math.abs(swipeDistance) > swipeThreshold) {
                        // Swipe successful
                        if (swipeDistance < 0) { // Swiped left (next day/month)
                            if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(-100%)';
                            if (adjacentDailyContentEl) adjacentDailyContentEl.style.transform = 'translateX(0)';
                            if (currentCalendarView === 'monthly' && calendarDaysEl) calendarDaysEl.style.transform = 'translateX(-100%)';

                            if (currentCalendarView === 'daily') {
                                currentDailyDate.setDate(currentDailyDate.getDate() + 1); // Update date
                            } else { // monthly
                                currentMonth++;
                                if (currentMonth > 11) {
                                    currentMonth = 0;
                                    currentYear++;
                                }
                            }
                        } else { // Swiped right (previous day/month)
                            if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(100%)';
                            if (adjacentDailyContentEl) adjacentDailyContentEl.style.transform = 'translateX(0)';
                            if (currentCalendarView === 'monthly' && calendarDaysEl) calendarDaysEl.style.transform = 'translateX(100%)';

                            if (currentCalendarView === 'daily') {
                                currentDailyDate.setDate(currentDailyDate.getDate() - 1); // Update date
                            } else { // monthly
                                currentMonth--;
                                if (currentMonth < 0) {
                                    currentMonth = 11;
                                    currentYear--;
                                }
                            }
                        }

                        // Update header text immediately for visual feedback
                        // Always update header to only show month and year
                        currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });

                        // Clean up old element/re-render after transition completes
                        setTimeout(() => {
                            if (currentCalendarView === 'daily') {
                                if (currentDailyContentEl && currentDailyContentEl.parentNode) {
                                    currentDailyContentEl.parentNode.removeChild(currentDailyContentEl);
                                }
                                currentDailyContentEl = adjacentDailyContentEl;
                                adjacentDailyContentEl = null;
                                // Reset transform for the new current element to ensure it's at 0
                                if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(0)';
                            } else { // monthly
                                if (calendarDaysEl) {
                                    calendarDaysEl.style.transition = 'none'; // Disable transition before snapping back
                                    calendarDaysEl.style.transform = 'translateX(0)'; // Snap back to original position
                                }
                                updateCalendarView(); // Render the new month
                            }
                        }, 200); // Match CSS transition duration
                    } else {
                        // Swipe too short, snap back to original position
                        if (currentCalendarView === 'daily') {
                            if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(0)';
                            if (adjacentDailyContentEl) {
                                const initialAdjacentOffset = (swipeDistance < 0) ? window.innerWidth : -window.innerWidth;
                                adjacentDailyContentEl.style.transform = `translateX(${initialAdjacentOffset}px)`;
                                // Remove adjacent element after it snaps back
                                adjacentDailyContentEl.addEventListener('transitionend', function handler() {
                                    adjacentDailyContentEl.removeEventListener('transitionend', handler);
                                    if (adjacentDailyContentEl.parentNode) {
                                        adjacentDailyContentEl.parentNode.removeChild(adjacentDailyContentEl);
                                    }
                                    adjacentDailyContentEl = null;
                                }, { once: true });
                            }
                        } else { // monthly
                            if (calendarDaysEl) {
                                calendarDaysEl.style.transform = 'translateX(0)';
                            }
                        }
                    }
                }
                // Reset gesture state
                touchStartX = 0;
                touchStartY = 0;
                touchCurrentX = 0;
                touchCurrentY = 0;
                gestureType = 'none';
            }
        });


        // --- Add Transaction Modal Logic ---
        function openAddTransactionModal(date) {
            selectedDate = date;
            // The span for the date within the h2 will inherit the h2's style, no need for font-normal
            addModalDateEl.textContent = new Date(date).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            openModal(addTransactionModal); // Use generic open modal function
            // Attempt to focus an input field to help with iOS PWA touch issues
            setTimeout(() => { // Add a small delay to ensure modal is fully rendered
                addTransactionNameInput.focus();
            }, 100);
            // Set default values and toggle visibility
            addTransactionTypeInput.value = 'expense';
            addTransactionNameInput.value = '';
            addTransactionAmountInput.value = '';
            addTransactionRepeatInput.value = 'none';
            addAdjustForNonWorkingDaysCheckbox.checked = false; // Default to unchecked
            addTransactionEndDateInput.value = ''; // Clear end date
            toggleAddRepeatOptions(); // Initial toggle to set visibility
        }

        function closeAddModal() {
            closeModal(addTransactionModal); // Use generic close modal function
            // Clear form fields when closing
            addTransactionTypeInput.value = 'expense';
            addTransactionNameInput.value = '';
            addTransactionAmountInput.value = '';
            addTransactionRepeatInput.value = 'none';
            addAdjustForNonWorkingDaysCheckbox.checked = false; // Reset to default unchecked
            addTransactionEndDateInput.value = ''; // Reset end date
            selectedDate = null;
            toggleAddRepeatOptions(); // Ensure repeat options are hidden for next open if not recurring
            updateCalendarView(); // Re-render calendar to reflect changes, based on current view
            renderOverview(); // Also re-render overview in case current day's transactions changed
        }

        // Toggle visibility of repeat options (end date and adjust for non-working days)
        function toggleAddRepeatOptions() {
            const isRepeating = addTransactionRepeatInput.value !== 'none';
            if (isRepeating) {
                addEndDateGroup.classList.remove('hidden');
                addAdjustForNonWorkingDaysGroup.classList.remove('hidden'); // Show new checkbox
            } else {
                addEndDateGroup.classList.add('hidden');
                addAdjustForNonWorkingDaysGroup.classList.add('hidden'); // Hide new checkbox
            }
        }

        // --- Edit Transaction Modal Logic ---
        function openEditTransactionModal(transactionId, instanceDate) {
            const originalTx = transactions.find(t => t.id === transactionId);
            if (!originalTx) {
                showMessage('Error: Transaction not found for editing.');
                return;
            }

            editingTransactionId = transactionId;
            editingTransactionInstanceDate = instanceDate; // The date of the specific instance being edited

            editTransactionTypeInput.value = originalTx.type;
            editTransactionNameInput.value = originalTx.name;
            editTransactionAmountInput.value = originalTx.amount;
            editTransactionRepeatInput.value = originalTx.repeat;
            // Ensure adjustForNonWorkingDays is set, default to false if undefined (for old transactions)
            editAdjustForNonWorkingDaysCheckbox.checked = originalTx.adjustForNonWorkingDays !== undefined ? originalTx.adjustForNonWorkingDays : false;
            editTransactionEndDateInput.value = originalTx.endDate || ''; // Set end date

            toggleEditRepeatOptions(); // Adjust repeat options visibility

            openModal(editTransactionModal); // Show edit modal
        }

        function closeEditModal() {
            closeModal(editTransactionModal); // Use generic close modal function
            editingTransactionId = null;
            editingTransactionInstanceDate = null;
            updateCalendarView(); // Re-render calendar
            renderOverview(); // Re-render overview
        }

        // Toggle visibility of repeat options (end date and adjust for non-working days) for Edit Modal
        function toggleEditRepeatOptions() {
            const isRepeating = editTransactionRepeatInput.value !== 'none';
            if (isRepeating) {
                editEndDateGroup.classList.remove('hidden');
                editAdjustForNonWorkingDaysGroup.classList.remove('hidden'); // Show new checkbox
            } else {
                editEndDateGroup.classList.add('hidden');
                editAdjustForNonWorkingDaysGroup.classList.add('hidden'); // Hide new checkbox
            }
        }

        // Event listener for transaction type change in Edit Modal
        editTransactionTypeInput.addEventListener('change', toggleEditRepeatOptions);
        editTransactionRepeatInput.addEventListener('change', toggleEditRepeatOptions); // New listener for repeat change

        // --- Overview Rendering ---
        function renderOverview() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayFormatted = formatDate(today);

            // 1. Today's transactions
            overviewTodaysTransactionsListEl.innerHTML = '';
            const todaysTransactions = getTransactionsEffectiveOnDateList(todayFormatted);
            if (todaysTransactions.length === 0) {
                // Changed py-4 to pt-0 for the p tag inside
                overviewTodaysTransactionsListEl.innerHTML = '<p class="text-gray-500 text-left pt-0 text-sm">No transactions for today.</p>';
            } else {
                todaysTransactions.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'overview-transaction-item';
                    const displayType = t.type === 'income' ? '+' : '-';
                    const displayAmount = `${displayType}£${t.amount.toFixed(2)}`;
                    div.innerHTML = `
                        <span>${t.name}</span>
                        <span class="${t.type === 'income' ? 'text-green-700' : 'text-red-700'}">${displayAmount}</span>
                    `;
                    overviewTodaysTransactionsListEl.appendChild(div);
                });
            }

            // 2. Current Balance
            const currentBalance = calculateBalanceUpToDate(today);
            updateBalanceDisplay(currentBalance, currentBalanceSign, currentBalanceDisplay);

            // 3. Days until next income transaction & 4. Lowest balance until next income
            let nextIncomeDate = null;
            let nextIncomeAmount = 0;
            
            let lowestBalanceInPeriod = currentBalance; 

            const lookaheadEndDate = new Date(today);
            lookaheadEndDate.setFullYear(lookaheadEndDate.getFullYear() + 2); // 2 years lookahead

            // Create a list of all relevant financial events
            const financialEvents = [];

            // Add all balance updates *after* today
            balanceUpdates.forEach(bu => {
                const buDate = parseDate(bu.date);
                if (buDate.getTime() > today.getTime()) {
                    financialEvents.push({ date: buDate, type: 'balanceUpdate', amount: bu.amount });
                }
            });

            // Add all transaction occurrences within the lookahead period
            transactions.forEach(t => {
                const transactionStartDate = parseDate(t.date);
                transactionStartDate.setHours(0,0,0,0);

                if (t.repeat === 'none') {
                    const effectiveDate = getEffectiveDateForNominalDate(t, transactionStartDate);
                    if (effectiveDate.getTime() > today.getTime() && effectiveDate.getTime() <= lookaheadEndDate.getTime()) {
                        financialEvents.push({
                            date: effectiveDate,
                            type: t.type,
                            amount: t.amount,
                            name: t.name
                        });
                    }
                } else {
                    let currentNominalOccurrence = new Date(transactionStartDate);
                    currentNominalOccurrence.setHours(0,0,0,0);

                    // Advance currentNominalOccurrence until it's at or after today
                    // This ensures we start generating future occurrences from the correct point.
                    while (currentNominalOccurrence.getTime() < today.getTime()) {
                        const next = getNextOccurrence(currentNominalOccurrence, t.repeat);
                        if (!next || (t.endDate && next.getTime() > parseDate(t.endDate).getTime())) {
                            currentNominalOccurrence = null;
                            break;
                        }
                        currentNominalOccurrence = next;
                    }

                    if (currentNominalOccurrence) { // If there's a starting point today or in the future
                        while (currentNominalOccurrence.getTime() <= lookaheadEndDate.getTime()) {
                            if (t.endDate && currentNominalOccurrence.getTime() > parseDate(t.endDate).getTime()) {
                                break;
                            }

                            const effectiveDate = getEffectiveDateForNominalDate(t, currentNominalOccurrence);

                            // Only add if the effective date is within the lookahead and is not today (already handled by currentBalance)
                            // The condition `effectiveDate.getTime() > today.getTime()` correctly filters out today's transactions
                            // which are already factored into the initial `runningBalance`.
                            if (effectiveDate.getTime() > today.getTime() && effectiveDate.getTime() <= lookaheadEndDate.getTime()) {
                                financialEvents.push({
                                    date: effectiveDate,
                                    type: t.type,
                                    amount: t.amount,
                                    name: t.name
                                });
                            }

                            const next = getNextOccurrence(currentNominalOccurrence, t.repeat);
                            if (!next) break;
                            currentNominalOccurrence = next;
                        }
                    }
                }
            });

            // Sort all events chronologically
            financialEvents.sort((a, b) => a.date.getTime() - b.date.getTime());

            let runningBalance = calculateBalanceUpToDate(today); // Start with today's balance
            lowestBalanceInPeriod = runningBalance; // Initialize with current balance

            for (const event of financialEvents) {
                // Skip events on or before today, as they are already accounted for in the initial `runningBalance`
                if (event.date.getTime() <= today.getTime()) continue; 

                // If this event is a balance update, reset the running balance
                if (event.type === 'balanceUpdate') {
                    runningBalance = event.amount;
                } else {
                    // Otherwise, apply the transaction
                    runningBalance += (event.type === 'income' ? event.amount : -event.amount);
                }

                // Update lowest balance encountered
                if (runningBalance < lowestBalanceInPeriod) {
                    lowestBalanceInPeriod = runningBalance;
                }

                // If we found an income event, this is our next income date for the "Amount Available" calculation
                if (event.type === 'income' && !nextIncomeDate) {
                    nextIncomeDate = event.date;
                    // Sum all incomes on nextIncomeDate (including those that shifted to this date)
                    const incomesOnNextDate = financialEvents.filter(e => formatDate(e.date) === formatDate(nextIncomeDate) && e.type === 'income');
                    nextIncomeAmount = incomesOnNextDate.reduce((sum, e) => sum + e.amount, 0);

                    // Break the loop once the first future income is found, as per the definition of "Amount Available"
                    break;
                }
            }


            if (nextIncomeDate) {
                const diffDays = Math.round((nextIncomeDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                overviewNextIncomeStatementEl.textContent = `You will be paid £${nextIncomeAmount.toFixed(2)} in ${diffDays} day${diffDays === 1 ? '' : 's'}.`;
                
                updateBalanceDisplay(lowestBalanceInPeriod, lowestBalanceSign, lowestBalanceDisplay);
            } else {
                overviewNextIncomeStatementEl.textContent = 'No future income found within 2 years.';
                
                updateBalanceDisplay(0, lowestBalanceSign, lowestBalanceDisplay);
            }

            // 5. Render Pie Chart
            renderPieChart();
        }

        /**
         * Updates the display of a balance figure with correct sign and color.
         * @param {number} balance - The numerical balance.
         * @param {HTMLElement} signEl - The span element for the sign.
         * @param {HTMLElement} parentDisplayEl - The parent div for the entire balance display (for color class).
         */
        function updateBalanceDisplay(balance, signEl, parentDisplayEl) {
            // Find the currency and value elements within the parentDisplayEl
            const currencyEl = parentDisplayEl.querySelector('.currency');
            const valueEl = parentDisplayEl.querySelector('.amount');

            if (balance < 0) {
                signEl.textContent = '-';
                parentDisplayEl.classList.add('negative');
                parentDisplayEl.classList.remove('positive');
            } else {
                signEl.textContent = '';
                parentDisplayEl.classList.add('positive');
                parentDisplayEl.classList.remove('negative');
            }
            currencyEl.textContent = '£'; // Always £
            valueEl.textContent = Math.abs(balance).toFixed(2); // Use Math.abs and toFixed(2)
        }

        // --- Pie Chart Logic ---
        function renderPieChart() {
            const currentMonthStart = new Date(currentYear, currentMonth, 1);
            const currentMonthEnd = new Date(currentYear, currentMonth + 1, 0); // Last day of current month

            let totalIncome = 0;
            let totalExpenses = 0;

            // Iterate through each day of the current month to accurately sum up repeating transactions
            let dayIterator = new Date(currentMonthStart);
            while (dayIterator.getTime() <= currentMonthEnd.getTime()) {
                const dailyTransactions = getTransactionsEffectiveOnDateList(formatDate(dayIterator));
                dailyTransactions.forEach(t => {
                    if (t.type === 'income') {
                        totalIncome += t.amount;
                    } else {
                        totalExpenses += t.amount;
                    }
                });
                dayIterator.setDate(dayIterator.getDate() + 1);
            }

            if (totalIncome === 0 && totalExpenses === 0) {
                pieChartDescription.classList.remove('hidden');
                incomeExpensePieChartCanvas.classList.add('hidden');
                if (incomeExpensePieChartInstance) {
                    incomeExpensePieChartInstance.destroy(); // Destroy previous chart instance
                    incomeExpensePieChartInstance = null;
                }
            } else {
                pieChartDescription.classList.add('hidden');
                incomeExpensePieChartCanvas.classList.remove('hidden');

                if (incomeExpensePieChartInstance) {
                    incomeExpensePieChartInstance.destroy(); // Destroy previous chart instance
                }

                const ctx = incomeExpensePieChartCanvas.getContext('2d');
                incomeExpensePieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Income', 'Expenses'],
                        datasets: [{
                            data: [totalIncome, totalExpenses],
                            backgroundColor: [
                                '#6366f1', // Income (Indigo 500)
                                '#a5b4fc'  // Expenses (Indigo 300)
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Set to false to allow container to define height
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 14,
                                        family: 'Inter'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += '£' + context.parsed.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // --- Pay Estimator Logic ---

        // UK Tax Year 2024/2025 (simplified)
        const TAX_YEAR_START_MONTH = 3; // April (0-indexed is 3)
        const TAX_YEAR_START_DAY = 6; // 6th April

        const UK_TAX_THRESHOLDS = {
            personalAllowance: 12570,
            basicRateBand: 37700, // 50270 - 12570
            higherRateBand: 74870, // 125140 - 50270
        };

        const UK_TAX_RATES = {
            basic: 0.20,
            higher: 0.40,
            additional: 0.45,
        };

        const UK_NI_THRESHOLDS_ANNUAL = {
            primaryThreshold: 12570, // No NI below this
            upperEarningsLimit: 50270, // 10% between PT and UEL
        };

        const UK_NI_RATES = {
            basic: 0.10, // 10% for earnings between PT and UEL
            additional: 0.02, // 2% for earnings above UEL
        };

        function calculateIncomeTax(annualGrossPay) {
            let tax = 0;
            let taxableIncome = Math.max(0, annualGrossPay - UK_TAX_THRESHOLDS.personalAllowance);

            // Basic Rate
            if (taxableIncome > 0) {
                const basicRateTaxable = Math.min(taxableIncome, UK_TAX_THRESHOLDS.basicRateBand);
                tax += basicRateTaxable * UK_TAX_RATES.basic;
                taxableIncome -= basicRateTaxable;
            }

            // Higher Rate
            if (taxableIncome > 0) {
                const higherRateTaxable = Math.min(taxableIncome, UK_TAX_THRESHOLDS.higherRateBand);
                tax += higherRateTaxable * UK_TAX_RATES.higher;
                taxableIncome -= higherRateTaxable;
            }

            // Additional Rate
            if (taxableIncome > 0) {
                tax += taxableIncome * UK_TAX_RATES.additional;
            }
            return tax;
        }

        function calculateNationalInsurance(annualGrossPay) {
            let ni = 0;
            const pt = UK_NI_THRESHOLDS_ANNUAL.primaryThreshold;
            const uel = UK_NI_THRESHOLDS_ANNUAL.upperEarningsLimit;

            // Earnings between Primary Threshold and Upper Earnings Limit
            if (annualGrossPay > pt) {
                const earningsInBasicBand = Math.min(annualGrossPay, uel) - pt;
                ni += earningsInBasicBand * UK_NI_RATES.basic;
            }

            // Earnings above Upper Earnings Limit
            if (annualGrossPay > uel) {
                const earningsInAdditionalBand = annualGrossPay - uel;
                ni += earningsInAdditionalBand * UK_NI_RATES.additional;
            }
            return ni;
        }

        function calculatePay() {
            const rateAmount = parseFloat(payRateAmountInput.value);
            const rateUnit = payRateUnitSelect.value;
            const contractedUnits = parseFloat(contractedUnitsInput.value);
            const payFrequency = payFrequencySelect.value;

            if (isNaN(rateAmount) || rateAmount <= 0) {
                showMessage('Please enter a valid positive rate amount.');
                return null; // Return null to indicate failure
            }
            if (rateUnit !== 'annually' && rateUnit !== 'monthly' && (isNaN(contractedUnits) || contractedUnits <= 0)) {
                showMessage('Please enter valid positive contracted units.');
                return null; // Return null to indicate failure
            }

            let annualGrossPay = 0;

            switch (rateUnit) {
                case 'hourly':
                    // Assuming contractedUnits is hours per week
                    annualGrossPay = rateAmount * contractedUnits * 52; // 52 weeks in a year
                    break;
                case 'daily':
                    // Assuming contractedUnits is days per week
                    annualGrossPay = rateAmount * contractedUnits * 52; // 52 weeks in a year
                    break;
                case 'weekly':
                    annualGrossPay = rateAmount * 52;
                    break;
                case 'monthly':
                    annualGrossPay = rateAmount * 12;
                    break;
                case 'annually':
                    annualGrossPay = rateAmount;
                    break;
                case 'project':
                    annualGrossPay = rateAmount * contractedUnits;
                    break;
            }

            const annualTax = calculateIncomeTax(annualGrossPay);
            const annualNI = calculateNationalInsurance(annualGrossPay);
            const annualNetPay = annualGrossPay - annualTax - annualNI;

            let grossPay = 0;
            let niDeduction = 0;
            let taxDeduction = 0;
            let netPay = 0;

            switch (payFrequency) {
                case 'weekly':
                    grossPay = annualGrossPay / 52;
                    niDeduction = annualNI / 52;
                    taxDeduction = annualTax / 52;
                    netPay = annualNetPay / 52;
                    break;
                case 'bi-weekly':
                    grossPay = annualGrossPay / 26;
                    niDeduction = annualNI / 26;
                    taxDeduction = annualTax / 26;
                    netPay = annualNetPay / 26;
                    break;
                case 'four-weekly':
                    grossPay = annualGrossPay / 13; // 52 weeks / 4 weeks = 13 periods
                    niDeduction = annualNI / 13;
                    taxDeduction = annualTax / 13;
                    netPay = annualNetPay / 13;
                    break;
                case 'monthly':
                    grossPay = annualGrossPay / 12;
                    niDeduction = annualNI / 12;
                    taxDeduction = annualTax / 12;
                    netPay = annualNetPay / 12;
                    break;
                case 'annually':
                    grossPay = annualGrossPay;
                    niDeduction = annualNI;
                    taxDeduction = annualTax;
                    netPay = annualNetPay;
                    break;
            }

            grossPayResultSpan.textContent = `£${grossPay.toFixed(2)}`;
            niDeductionResultSpan.textContent = `£${niDeduction.toFixed(2)}`;
            taxDeductionResultSpan.textContent = `£${taxDeduction.toFixed(2)}`;
            netPayResultSpan.textContent = `£${netPay.toFixed(2)}`;
            payEstimatorResultsDiv.classList.remove('hidden');

            return { grossPay, niDeduction, taxDeduction, netPay, payFrequency };
        }

        function updateContractedUnitsLabel() {
            const rateUnit = payRateUnitSelect.value;
            contractedUnitsGroup.classList.remove('hidden'); // Show by default

            switch (rateUnit) {
                case 'hourly':
                    contractedUnitsLabel.textContent = 'Hours per Week:';
                    contractedUnitsInput.placeholder = 'e.g., 40';
                    break;
                case 'daily':
                    contractedUnitsLabel.textContent = 'Days per Week:';
                    contractedUnitsInput.placeholder = 'e.g., 5';
                    break;
                case 'weekly':
                    contractedUnitsGroup.classList.add('hidden'); // Hide for weekly
                    break;
                case 'monthly':
                    contractedUnitsGroup.classList.add('hidden'); // Hide for monthly
                    break;
                case 'annually':
                    contractedUnitsGroup.classList.add('hidden'); // Hide for annually
                    break;
                case 'project':
                    contractedUnitsLabel.textContent = 'Projects per Year (Avg):';
                    contractedUnitsInput.placeholder = 'e.g., 12';
                    break;
            }
        }

        payRateUnitSelect.addEventListener('change', updateContractedUnitsLabel);
        calculatePayBtn.addEventListener('click', calculatePay);

        addEstimatedPayToCalendarBtn.addEventListener('click', () => {
            const payData = calculatePay(); // Recalculate to get current values
            if (!payData) return; // If calculation failed, do nothing

            estimatedNetPayValue = payData.netPay;
            estimatedPayFrequencyValue = payData.payFrequency;

            modalEstimatedNetPaySpan.textContent = `£${estimatedNetPayValue.toFixed(2)}`;
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            nextPayDateInput.value = formatDate(tomorrow);
            
            confirmPayFrequencySelect.value = estimatedPayFrequencyValue;

            openModal(confirmPayAddModal); // Use generic open modal function
        });

        confirmAddPayBtn.addEventListener('click', () => {
            const selectedNextPayDate = nextPayDateInput.value;
            const confirmedFrequency = confirmPayFrequencySelect.value;

            if (!selectedNextPayDate) {
                showMessage('Please select a next pay day.');
                return;
            }

            if (estimatedNetPayValue <= 0) {
                showMessage('Net pay must be positive to add to calendar.');
                return;
            }
            
            const newTransaction = {
                id: Date.now(),
                type: 'income',
                name: `Estimated Net Pay (${confirmedFrequency})`,
                amount: estimatedNetPayValue,
                date: selectedNextPayDate, // Use the date from the modal
                repeat: confirmedFrequency, // Use the frequency from the modal
                adjustForNonWorkingDays: true, // Default to true for estimated pay
                endDate: null,
                parentId: null // New transaction, no parent
            };

            transactions.push(newTransaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            showMessage(`Estimated net pay of £${estimatedNetPayValue.toFixed(2)} added to calendar for ${selectedNextPayDate}!`);
            
            closeModal(confirmPayAddModal); // Use generic close modal function
            updateCalendarView(); // Re-render calendar based on current view
            renderOverview();
        });

        closeConfirmPayAddModalBtn.addEventListener('click', () => closeModal(confirmPayAddModal));
        confirmPayAddModal.addEventListener('click', (e) => {
            if (e.target === confirmPayAddModal) {
                closeModal(confirmPayAddModal);
            }
        });

        // --- Universal Credit Logic ---
        const UC_RATES = {
            standardAllowance: {
                singleUnder25: 311.68,
                single25Over: 393.45,
                coupleBothUnder25: 488.82,
                coupleOneOrBoth25Over: 617.60
            },
            childElement: {
                firstChildBefore2017: 333.87, // Or only child
                otherChild: 287.92 // Second child and subsequent
            },
            disabilityElement: {
                lcw: 156.11,
                lcwra: 416.19
            },
            workAllowance: {
                noHousing: 379.00,
                withHousing: 631.00
            },
            taperRate: 0.55 // 55%
        };

        function calculateUniversalCredit() {
            const claimStatus = document.querySelector('input[name="ucClaimStatus"]:checked').value;
            let ageGroupP1 = document.querySelector('input[name="ucAge"]:checked')?.value;
            let ageGroupP2 = null;

            if (claimStatus === 'couple') {
                ageGroupP1 = document.querySelector('input[name="ucAgeP1"]:checked')?.value;
                ageGroupP2 = document.querySelector('input[name="ucAgeP2"]:checked')?.value;
            }

            const numChildren = parseInt(ucNumChildrenInput.value);
            const childBornBefore2017 = ucChildBornBefore2017Checkbox.checked;
            const disabilityStatus = ucDisabilityStatusSelect.value;
            const monthlyRent = parseFloat(ucMonthlyRentInput.value);
            const monthlyEarnings = parseFloat(ucMonthlyEarningsInput.value);

            let totalElements = 0;
            let standardAllowance = 0;
            let childElements = 0;
            let disabilityElement = 0;
            let housingElement = 0;
            let workAllowance = 0;
            let earningsDeduction = 0;
            let netUC = 0;

            // 1. Standard Allowance
            if (claimStatus === 'single') {
                standardAllowance = (ageGroupP1 === 'under25') ? UC_RATES.standardAllowance.singleUnder25 : UC_RATES.standardAllowance.single25Over;
            } else { // couple
                if (ageGroupP1 === 'under25' && ageGroupP2 === 'under25') {
                    standardAllowance = UC_RATES.standardAllowance.coupleBothUnder25;
                } else {
                    standardAllowance = UC_RATES.standardAllowance.coupleOneOrBoth25Over;
                }
            }
            totalElements += standardAllowance;

            // 2. Child Elements
            if (numChildren > 0) {
                if (childBornBefore2017) {
                    childElements += UC_RATES.childElement.firstChildBefore2017;
                    if (numChildren > 1) {
                        childElements += (numChildren - 1) * UC_RATES.childElement.otherChild;
                    }
                } else {
                    childElements += numChildren * UC_RATES.childElement.otherChild;
                }
            }
            totalElements += childElements;

            // 3. Disability Element
            if (disabilityStatus === 'lcw') {
                disabilityElement = UC_RATES.disabilityElement.lcw;
            } else if (disabilityStatus === 'lcwra') {
                disabilityElement = UC_RATES.disabilityElement.lcwra;
            }
            totalElements += disabilityElement;

            // 4. Housing Element
            housingElement = monthlyRent; // Simplified: Assumes full rent is covered, no LHA limits
            totalElements += housingElement;

            // 5. Work Allowance
            const hasChildrenOrDisability = (numChildren > 0 || disabilityStatus !== 'none');
            if (hasChildrenOrDisability) {
                workAllowance = (monthlyRent > 0) ? UC_RATES.workAllowance.withHousing : UC_RATES.workAllowance.noHousing;
            } else {
                workAllowance = 0; // No work allowance if no children and no disability
            }

            // 6. Earnings Deduction
            let earningsAfterWorkAllowance = Math.max(0, monthlyEarnings - workAllowance);
            earningsDeduction = earningsAfterWorkAllowance * UC_RATES.taperRate;

            // 7. Net UC Payment
            netUC = totalElements - earningsDeduction;
            netUC = Math.max(0, netUC); // UC cannot be negative

            ucStandardAllowanceSpan.textContent = `£${standardAllowance.toFixed(2)}`;
            ucChildElementsSpan.textContent = `£${childElements.toFixed(2)}`;
            ucDisabilityElementSpan.textContent = `£${disabilityElement.toFixed(2)}`;
            ucHousingElementSpan.textContent = `£${housingElement.toFixed(2)}`;
            ucTotalElementsSpan.textContent = `£${totalElements.toFixed(2)}`;
            ucWorkAllowanceSpan.textContent = `£${workAllowance.toFixed(2)}`;
            ucEarningsDeductionSpan.textContent = `£${earningsDeduction.toFixed(2)}`;
            ucNetPaymentSpan.textContent = `£${netUC.toFixed(2)}`;
            ucNetPaymentSpan.classList.toggle('negative', netUC < 0); // Apply negative class if needed
            ucCalculatorResultsDiv.classList.remove('hidden');

            return netUC;
        }

        // Event listeners for UC inputs to update age group visibility
        ucClaimStatusRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'single') {
                    ucAgeGroupSingleDiv.classList.remove('hidden');
                    ucAgeGroupCoupleDiv.classList.add('hidden');
                } else {
                    ucAgeGroupSingleDiv.classList.add('hidden');
                    ucAgeGroupCoupleDiv.classList.remove('hidden');
                }
            });
        });

        calculateUCBtn.addEventListener('click', calculateUniversalCredit);

        addEstimatedUCtoCalendarBtn.addEventListener('click', () => {
            estimatedUcPaymentValue = calculateUniversalCredit(); // Recalculate UC
            if (estimatedUcPaymentValue <= 0) {
                showMessage('Estimated Universal Credit must be positive to add to calendar.');
                return;
            }

            modalEstimatedUcPaymentSpan.textContent = `£${estimatedUcPaymentValue.toFixed(2)}`;
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            nextUcPayDateInput.value = formatDate(tomorrow);
            
            // UC is always monthly, so pre-select monthly
            confirmUcFrequencySelect.value = 'monthly';

            openModal(confirmUcAddModal); // Use generic open modal function
        });

        // Corrected: Add null check for confirmAddUcBtn
        if (confirmAddUcBtn) {
            confirmAddUcBtn.addEventListener('click', () => {
                const selectedNextUcPayDate = nextUcPayDateInput.value;
                const confirmedFrequency = confirmUcFrequencySelect.value; // Will always be monthly for UC

                if (!selectedNextUcPayDate) {
                    showMessage('Please select a next UC payment day.');
                    return;
                }

                if (estimatedUcPaymentValue <= 0) {
                    showMessage('Net UC payment must be positive to add to calendar.');
                    return;
                }
                
                const newTransaction = {
                    id: Date.now(),
                    type: 'income',
                    name: `Estimated Universal Credit`,
                    amount: estimatedUcPaymentValue,
                    date: selectedNextUcPayDate,
                    repeat: confirmedFrequency,
                    adjustForNonWorkingDays: true, // Default to true for estimated UC
                    endDate: null,
                    parentId: null // New transaction, no parent
                };

                transactions.push(newTransaction);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                showMessage(`Estimated UC of £${estimatedUcPaymentValue.toFixed(2)} added to calendar for ${selectedNextUcPayDate}!`);
                
                closeModal(confirmUcAddModal); // Use generic close modal function
                updateCalendarView(); // Re-render calendar based on current view
                renderOverview();
            });
        }


        // Close button for confirm UC add modal
        // Corrected: Add null check for closeConfirmUcAddModalBtn
        if (closeConfirmUcAddModalBtn) {
            closeConfirmUcAddModalBtn.addEventListener('click', () => closeModal(confirmUcAddModal));
        }
        
        confirmUcAddModal.addEventListener('click', (e) => {
            if (e.target === confirmUcAddModal) {
                closeModal(confirmUcAddModal);
            }
        });

        // New: Import Pay Estimator Earnings
        importPayEstimatorEarningsBtn.addEventListener('click', () => {
            const payData = calculatePay(); // Recalculate pay to get latest net pay
            if (payData && payData.netPay > 0) {
                // Convert net pay to monthly if it's not already monthly
                let monthlyNetPay = payData.netPay;
                switch (payData.payFrequency) {
                    case 'weekly':
                        monthlyNetPay = payData.netPay * (52 / 12);
                        break;
                    case 'bi-weekly':
                        monthlyNetPay = payData.netPay * (26 / 12);
                        break;
                    case 'four-weekly':
                        monthlyNetPay = payData.netPay * (13 / 12);
                        break;
                    case 'annually':
                        monthlyNetPay = payData.netPay / 12;
                        break;
                    // 'monthly' is already monthly
                }
                ucMonthlyEarningsInput.value = monthlyNetPay.toFixed(2);
                showMessage(`Monthly net earnings (£${monthlyNetPay.toFixed(2)}) imported from Pay Estimator!`);
            } else {
                showMessage('Please calculate a positive net pay in the Pay Estimator first.');
            }
        });


        // --- Event Listeners ---
        // Close modal buttons now use the generic closeModal function
        closeAddModalBtn.addEventListener('click', closeAddModal);
        addTransactionModal.addEventListener('click', (e) => {
            if (e.target === addTransactionModal) { // Close if clicked outside content
                closeAddModal();
            }
        });

        // Listen for repeat selection change to toggle visibility of adjust and end date fields
        addTransactionRepeatInput.addEventListener('change', toggleAddRepeatOptions);


        closeEditModalBtn.addEventListener('click', closeEditModal);
        editTransactionModal.addEventListener('click', (e) => {
            if (e.target === editTransactionModal) { // Close if clicked outside content
                closeEditModal();
            }
        });

        // Event listener for new Update Balance Button
        updateBalanceBtn.addEventListener('click', () => {
            const today = new Date();
            // Pre-fill with current balance if available, otherwise empty
            const currentBalance = calculateBalanceUpToDate(today);
            newBalanceAmountInput.value = currentBalance.toFixed(2);
            openModal(updateBalanceModal); // Use generic open modal function
        });

        function closeUpdateBalanceModal() {
            closeModal(updateBalanceModal); // Use generic close modal function
            newBalanceAmountInput.value = ''; // Clear input
            renderOverview(); // Re-render overview to reflect new balance
            updateCalendarView(); // Re-render calendar as well
        }

        closeUpdateBalanceModalBtn.addEventListener('click', closeUpdateBalanceModal);
        updateBalanceModal.addEventListener('click', (e) => {
            if (e.target === updateBalanceModal) {
                closeUpdateBalanceModal();
            }
        });

        saveBalanceBtn.addEventListener('click', () => {
            const newBalance = parseFloat(newBalanceAmountInput.value);
            if (isNaN(newBalance)) {
                showMessage('Please enter a valid number for your balance.');
                return;
            }

            const today = new Date();
            const todayFormatted = formatDate(today);

            // Remove any existing balance update for today, then add the new one
            balanceUpdates = balanceUpdates.filter(update => update.date !== todayFormatted);
            balanceUpdates.push({ date: todayFormatted, amount: newBalance });
            localStorage.setItem('balanceUpdates', JSON.stringify(balanceUpdates));

            showMessage('Balance updated successfully!');
            closeUpdateBalanceModal();
        });


        addTransactionTypeInput.addEventListener('change', toggleAddRepeatOptions);

        // Unified function for adding a transaction
        function handleAddTransaction(e) {
            // Prevent default behavior for touch events
            if (e.type === 'touchend') {
                e.preventDefault();
                e.stopPropagation(); // Stop event propagation for touch events
            }

            // Explicitly blur the select element to ensure it loses focus
            addTransactionRepeatInput.blur();

            const type = addTransactionTypeInput.value;
            const name = addTransactionNameInput.value.trim();
            const amount = parseFloat(addTransactionAmountInput.value);
            const repeat = addTransactionRepeatInput.value;
            // Get value from checkbox, only if repeat is not 'none', otherwise default to false
            const adjustForNonWorkingDays = repeat !== 'none' ? addAdjustForNonWorkingDaysCheckbox.checked : false;
            const endDate = addTransactionEndDateInput.value || null; // Get end date, default to null if empty

            if (!name || isNaN(amount) || amount <= 0) {
                showMessage('Please enter a valid name/source and a positive amount.');
                return;
            }

            const newTransaction = {
                id: Date.now(), // Unique ID for deletion
                type,
                name,
                amount,
                date: selectedDate, // Date of first occurrence
                repeat,
                adjustForNonWorkingDays, // Save the adjustForNonWorkingDays setting
                endDate, // Save the end date
                parentId: null // New transaction, no parent
            };

            transactions.push(newTransaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            showMessage('Transaction added successfully!');
            // After adding, re-render the daily view if it's currently active for the selected date
            if (currentCalendarView === 'daily' && formatDate(currentDailyDate) === selectedDate) {
                updateCalendarView();
            }
            closeAddModal(); // Close the modal automatically after adding a transaction
        }

        // Attach both click and touchend listeners to the add transaction button
        addTransactionBtn.addEventListener('click', handleAddTransaction);
        addTransactionBtn.addEventListener('touchend', handleAddTransaction);

        /**
         * Traces back the parentId chain to find the original root transaction ID.
         * @param {number} txId - The ID of the transaction to start tracing from.
         * @returns {number|null} The ID of the root transaction, or null if not found.
         */
        function findRootTransactionId(txId) {
            let currentTx = transactions.find(t => t.id === txId);
            if (!currentTx) return null; // Transaction not found

            let rootId = currentTx.id;
            let parentId = currentTx.parentId;

            // Keep tracing back until parentId is null or we can't find the parent
            while (parentId !== null) {
                const parentTx = transactions.find(t => t.id === parentId);
                if (!parentTx) {
                    // Parent not found, something is wrong with the chain, return current root
                    console.warn(`Parent transaction with ID ${parentId} not found for transaction ID ${currentTx.id}.`);
                    break;
                }
                rootId = parentTx.id; // Move up the chain
                parentId = parentTx.parentId;
                currentTx = parentTx; // Update currentTx to the parent for the next iteration
            }
            return rootId;
        }

        saveEditedTransactionBtn.addEventListener('click', () => {
            const newType = editTransactionTypeInput.value;
            const newName = editTransactionNameInput.value.trim();
            const newAmount = parseFloat(editTransactionAmountInput.value);
            const newRepeat = editTransactionRepeatInput.value;
            // Get value from checkbox, only if repeat is not 'none', otherwise default to false
            const newAdjustForNonWorkingDays = newRepeat !== 'none' ? editAdjustForNonWorkingDaysCheckbox.checked : false;
            const newEndDate = editTransactionEndDateInput.value || null; // Get end date, default to null if empty

            if (!newName || isNaN(newAmount) || newAmount <= 0) {
                showMessage('Please enter a valid name/source and a positive amount.');
                return;
            }

            let originalTx = transactions.find(t => t.id === editingTransactionId);
            if (!originalTx) {
                showMessage('Error: Original transaction not found.');
                return;
            }

            const originalTxStartDate = parseDate(originalTx.date);
            const instanceDate = parseDate(editingTransactionInstanceDate);

            // Logic for "This event and all future events"
            // If it's a non-repeating transaction, or editing the very first instance of a repeating one
            // (meaning originalTxStartDate is the same as instanceDate)
            if (originalTx.repeat === 'none' || formatDate(originalTxStartDate) === formatDate(instanceDate)) {
                originalTx.type = newType;
                originalTx.name = newName;
                originalTx.amount = newAmount;
                originalTx.repeat = newRepeat;
                originalTx.adjustForNonWorkingDays = newAdjustForNonWorkingDays; // Update property
                originalTx.endDate = newEndDate;
                // ParentId remains the same (or null) as it's not a split *from* this transaction
                showMessage('Changes applied to this event and all future events.');
            } else {
                // Editing a future instance of a recurring transaction - split it
                // End the original recurring transaction one day before the instance being edited
                const newOriginalTxEndDate = new Date(instanceDate);
                newOriginalTxEndDate.setDate(newOriginalTxEndDate.getDate() - 1); 
                originalTx.endDate = formatDate(newOriginalTxEndDate);

                // Create a new recurring transaction that starts *from* the edited instance date
                const newRepeatingTx = {
                    id: Date.now(), // New unique ID for the new series
                    type: newType,
                    name: newName,
                    amount: newAmount,
                    date: editingTransactionInstanceDate, // New repeating transaction starts from here
                    repeat: newRepeat,
                    adjustForNonWorkingDays: newAdjustForNonWorkingDays, // Carry over new property
                    endDate: newEndDate, // Carry over the new end date
                    parentId: originalTx.id // Set parentId to link it to the original series
                };
                transactions.push(newRepeatingTx);
                showMessage('Changes applied to this event and all future events (transaction split).');
            }

            localStorage.setItem('transactions', JSON.stringify(transactions));
            closeEditModal(); // Close edit modal, which will trigger re-render of add modal and calendar
        });

        // Function to handle tab switching logic (used by both desktop and mobile nav)
        function switchTab(tabName) {
            // Remove active class from all desktop tab buttons and hide all content
            desktopTabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to the corresponding desktop button (if it exists)
            const targetDesktopButton = document.querySelector(`#desktopTabButtons .tab-button[data-tab="${tabName}"]`);
            if (targetDesktopButton) {
                targetDesktopButton.classList.add('active');
            }
            
            // Show corresponding content
            const targetTabContent = document.getElementById(tabName + 'TabContent');
            if (targetTabContent) {
                targetTabContent.classList.add('active');
            }

            // Perform tab-specific rendering/initialization
            if (tabName === 'overview') {
                renderOverview();
            } else if (tabName === 'calendar') {
                updateCalendarView();
            } else if (tabName === 'pay-estimator') {
                updateContractedUnitsLabel();
                payEstimatorResultsDiv.classList.add('hidden');
            } else if (tabName === 'universal-credit') {
                const currentClaimStatus = document.querySelector('input[name="ucClaimStatus"]:checked').value;
                if (currentClaimStatus === 'single') {
                    ucAgeGroupSingleDiv.classList.remove('hidden');
                    ucAgeGroupCoupleDiv.classList.add('hidden');
                } else {
                    ucAgeGroupSingleDiv.classList.add('hidden');
                    ucAgeGroupCoupleDiv.classList.remove('hidden');
                }
                ucCalculatorResultsDiv.classList.add('hidden');
            }
        }

        // Desktop tab switching logic
        desktopTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Mobile menu toggle button
        menuToggleBtn.addEventListener('click', () => {
            openModal(mobileNavModal);
        });

        // Close mobile nav modal button (old X button removed)
        mobileNavModal.addEventListener('click', (e) => {
            if (e.target === mobileNavModal) { // Close if clicked outside content
                closeModal(mobileNavModal);
            }
        });

        // Mobile nav buttons inside the modal
        mobileNavButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
                closeModal(mobileNavModal); // Close the modal after selecting a tab
            });
        });

        // New: Event listener for the "Close" button at the bottom of the mobile nav modal
        closeMobileNavBtnBottom.addEventListener('click', () => closeModal(mobileNavModal));

        // Amount Available Help Modal Listeners
        amountAvailableHelpBtn.addEventListener('click', () => {
            openModal(amountAvailableHelpModal);
        });
        closeAmountAvailableHelpModalBtn.addEventListener('click', () => {
            closeModal(amountAvailableHelpModal);
        });
        amountAvailableHelpModal.addEventListener('click', (e) => {
            if (e.target === amountAvailableHelpModal) {
                closeModal(amountAvailableHelpModal);
            }
        });

        // New: Clear All Transactions Button Logic
        const clearAllTransactionsBtn = document.getElementById('clearAllTransactionsBtn');
        clearAllTransactionsBtn.addEventListener('click', () => {
            openModal(clearTransactionsConfirmModal); // Open the new confirmation modal
        });

        // Clear All Transactions Confirmation Modal Yes/No buttons
        confirmClearTransactionsYesBtn.addEventListener('click', () => {
            localStorage.removeItem('transactions');
            localStorage.removeItem('balanceUpdates');
            transactions = []; // Reset in-memory array
            balanceUpdates = []; // Reset in-memory array
            showMessage('All transactions and balance history cleared!');
            closeModal(clearTransactionsConfirmModal); // Close the confirmation modal
            updateCalendarView();
            renderOverview();
        });

        confirmClearTransactionsNoBtn.addEventListener('click', () => {
            closeModal(clearTransactionsConfirmModal); // Just close the confirmation modal
        });

        // Removed closeClearTransactionsConfirmModalBtn.addEventListener('click', ...) as per user request
        clearTransactionsConfirmModal.addEventListener('click', (e) => {
            if (e.target === clearTransactionsConfirmModal) {
                closeModal(clearTransactionsConfirmModal);
            }
        });


        // New: Delete Confirmation Modal Logic for Recurring Transactions
        deleteThisEventOnlyBtn.addEventListener('click', () => {
            const originalTx = transactions.find(tx => tx.id === transactionToDeleteId);
            if (!originalTx) {
                showMessage('Error: Original transaction not found.');
                return;
            }

            const instanceDate = parseDate(transactionToDeleteInstanceDate);
            const originalTxStartDate = parseDate(originalTx.date);
            const originalTxSeriesEndDate = originalTx.endDate; // Store the original series end date

            // Case 1: Deleting the very first instance of a recurring transaction
            if (formatDate(originalTxStartDate) === formatDate(instanceDate)) {
                const nextValidOccurrenceDate = getNextOccurrence(instanceDate, originalTx.repeat);
                if (nextValidOccurrenceDate) {
                    // Update the original transaction to start from its next occurrence
                    originalTx.date = formatDate(nextValidOccurrenceDate);
                    // The original end date remains the same
                    // ParentId remains the same as it's still the "root" of this branch
                    showMessage('This event deleted. Future events will continue from the next occurrence.');
                } else {
                    // If there's no next occurrence (e.g., monthly repeat where next month doesn't have the day, or end date is too soon after this instance)
                    // Treat as deleting the entire series from this point
                    transactions = transactions.filter(tx => tx.id !== transactionToDeleteId);
                    showMessage('This was the last or only occurrence. Transaction deleted!');
                }
            } else {
                // Case 2: Deleting a future instance of a recurring transaction
                // 1. End the original recurring transaction one day before the instance being deleted
                const newOriginalTxEndDate = new Date(instanceDate);
                newOriginalTxEndDate.setDate(newOriginalTxEndDate.getDate() - 1); 
                originalTx.endDate = formatDate(newOriginalTxEndDate);

                // 2. Create a new recurring transaction that starts *after* the deleted instance
                const newRepeatingTxStartDate = getNextOccurrence(instanceDate, originalTx.repeat);

                if (newRepeatingTxStartDate) {
                    const newRepeatingTx = {
                        id: Date.now(), // New unique ID for the new series
                        type: originalTx.type,
                        name: originalTx.name,
                        amount: originalTx.amount,
                        date: formatDate(newRepeatingTxStartDate), // New series starts from the next occurrence
                        repeat: originalTx.repeat,
                        adjustForNonWorkingDays: originalTx.adjustForNonWorkingDays,
                        endDate: originalTxSeriesEndDate, // IMPORTANT: Carry over the original series end date
                        parentId: originalTx.parentId || originalTx.id // Link new series to its parent (or original if no parent)
                    };
                    transactions.push(newRepeatingTx);
                    showMessage('This event deleted. Future events will continue after this date (transaction split).');
                } else {
                    // If no next occurrence after the deleted instance, just end the original transaction
                    showMessage('This event deleted. No further occurrences.');
                }
            }

            localStorage.setItem('transactions', JSON.stringify(transactions));
            closeModal(deleteConfirmationModal);
            updateCalendarView();
            renderOverview();
        });

        deleteThisAndFutureEventsBtn.addEventListener('click', () => {
            const clickedTx = transactions.find(tx => tx.id === transactionToDeleteId);
            if (!clickedTx) {
                showMessage('Error: Transaction not found.');
                return;
            }

            const instanceDate = parseDate(transactionToDeleteInstanceDate);
            // Find the root ID of the clicked transaction's series
            const rootId = findRootTransactionId(clickedTx.id);

            // Filter out transactions that should be deleted or have their end date adjusted
            const updatedTransactions = transactions.filter(tx => {
                // Check if this 'tx' is part of the same logical recurring series
                let isRelated = false;
                let currentCheckTx = tx;
                while (currentCheckTx) {
                    if (currentCheckTx.id === rootId) {
                        isRelated = true;
                        break;
                    }
                    if (currentCheckTx.parentId) {
                        currentCheckTx = transactions.find(t => t.id === currentCheckTx.parentId);
                    } else {
                        break;
                    }
                }
                
                // If the transaction is not related to the root series, keep it.
                // Also, if the transaction IS the root, but it's not the one we clicked, we need to handle it.
                if (!isRelated && tx.id !== rootId) {
                    return true; 
                }

                const txStartDate = parseDate(tx.date);

                // Logic for related transactions:
                // If the transaction starts AFTER the instance date of the one we're deleting, remove it.
                if (txStartDate.getTime() > instanceDate.getTime()) {
                    return false; // Filter out
                }
                
                // If the transaction starts ON or BEFORE the instance date, we might need to adjust its end date.
                // This applies to the original series that the clicked instance belongs to.
                // We only modify the end date if the transaction's current end date is after the new proposed end date
                // (or if it has no end date).
                if (tx.id === clickedTx.id || (isRelated && txStartDate.getTime() <= instanceDate.getTime())) {
                    const newProposedEndDate = formatDate(new Date(instanceDate.setDate(instanceDate.getDate() - 1)));
                    if (!tx.endDate || parseDate(tx.endDate).getTime() > parseDate(newProposedEndDate).getTime()) {
                        tx.endDate = newProposedEndDate;
                    }
                }
                
                return true; // Keep the transaction (potentially with modified endDate)
            });

            transactions = updatedTransactions;
            localStorage.setItem('transactions', JSON.stringify(transactions));
            showMessage('Transaction and all future occurrences deleted!');
            closeModal(deleteConfirmationModal);
            updateCalendarView();
            renderOverview();
        });

        closeDeleteConfirmationModalBtn.addEventListener('click', () => closeModal(deleteConfirmationModal));
        deleteConfirmationModal.addEventListener('click', (e) => {
            if (e.target === deleteConfirmationModal) {
                closeModal(deleteConfirmationModal);
            }
        });


        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchBankHolidays(); // Fetch bank holidays on load
            // Set Overview as the default active tab
            switchTab('overview');
            // Only render monthly calendar initially, daily view will be rendered on toggle
            updateCalendarView(); 
        });

    </script>
</body>
</html>
