<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cost of Living Calculator</title>

    <!-- Favicon for browsers -->
    <link rel="icon" type="image/png" href="https://img.icons8.com/ios-filled/100/6366f1/money-bag.png">
    <link rel="shortcut icon" type="image/png" href="https://img.icons8.com/ios-filled/100/6366f1/money-bag.png">

    <!-- Apple Touch Icon and Web App Meta Tags for iOS Home Screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CoL Calc">
    <!-- Explicitly specify size for apple-touch-icon -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/100/6366f1/money-bag.png">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text color */
            overflow-x: hidden; /* Prevent horizontal scrolling */
            overflow-y: scroll; /* Always show vertical scrollbar to prevent layout shifts */
            touch-action: manipulation; /* Prevent double tap to zoom */
        }
        /* New style to prevent body scrolling when modal is open */
        body.modal-open {
            overflow: hidden;
            position: fixed; /* Prevent scrolling when modal is open */
            width: 100%; /* Maintain width when scrollbar is removed */
        }
        .container {
            max-width: 1200px; /* Wider container for calendar */
            margin: 2rem auto; /* Default margin for desktop */
            padding: 1.5rem; /* Default padding */
            background-color: #ffffff;
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); /* Softer shadow */
        }
        /* Responsive padding and margin for container */
        @media (max-width: 767px) { /* For screens smaller than md (768px) */
            .container {
                padding: 1rem; /* Smaller padding on mobile */
                margin-top: 1rem; /* Reduced top margin on mobile */
                margin-bottom: 1rem; /* Reduced bottom margin on mobile */
            }
        }
        /* General section title style */
        .section-title {
            font-size: 2rem; /* Increased slightly */
            font-weight: 700; /* Bold */
            color: #1e293b; /* Even darker title color */
            margin-bottom: 1.5rem; /* Default margin for when it's a standalone section title */
            /* text-align: center; Removed, now controlled by utility classes on h1 */
        }
        /* Specific adjustments for section-title when it's part of the nav-header */
        .nav-header .section-title {
            margin-bottom: 0; /* Remove vertical margin when inside the header flex container */
            /* text-align: center; Removed, now controlled by utility classes on h1 */
        }

        /* Adjusted heading sizes */
        h2 { /* Applies to: Welcome to..., Pay Estimator, Universal Credit Estimator, Add Transaction for..., Edit Transaction, Update Current Balance, Add Estimated Pay..., Add Estimated UC..., Menu */
            font-size: 1.5rem; /* text-xl */
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            text-align: left; /* Ensure left alignment for h2s */
        }
        h3 { /* Applies to: Current Balance, Amount Available..., Upcoming Payment, Today's Transactions, Existing Transactions, Add New Transaction, 1. Update Your Balance... */
            font-size: 1.25rem; /* text-lg */
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }


        .input-group label {
            font-weight: 500;
            color: #475569;
        }
        .input-group input, .input-group select {
            border: 1px solid #cbd5e1; /* Light gray border */
            border-radius: 0.5rem; /* Rounded input fields */
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #6366f1; /* Indigo focus color */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Soft focus ring */
        }
        .btn-primary {
            background-color: #6366f1; /* Indigo button */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #4f46e5; /* Darker indigo on hover */
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #e2e8f0; /* Light gray button */
            color: #475569;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-secondary:hover {
            background-color: #cbd5e1; /* Darker gray on hover */
            transform: translateY(-1px);
        }
        .btn-delete {
            background-color: #ef4444; /* Red delete button */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.8rem;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-delete:hover {
            background-color: #dc2626; /* Darker red on hover */
        }
        .btn-edit {
            background-color: #3b82f6; /* Blue edit button */
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            font-size: 0.8rem;
            transition: background-color 0.2s ease-in-out;
            /* margin-left: 0.5rem; Removed, now handled by gap on parent */
        }
        .btn-edit:hover {
            background-color: #2563eb; /* Darker blue on hover */
        }
        .list-item {
            background-color: #f8fafc; /* Lighter background for list items */
            border: 1px solid #e2e8f0; /* Lighter border */
            border-radius: 0.75rem; /* Rounded list items */
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        .summary-card {
            background-color: #e0f2fe; /* Light blue for summary */
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        .summary-card.positive {
            background-color: #d1fae5; /* Green for positive cash flow */
            color: #065f46;
        }
        .summary-card.negative {
            background-color: #fee2e2; /* Red for negative cash flow */
            color: #991b1b;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible; /* Ensure visibility when shown */
        }

        /* Calendar specific styles */
        .calendar-header {
            display: grid; /* Changed to grid */
            grid-template-columns: 1fr auto 1fr; /* For centering title on desktop */
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
        }
        /* New classes for calendar grid elements to allow for distinct styling and zooming */
        .calendar-grid-header-row,
        .calendar-grid-days {
            display: grid;
            grid-template-columns: repeat(7, minmax(80px, 1fr)); /* Default for monthly view */
            gap: 0.5rem;
        }
        .calendar-grid-header-row {
            margin-bottom: 0.5rem; /* Space between headers and days */
        }

        /* Wrapper for zoomable content - removed manual zoom, but keeping wrapper for structure */
        #calendarContentWrapper {
            /* transform-origin: top left; */ /* Removed */
            /* transition: transform 0.2s ease-in-out; */ /* Removed */
        }

        .calendar-day-header {
            /* Removed text-align: center; as flexbox will handle it */
            font-weight: 600;
            color: #475569;
            padding: 0.75rem; /* Match calendar-day padding */
            border: 1px solid transparent; /* Mimic calendar-day border for box model consistency */
            border-radius: 0.75rem; /* Match calendar-day border-radius for consistency */
            box-sizing: border-box; /* Ensure padding/border included in width */
            min-width: 0; /* Allow shrinking in grid */
            
            /* Added Flexbox for robust centering */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .calendar-day {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem; /* Ensure this is consistent */
            min-height: 120px; /* Increased height for content */
            display: flex;
            flex-direction: column;
            align-items: center; /* Changed from flex-start to center for alignment */
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            position: relative; /* For cumulative total positioning */
            min-width: 0; /* Allow grid items to shrink */
            box-sizing: border-box; /* Include padding/border in width */
        }
        .calendar-day:hover {
            background-color: #eff6ff; /* Light blue on hover */
            border-color: #93c5fd; /* Light blue border on hover */
        }
        .calendar-day.today {
            border: 2px solid #6366f1; /* Highlight today */
            background-color: rgba(224, 231, 255, 0.5); /* Lighter indigo background with transparency */
        }
        .calendar-day.inactive {
            background-color: #f1f5f9;
            color: #94a3b8;
            cursor: not-allowed;
        }
        .calendar-day-number {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #1e293b;
        }
        /* Adjusted font size for monthly view content */
        .calendar-day-transactions {
            font-size: 0.5rem; /* Set font size to 0.5rem */
            color: #64748b;
            flex-grow: 1; /* Allows content to take available space */
            width: 100%;
            overflow-y: auto; /* Enable scrolling for many transactions */
            max-height: 60px; /* Limit height of transaction list */
            text-align: center; /* Center transaction text */
        }
        .calendar-day-transactions p {
            margin-bottom: 0.2rem;
            white-space: nowrap; /* Prevent wrapping */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Show ellipsis */
        }
        .calendar-day-cumulative {
            font-size: 0.5rem; /* Default for mobile */
            color: #64748b;
            flex-grow: 1; /* Allows content to take available space */
            width: 100%;
            overflow-y: auto; /* Enable scrolling for many transactions */
            max-height: 60px; /* Limit height of transaction list */
            text-align: center; /* Center transaction text */
        }
        /* Desktop: Increase font size for cumulative balance */
        @media (min-width: 768px) {
            .calendar-day-cumulative {
                font-size: 1rem; /* Larger font for desktop */
            }
        }
        .calendar-day-cumulative.positive {
            color: #065f46; /* Green for positive */
        }
        .calendar-day-cumulative.negative {
            color: #991b1b; /* Red for negative */
        }

        /* Daily View specific styles */
        .calendar-grid-days.daily-view-active { /* New class for daily view container */
            position: relative;
            overflow: hidden;
            height: 400px; /* Fixed height for daily view container to prevent height jump */
            display: block; /* Override grid display for daily view */
        }
        .daily-view-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.2s ease-out; /* Smooth snap-back transition */
            display: flex;
            justify-content: center;
            align-items: center;
            box-sizing: border-box; /* Include padding/border in width/height */
        }
        .daily-view-content > .calendar-day { /* Target the actual day element inside the content wrapper */
            width: 100%;
            height: 100%; /* Make it fill the parent */
            box-sizing: border-box;
            cursor: default; /* Remove pointer cursor for the whole day */
        }

        .calendar-daily-view-container .calendar-day {
            min-height: 300px; /* Larger height for daily view */
            padding: 1.5rem;
            /* Changed to column flex for internal layout */
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Align content to the top */
            align-items: stretch; /* Stretch children to fill width */
            cursor: default; /* Remove pointer cursor for the whole day */
        }
        .calendar-daily-view-container .calendar-day-transactions {
            max-height: 180px; /* Set a max height for the scrollable area */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
            margin-bottom: 1rem;
            font-size: 0.75rem; /* Revert to original size for daily view */
            text-align: left; /* Align text to the left for daily view transactions */
        }
        .calendar-daily-view-container .calendar-day-transactions .modal-transaction-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 0.5rem;
        }
        .calendar-daily-view-container .calendar-day-transactions .modal-transaction-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .calendar-daily-view-container .calendar-day-transactions .text-xs {
            font-size: 0.7rem; /* Slightly smaller for details */
        }
        .calendar-daily-view-container .calendar-day-cumulative {
            align-self: flex-start; /* Position at bottom left for daily view */
            font-size: 1.2rem; /* Revert to original size for daily view */
            margin-top: 1rem;
        }
        /* Changed from add-transaction-daily-btn to btn-primary */
        .calendar-daily-view-container .btn-primary {
            width: 100%;
            margin-top: auto; /* Pushes the button to the bottom */
            touch-action: manipulation; /* Ensure touch events are handled directly */
        }


        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2); /* More transparent */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
            /* Allow internal scrolling for modal content */
            max-height: 90vh; /* Limit height to viewport height */
            overflow-y: auto; /* Enable scrolling within the modal */
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }
        .modal-close-btn:hover {
            color: #1e293b;
        }
        .modal-transaction-list {
            max-height: 200px; /* Limit height of transactions in modal */
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
        }
        .modal-transaction-item:last-child {
            border-bottom: none;
        }

        /* Edit Modal specific styles */
        .edit-scope-options label {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }
        .edit-scope-options input[type="radio"] {
            margin-right: 0.5rem;
        }

        /* Tab styles */
        .tab-buttons {
            display: flex;
            justify-content: center; /* Centered on desktop */
            margin-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            border-bottom: 2px solid transparent;
            transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .tab-button.active {
            color: #6366f1;
            border-color: #6366f1;
        }
        .tab-content {
            display: none;
            width: 100%; /* Ensure it takes full available width */
            box-sizing: border-box; /* Include padding/border in width */
            overflow-x: hidden; /* Prevent horizontal scroll within the tab content */
        }
        .tab-content.active {
            display: block;
        }

        /* Overview specific styles */
        .overview-card {
            background-color: #fff;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        .overview-card h3 {
            font-size: 1.25rem; /* Adjusted for consistency */
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        .overview-card p {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        .overview-card .value {
            font-weight: 700;
            color: #334155;
        }
        .overview-card .value.positive {
            color: #065f46;
        }
        .overview-card .value.negative {
            color: #991b1b;
        }
        .overview-transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px dashed #e2e8f0;
            font-size: 0.9rem;
        }
        .overview-transaction-item:last-child {
            border-bottom: none;
        }

        /* Pay Estimator specific styles */
        .pay-estimator-result, .uc-calculator-result {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1.5rem;
        }
        .pay-estimator-result p, .uc-calculator-result p {
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .pay-estimator-result .label, .uc-calculator-result .label {
            font-weight: 500;
            color: #475569;
        }
        .pay-estimator-result .value, .uc-calculator-result .value {
            font-weight: 600;
            color: #1e293b;
        }
        .pay-estimator-result .net-pay, .uc-calculator-result .net-payment {
            font-size: 1.25rem;
            font-weight: 700;
            color: #065f46; /* Green for net pay */
            margin-top: 1rem;
            border-top: 1px solid #cbd5e1;
            padding-top: 1rem;
        }

        /* Universal Credit specific styles */
        .uc-input-group {
            margin-bottom: 1rem;
        }
        .uc-input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #475569;
        }
        .uc-input-group input[type="number"],
        .uc-input-group select {
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            transition: border-color 0.2s ease-in-out;
        }
        .uc-input-group input[type="radio"] {
            margin-right: 0.5rem;
        }
        .uc-input-group .radio-option {
            display: inline-flex;
            align-items: center;
            margin-right: 1rem;
        }
        .uc-input-group .with-button {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .uc-input-group .with-button input {
            flex-grow: 1;
        }
        .uc-input-group .import-btn {
            background-color: #4f46e5; /* Darker indigo for import button */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem; /* text-sm */
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            white-space: nowrap; /* Prevent text wrapping */
        }
        .uc-input-group .import-btn:hover {
            background-color: #3730a3; /* Even darker indigo on hover */
            transform: translateY(-1px);
        }

        .uc-calculator-result .negative {
            color: #991b1b;
        }
        /* Getting Started specific styles */
        .getting-started-section {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .getting-started-section h3 {
            font-size: 1.25rem; /* Adjusted for consistency */
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.75rem;
        }
        .getting-started-section p {
            font-size: 0.95rem;
            color: #475569;
            line-height: 1.5;
        }

        /* Responsive Calendar Adjustments for Monthly View on Mobile */
        @media (max-width: 767px) {
            .calendar-grid-header-row,
            .calendar-grid-days {
                grid-template-columns: repeat(7, 1fr); /* Force equal width columns on mobile */
                gap: 0.4rem; /* Increased gap slightly for better separation */
            }
            .calendar-day {
                min-height: 100px; /* Slightly reduce height for mobile monthly view */
                padding: 0.5rem; /* Reduce padding */
            }
            .calendar-day-number {
                font-size: 0.9rem; /* Smaller day number */
            }
            .calendar-day-transactions,
            .calendar-day-cumulative {
                font-size: 0.5rem; /* Smaller transaction text */
                max-height: 45px; /* Adjust max height for transaction list */
            }
            .nav-header .section-title {
                font-size: 1.5rem; /* Slightly larger for mobile header */
            }
            /* Mobile modal heading sizes */
            #mobileNavModal .modal-content h2 {
                font-size: 1.5rem; /* Keep consistent with other h2 */
            }

            /* Calendar Header for Mobile (buttons hidden) */
            .calendar-header {
                grid-template-columns: auto; /* Only one column for the title */
                justify-content: center; /* Center the title */
            }
        }

        /* Navigation Menu Styles */
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .menu-toggle-btn {
            display: none; /* Hidden by default on desktop */
            background: none;
            border: none;
            color: #6366f1;
            cursor: pointer;
            padding: 0.5rem; /* Reduced padding for a tighter button */
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out;
            /* Style for SVG icon */
            align-items: center;
            justify-content: center;
            width: 48px; /* Larger width for icon */
            height: 48px; /* Larger height for icon */
        }
        .menu-toggle-btn:hover {
            background-color: #e0e7ff;
        }

        /* Hamburger icon SVG styling */
        .menu-toggle-btn svg {
            width: 32px; /* Adjust size of the SVG icon */
            height: 32px;
            fill: currentColor; /* Use button's text color for the icon */
        }

        /* Desktop: Tab buttons are always visible, hamburger is hidden */
        .tab-buttons {
            display: flex; /* Always flex on desktop */
            justify-content: center; /* Centered on desktop */
            margin-bottom: 1rem;
            border-bottom: 2px solid #e2e8f0;
        }

        @media (max-width: 767px) {
            .menu-toggle-btn {
                display: flex; /* Show menu button on mobile */
            }
            .tab-buttons {
                display: none; /* Hide tab buttons on mobile */
            }
            /* Mobile Navigation Modal specific styles */
            #mobileNavModal .modal-content {
                width: 90%;
                max-width: 400px; /* Slightly narrower for mobile menu */
                padding: 1.5rem;
            }
            .mobile-nav-buttons {
                display: flex;
                flex-direction: column;
                gap: 0.75rem; /* Space between buttons */
            }
            .mobile-nav-button {
                background-color: #6366f1; /* Indigo for buttons, matching btn-primary */
                color: white; /* White text */
                padding: 0.75rem 1.5rem; /* Match btn-primary padding */
                border-radius: 0.5rem; /* Match btn-primary border-radius */
                font-size: 1rem; /* Match btn-primary font size */
                font-weight: 600; /* Match btn-primary font weight */
                text-align: center;
                transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Match btn-primary shadow */
            }
            .mobile-nav-button:hover {
                background-color: #4f46e5; /* Darker indigo on hover, matching btn-primary */
                transform: translateY(-1px);
            }
            .mobile-nav-button.active {
                background-color: #4f46e5; /* Darker indigo for active button */
                color: white;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-header">
            <!-- Updated title for mobile view with line break and centered alignment -->
            <!-- Removed the line break for mobile and adjusted font size in CSS -->
            <h1 class="section-title flex-grow text-center">
                The Cost of Living Calculator
            </h1>
            <button id="menuToggleBtn" class="menu-toggle-btn">
                <!-- Hamburger Icon SVG -->
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                </svg>
            </button>
        </div>

        <!-- Tab Buttons Container (Desktop Only) -->
        <!-- This div now only contains the desktop tab buttons and is hidden on mobile via CSS -->
        <div class="tab-buttons" id="desktopTabButtons">
            <button class="tab-button" data-tab="getting-started">Getting Started</button>
            <button class="tab-button active" data-tab="overview">Overview</button>
            <button class="tab-button" data-tab="calendar">Calendar</button>
            <button class="tab-button" data-tab="pay-estimator">Pay Estimator</button>
            <button class="tab-button" data-tab="universal-credit">UC Estimator</button>
        </div>

        <!-- Getting Started Tab Content (New Tab) -->
        <div id="getting-startedTabContent" class="tab-content">
            <h2>Welcome to The Cost of Living Calculator!</h2>
            <p class="text-gray-600 mb-6">This tool helps you manage your finances by tracking income and expenses, estimating future cash flow, and calculating potential earnings and benefits. Here's a quick guide to help you get started and make the most of the app:</p>

            <div class="getting-started-section">
                <h3>1. Update Your Balance (Overview Tab)</h3>
                <p>First, navigate to the **Overview** tab. Here, you'll find a section to "Update Balance". Enter your current bank balance to ensure all future calculations are accurate. This sets your starting point for understanding your cash flow.</p>
            </div>

            <div class="getting-started-section">
                <h3>2. Enter Your Regular Income and Outgoings (Calendar Tab)</h3>
                <p>Next, switch to the **Calendar** tab. Click on any day to add your regular income (like salary or benefits) and recurring expenses (like rent, bills, or subscriptions). You can set these transactions to repeat daily, weekly, bi-weekly, four-weekly, or monthly. By doing this, the calendar will automatically project your future balance, showing you exactly where your money is expected to go and when.</p>
            </div>

            <div class="getting-started-section">
                <h3>3. Estimate Your Pay (Pay Estimator Tab)</h3>
                <p>If you want to understand your take-home pay, visit the **Pay Estimator** tab. Input your pay rate (hourly, daily, weekly, monthly, or annually) and frequency. The calculator will provide a breakdown of your estimated gross pay, National Insurance, and Income Tax deductions, giving you your net pay. You can then easily add this estimated net pay as an "income" transaction to your Calendar.</p>
            </div>

            <div class="getting-started-section">
                <h3>4. Estimate Your Universal Credit (UC Estimator Tab)</h3>
                <p>For a simplified estimate of your potential Universal Credit payment, go to the **UC Estimator** tab. Enter details about your household, children, disability status, monthly rent, and importantly, your monthly net earnings. You can quickly import your estimated net earnings directly from the Pay Estimator. The calculated UC payment can then be added to your Calendar to see its impact on your overall finances.</p>
            </div>

            <p class="text-gray-600 mt-6">By following these steps, you'll gain a clear picture of your financial situation, helping you plan and manage your money effectively!</p>
        </div>

        <!-- Overview Tab Content -->
        <div id="overviewTabContent" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Combined Current Balance and Amount Available for Spending -->
                <div class="overview-card md:col-span-2">
                    <h3>Your Current Financial Snapshot</h3>
                    <div class="flex flex-col gap-4"> <!-- New flex container for the balance rows -->
                        <!-- Current Balance Row -->
                        <div class="flex justify-between items-center w-full">
                            <p class="text-xl text-left">
                                <span class="font-semibold">Current Balance:</span> <span id="overviewCurrentBalance" class="value font-bold">£0.00</span>
                            </p>
                            <button id="updateBalanceBtn" class="btn-primary px-3 py-1 text-sm">Update Balance</button>
                        </div>
                        <!-- Amount Available Row -->
                        <div class="text-left relative">
                            <p class="inline-block">
                                <span class="font-semibold">Amount Available:</span> <span id="overviewLowestBalance">£0.00</span>
                            </p>
                            <button id="amountAvailableHelpBtn" class="ml-2 text-indigo-500 hover:text-indigo-700 focus:outline-none absolute -top-1 md:relative md:top-0">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 inline-block align-middle">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="overview-card md:col-span-2">
                    <h3>Upcoming Payment</h3>
                    <!-- Added mt-4 for consistent spacing from h3 -->
                    <p id="overviewNextIncomeStatement" class="text-sm text-gray-600 text-left mt-4"></p>
                </div>

                <!-- New grid for Today's Transactions and Monthly Income vs. Expenses -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:col-span-2">
                    <div class="overview-card">
                        <h3>Today's Transactions</h3>
                        <!-- Removed mt-4 from this div, added pt-0 to p inside for spacing control -->
                        <div id="overviewTodaysTransactionsList">
                            <!-- Changed py-4 to pt-0 for the p tag inside -->
                            <p class="text-gray-500 text-left pt-0 text-sm">No transactions for today.</p>
                        </div>
                    </div>
                    <div class="overview-card">
                        <h3>Monthly Income vs. Expenses</h3>
                        <div id="pieChartContainer" class="relative w-full h-64">
                            <canvas id="incomeExpensePieChart" class="w-full h-full"></canvas>
                            <!-- Removed px-6 pt-6 for alignment, inset-0 and flex properties handle positioning -->
                            <p id="pieChartDescription" class="absolute inset-0 flex items-start justify-start bg-white bg-opacity-90 rounded-lg text-gray-500 text-left text-sm">
                                This chart illustrates the proportion of your income versus expenses for the current month. Add transactions to see your financial breakdown.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Tab Content -->
        <div id="calendarTabContent" class="tab-content">
            <!-- Calendar Header (Month/Year and Nav Buttons) -->
            <div class="calendar-header mb-4 p-2">
                <!-- Added md:block to show on medium screens and up, hidden by default on small screens -->
                <button id="prevMonthBtn" class="btn-secondary px-4 py-2 rounded-lg justify-self-start hidden md:block">&lt; Prev</button>
                <h2 id="currentMonthYear" class="text-xl font-semibold text-gray-800 text-center flex-grow"></h2>
                <!-- Added md:block to show on medium screens and up, hidden by default on small screens -->
                <button id="nextMonthBtn" class="btn-secondary px-4 py-2 rounded-lg justify-self-end hidden md:block">Next &gt;</button>
            </div>

            <!-- Calendar View Toggle Switch -->
            <div class="flex justify-center items-center mb-4">
                <span class="text-sm text-gray-600 mr-2">Monthly View</span>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="calendarViewToggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                </label>
                <span class="text-sm text-gray-600 ml-2">Daily View</span>
            </div>

            <!-- Calendar Grid Container (removed overflow-x-auto) -->
            <!-- Adjusted padding for mobile: px-2 py-4 -->
            <div class="mb-8 px-2 py-4 md:p-6 bg-gray-50 rounded-xl shadow-inner">
                <div id="calendarContentWrapper">
                    <!-- The header row is now explicitly a grid for alignment -->
                    <div class="calendar-grid-header-row">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                    </div>
                    <div id="calendarDays" class="calendar-grid-days"></div>
                </div>
            </div>
        </div>

        <!-- Pay Estimator Tab Content -->
        <div id="pay-estimatorTabContent" class="tab-content">
            <h2>Pay Estimator</h2>
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="payRateAmount" class="block text-sm mb-1">Rate Amount (£):</label>
                        <input type="number" id="payRateAmount" placeholder="e.g., 15.00" step="0.01" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="payRateUnit" class="block text-sm mb-1">Rate Unit:</label>
                        <select id="payRateUnit" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="hourly">Hourly</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="annually">Annually</option>
                            <option value="project">Per Project</option>
                        </select>
                    </div>
                    <div class="input-group" id="contractedUnitsGroup">
                        <label for="contractedUnits" class="block text-sm mb-1" id="contractedUnitsLabel">Hours per Week:</label>
                        <input type="number" id="contractedUnits" placeholder="e.g., 40" step="0.1" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="payFrequency" class="block text-sm mb-1">Pay Frequency:</label>
                        <select id="payFrequency" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="weekly">Weekly</option>
                            <option value="bi-weekly">Bi-weekly</option>
                            <option value="four-weekly">Four Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="annually">Annually</option>
                        </select>
                    </div>
                </div>
                <button id="calculatePayBtn" class="btn-primary w-full">Calculate Pay</button>
            </div>

            <div id="payEstimatorResults" class="pay-estimator-result hidden">
                <p><span class="label">Gross Pay:</span> <span id="grossPayResult" class="value">£0.00</span></p>
                <p><span class="label">National Insurance:</span> <span id="niDeductionResult" class="value">£0.00</span></p>
                <p><span class="label">Income Tax:</span> <span id="taxDeductionResult" class="value">£0.00</span></p>
                <p class="net-pay"><span class="label">Net Pay:</span> <span id="netPayResult" class="value">£0.00</span></p>
                <button id="addEstimatedPayToCalendarBtn" class="btn-primary w-full mt-4">Add Net Pay to Calendar</button>
            </div>
        </div>

        <!-- Universal Credit Tab Content (New Tab) -->
        <div id="universal-creditTabContent" class="tab-content">
            <h2>Universal Credit Estimator</h2>
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner mb-6">
                <p class="text-sm text-gray-600 mb-4">This is a simplified estimator based on UK 2024/2025 Universal Credit rates. It does not account for all complex rules, deductions, or other benefits.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="uc-input-group md:col-span-2">
                        <label class="block text-sm mb-1">Are you claiming as a single person or a couple?</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="radio-option">
                                <input type="radio" name="ucClaimStatus" value="single" checked> Single
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="ucClaimStatus" value="couple"> Couple
                            </label>
                        </div>
                    </div>

                    <div class="uc-input-group" id="ucAgeGroupSingle">
                        <label class="block text-sm mb-1">Your Age Group:</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="radio-option">
                                <input type="radio" name="ucAge" value="under25" checked> Under 25
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="ucAge" value="25over"> 25 or Over
                            </label>
                        </div>
                    </div>

                    <div class="uc-input-group hidden" id="ucAgeGroupCouple">
                        <label class="block text-sm mb-1">Age Group (Person 1):</label>
                        <div class="flex flex-wrap gap-4 mb-2">
                            <label class="radio-option">
                                <input type="radio" name="ucAgeP1" value="under25" checked> Under 25
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="ucAgeP1" value="25over"> 25 or Over
                            </label>
                        </div>
                        <label class="block text-sm mb-1">Age Group (Person 2):</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="radio-option">
                                <input type="radio" name="ucAgeP2" value="under25" checked> Under 25
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="ucAgeP2" value="25over"> 25 or Over
                            </label>
                        </div>
                    </div>

                    <div class="uc-input-group">
                        <label for="ucNumChildren" class="block text-sm mb-1">Number of Children:</label>
                        <input type="number" id="ucNumChildren" value="0" min="0" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="uc-input-group">
                        <label for="ucChildBornBefore2017" class="block text-sm mb-1">Is at least one child born before 6 April 2017?</label>
                        <input type="checkbox" id="ucChildBornBefore2017" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <span class="text-xs text-gray-500 ml-2">(If checked, the higher child element will apply to one child born before this date, and the standard rate to any other children.)</span>
                    </div>

                    <div class="uc-input-group">
                        <label for="ucMonthlyRent" class="block text-sm mb-1">Monthly Rent (£):</label>
                        <input type="number" id="ucMonthlyRent" value="0.00" step="0.01" min="0" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div class="uc-input-group">
                        <label for="ucDisabilityStatus" class="block text-sm mb-1">Disability Status:</label>
                        <select id="ucDisabilityStatus" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="none">None</option>
                            <option value="lcw">Limited Capability for Work (LCW)</option>
                            <option value="lcwra">Limited Capability for Work & Work-Related Activity (LCWRA)</option>
                        </select>
                    </div>

                    <div class="uc-input-group md:col-span-2">
                        <label for="ucMonthlyEarnings" class="block text-sm mb-1">Monthly Net Earnings (after tax/NI) (£):</label>
                        <div class="with-button">
                            <input type="number" id="ucMonthlyEarnings" value="0.00" step="0.01" min="0" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <button id="importPayEstimatorEarningsBtn" class="import-btn">Import from Pay Estimator</button>
                        </div>
                    </div>
                </div>
                <button id="calculateUCBtn" class="btn-primary w-full">Calculate Universal Credit</button>
            </div>

            <div id="ucCalculatorResults" class="uc-calculator-result hidden">
                <p><span class="label">Standard Allowance:</span> <span id="ucStandardAllowance" class="value">£0.00</span></p>
                <p><span class="label">Child Elements:</span> <span id="ucChildElements" class="value">£0.00</span></p>
                <p><span class="label">Disability Element:</span> <span id="ucDisabilityElement" class="value">£0.00</span></p>
                <p><span class="label">Housing Element:</span> <span id="ucHousingElement" class="value">£0.00</span></p>
                <p><span class="label">Total Elements:</span> <span id="ucTotalElements" class="value">£0.00</span></p>
                <p class="mt-4"><span class="label">Work Allowance Applied:</span> <span id="ucWorkAllowance" class="value">£0.00</span></p>
                <p><span class="label">Earnings Deduction:</span> <span id="ucEarningsDeduction" class="value">£0.00</span></p>
                <p class="net-payment"><span class="label">Estimated Monthly UC:</span> <span id="ucNetPayment" class="value">£0.00</span></p>
                <button id="addEstimatedUCtoCalendarBtn" class="btn-primary w-full mt-4">Add Estimated UC to Calendar</button>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeAddModalBtn">&times;</button>
            
            <!-- Add New Transaction Form -->
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <!-- Added mb-4 for spacing under the title -->
                <h3 class="text-center mb-4">Add New Transaction for <span id="addModalDate" class="font-normal"></span></h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="addTransactionType" class="block text-sm mb-1">Type:</label>
                        <select id="addTransactionType" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="addTransactionName" class="block text-sm mb-1">Name/Source:</label>
                        <input type="text" id="addTransactionName" placeholder="e.g., Rent, Salary, Initial Funds" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="addTransactionAmount" class="block text-sm mb-1">Amount (£):</label>
                        <input type="number" id="addTransactionAmount" placeholder="e.g., 1200.00" step="0.01" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group" id="addTransactionRepeatGroup">
                        <label for="addTransactionRepeat" class="block text-sm mb-1">Repeat:</label>
                        <select id="addTransactionRepeat" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="none">None</option>
                            <option value="daily">Every Day</option>
                            <option value="weekly">Every Week</option>
                            <option value="bi-weekly">Every Two Weeks</option>
                            <option value="four-weekly">Every Four Weeks</option>
                            <option value="monthly">Monthly (same day)</option>
                        </select>
                    </div>
                </div>
                <button id="addTransactionBtn" class="btn-primary w-full" touch-action="manipulation">Add Transaction</button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeEditModalBtn">&times;</button>
            <h2>Edit Transaction</h2>

            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="input-group">
                        <label for="editTransactionType" class="block text-sm mb-1">Type:</label>
                        <select id="editTransactionType" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="editTransactionName" class="block text-sm mb-1">Name/Source:</label>
                        <input type="text" id="editTransactionName" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group">
                        <label for="editTransactionAmount" class="block text-sm mb-1">Amount (£):</label>
                        <input type="number" id="editTransactionAmount" step="0.01" class="focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="input-group" id="editTransactionRepeatGroup">
                        <label for="editTransactionRepeat" class="block text-sm mb-1">Repeat:</label>
                        <select id="editTransactionRepeat" class="focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="none">None</option>
                            <option value="daily">Every Day</option>
                            <option value="weekly">Every Week</option>
                            <option value="bi-weekly">Every Two Weeks</option>
                            <option value="four-weekly">Every Four Weeks</option>
                            <option value="monthly">Monthly (same day)</option>
                        </select>
                    </div>
                </div>

                <button id="saveEditedTransactionBtn" class="btn-primary w-full" touch-action="manipulation">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Update Balance Modal -->
    <div id="updateBalanceModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeUpdateBalanceModalBtn">&times;</button>
            <h2>Update Current Balance</h2>
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <div class="input-group mb-4">
                    <label for="newBalanceAmount" class="block text-sm mb-1">Your Current Bank Balance (£):</label>
                    <input type="number" id="newBalanceAmount" placeholder="e.g., 1500.00" step="0.01" class="focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button id="saveBalanceBtn" class="btn-primary w-full" touch-action="manipulation">Save Balance</button>
            </div>
        </div>
    </div>

    <!-- Confirm Pay Add Modal (New Modal) -->
    <div id="confirmPayAddModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeConfirmPayAddModalBtn">&times;</button>
            <h2>Add Estimated Pay to Calendar</h2>
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <p class="mb-4 text-lg">Estimated Net Pay: <span id="modalEstimatedNetPay" class="font-bold text-green-700">£0.00</span></p>
                <div class="input-group mb-4">
                    <label for="nextPayDateInput" class="block text-sm mb-1">Next Pay Day:</label>
                    <input type="date" id="nextPayDateInput" class="focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="input-group mb-4">
                    <label for="confirmPayFrequencySelect" class="block text-sm mb-1">Repeat Frequency:</label>
                    <select id="confirmPayFrequencySelect" class="focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="weekly">Weekly</option>
                        <option value="bi-weekly">Bi-weekly</option>
                        <option value="four-weekly">Four Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="annually">Annually</option>
                    </select>
                </div>
                <button id="confirmAddPayBtn" class="btn-primary w-full" touch-action="manipulation">Confirm Add to Calendar</button>
            </div>
        </div>
    </div>

    <!-- Confirm UC Add Modal (New Modal) -->
    <div id="confirmUcAddModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeConfirmUcAddModalBtn">&times;</button>
            <h2>Add Estimated UC to Calendar</h2>
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <p class="mb-4 text-lg">Estimated Monthly UC: <span id="modalEstimatedUcPayment" class="font-bold text-green-700">£0.00</span></p>
                <div class="input-group mb-4">
                    <label for="nextUcPayDateInput" class="block text-sm mb-1">Next UC Payment Day:</label>
                    <input type="date" id="nextUcPayDateInput" class="focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="input-group mb-4">
                    <label for="confirmUcFrequencySelect" class="block text-sm mb-1">Repeat Frequency:</label>
                    <select id="confirmUcFrequencySelect" class="focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <button id="confirmAddUcBtn" class="btn-primary w-full" touch-action="manipulation">Confirm Add to Calendar</button>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation Modal (New) -->
    <div id="mobileNavModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeMobileNavModalBtn">&times;</button>
            <!-- Removed h2 "Menu" -->
            <div class="mobile-nav-buttons">
                <button class="mobile-nav-button" data-tab="getting-started">Getting Started</button>
                <button class="mobile-nav-button" data-tab="overview">Overview</button>
                <button class="mobile-nav-button" data-tab="calendar">Calendar</button>
                <button class="mobile-nav-button" data-tab="pay-estimator">Pay Estimator</button>
                <button class="mobile-nav-button" data-tab="universal-credit">UC Estimator</button>
            </div>
        </div>
    </div>

    <!-- Amount Available Help Modal -->
    <div id="amountAvailableHelpModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeAmountAvailableHelpModalBtn">&times;</button>
            <h2>Understanding 'Amount Available'</h2>
            <div class="p-4 bg-gray-50 rounded-xl shadow-inner">
                <p class="text-gray-700">This figure represents the lowest your projected balance will drop before your next expected income. It helps you understand how much you can comfortably spend without risking a negative balance before your next significant payment arrives.</p>
                <p class="text-gray-700 mt-4">The calculation considers your current balance and all your upcoming expenses and incomes up to the point of your next anticipated income transaction (up to 2 years in the future). If no future income is found, it will prompt you to add one.</p>
            </div>
        </div>
    </div>

    <!-- Message Box for notifications -->
    <div id="messageBox" class="message-box"></div>

    <script>
        // Function to show a temporary message box
        function showMessage(message, duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let balanceUpdates = JSON.parse(localStorage.getItem('balanceUpdates')) || []; // New storage for balance updates

        // UK Bank Holidays (YYYY-MM-DD format) - Will be fetched dynamically
        let bankHolidays = []; 

        // Fetch bank holidays from GOV.UK API
        async function fetchBankHolidays() {
            try {
                const response = await fetch('https://www.gov.uk/bank-holidays.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                // Extract dates for England and Wales
                bankHolidays = data['england-and-wales'].events.map(event => event.date);
                console.log('Bank holidays fetched:', bankHolidays);
                // Re-render calendar and overview after fetching holidays
                updateCalendarView();
                renderOverview();
            } catch (error) {
                console.error('Error fetching bank holidays:', error);
                showMessage('Failed to load bank holidays. Using pre-defined list if available.', 5000);
                // Fallback to a small pre-defined list if fetching fails, or keep it empty if no fallback
                // For now, keeping it empty as the previous hardcoded list was removed.
                // If a robust offline fallback is desired, it should be re-added here.
            }
        }


        const calendarDaysEl = document.getElementById('calendarDays');
        const calendarContentWrapper = document.getElementById('calendarContentWrapper'); // New wrapper for zoomable content
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const calendarGridHeaderRow = document.querySelector('.calendar-grid-header-row'); // Get the header row element

        // New Calendar View Variables
        let currentCalendarView = 'monthly'; // 'monthly' or 'daily'
        let currentDailyDate = new Date(); // Tracks the date for daily view

        // Tab Elements
        const desktopTabButtons = document.querySelectorAll('#desktopTabButtons .tab-button'); // Select desktop tab buttons
        const gettingStartedTabContent = document.getElementById('getting-startedTabContent'); // New tab content
        const calendarTabContent = document.getElementById('calendarTabContent');
        const overviewTabContent = document.getElementById('overviewTabContent');
        const payEstimatorTabContent = document.getElementById('pay-estimatorTabContent');
        const universalCreditTabContent = document.getElementById('universal-creditTabContent'); // New UC tab

        // Add Transaction Modal Elements
        const addTransactionModal = document.getElementById('addTransactionModal');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const addModalDateEl = document.getElementById('addModalDate');
        // const addModalTransactionList = document.getElementById('addModalTransactionList'); // Removed
        // const noAddModalTransactionsMessage = document.getElementById('noAddModalTransactionsMessage'); // Removed
        const addTransactionTypeInput = document.getElementById('addTransactionType');
        const addTransactionNameInput = document.getElementById('addTransactionName');
        const addTransactionAmountInput = document.getElementById('addTransactionAmount');
        const addTransactionRepeatInput = document.getElementById('addTransactionRepeat');
        const addTransactionRepeatGroup = document.getElementById('addTransactionRepeatGroup');
        const addTransactionBtn = document.getElementById('addTransactionBtn');

        // Edit Transaction Modal Elements
        const editTransactionModal = document.getElementById('editTransactionModal');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const editTransactionTypeInput = document.getElementById('editTransactionType');
        const editTransactionNameInput = document.getElementById('editTransactionName');
        const editTransactionAmountInput = document.getElementById('editTransactionAmount');
        const editTransactionRepeatInput = document.getElementById('editTransactionRepeat');
        const editTransactionRepeatGroup = document.getElementById('editTransactionRepeatGroup');
        const saveEditedTransactionBtn = document.getElementById('saveEditedTransactionBtn');

        // Overview Elements
        const overviewCurrentBalanceEl = document.getElementById('overviewCurrentBalance');
        const overviewNextIncomeStatementEl = document.getElementById('overviewNextIncomeStatement');
        const overviewLowestBalanceEl = document.getElementById('overviewLowestBalance');
        // const lowestBalanceDescriptionEl = document.getElementById('lowestBalanceDescription'); // Removed
        const overviewTodaysTransactionsListEl = document.getElementById('overviewTodaysTransactionsList');
        const updateBalanceBtn = document.getElementById('updateBalanceBtn');
        // Chart elements
        const incomeExpensePieChartCanvas = document.getElementById('incomeExpensePieChart');
        const pieChartDescription = document.getElementById('pieChartDescription'); // Changed from pieChartPlaceholder
        let incomeExpensePieChartInstance = null; // To hold the Chart.js instance


        // Update Balance Modal Elements
        const updateBalanceModal = document.getElementById('updateBalanceModal');
        const closeUpdateBalanceModalBtn = document.getElementById('closeUpdateBalanceModalBtn');
        const newBalanceAmountInput = document.getElementById('newBalanceAmount');
        const saveBalanceBtn = document.getElementById('saveBalanceBtn');

        // Pay Estimator Elements
        const payRateAmountInput = document.getElementById('payRateAmount');
        const payRateUnitSelect = document.getElementById('payRateUnit');
        const contractedUnitsGroup = document.getElementById('contractedUnitsGroup');
        const contractedUnitsLabel = document.getElementById('contractedUnitsLabel');
        const contractedUnitsInput = document.getElementById('contractedUnits');
        const payFrequencySelect = document.getElementById('payFrequency');
        const calculatePayBtn = document.getElementById('calculatePayBtn');
        const payEstimatorResultsDiv = document.getElementById('payEstimatorResults');
        const grossPayResultSpan = document.getElementById('grossPayResult');
        const niDeductionResultSpan = document.getElementById('niDeductionResult');
        const taxDeductionResultSpan = document.getElementById('taxDeductionResult');
        const netPayResultSpan = document.getElementById('netPayResult');
        const addEstimatedPayToCalendarBtn = document.getElementById('addEstimatedPayToCalendarBtn');

        // Confirm Pay Add Modal Elements
        const confirmPayAddModal = document.getElementById('confirmPayAddModal');
        const closeConfirmPayAddModalBtn = document.getElementById('closeConfirmPayAddModalBtn');
        const modalEstimatedNetPaySpan = document.getElementById('modalEstimatedNetPay');
        const nextPayDateInput = document.getElementById('nextPayDateInput');
        const confirmPayFrequencySelect = document.getElementById('confirmPayFrequencySelect');
        const confirmAddPayBtn = document.getElementById('confirmAddPayBtn'); 

        // Universal Credit Elements (New)
        const ucClaimStatusRadios = document.querySelectorAll('input[name="ucClaimStatus"]');
        const ucAgeGroupSingleDiv = document.getElementById('ucAgeGroupSingle');
        const ucAgeGroupCoupleDiv = document.getElementById('ucAgeGroupCouple');
        const ucAgeRadios = document.querySelectorAll('input[name="ucAge"]'); // For single claim
        const ucAgeP1Radios = document.querySelectorAll('input[name="ucAgeP1"]'); // For couple claim, person 1
        const ucAgeP2Radios = document.querySelectorAll('input[name="ucAgeP2"]'); // For couple claim, person 2
        const ucNumChildrenInput = document.getElementById('ucNumChildren');
        const ucChildBornBefore2017Checkbox = document.getElementById('ucChildBornBefore2017');
        const ucDisabilityStatusSelect = document.getElementById('ucDisabilityStatus');
        const ucMonthlyRentInput = document.getElementById('ucMonthlyRent');
        const ucMonthlyEarningsInput = document.getElementById('ucMonthlyEarnings');
        const calculateUCBtn = document.getElementById('calculateUCBtn');
        const ucCalculatorResultsDiv = document.getElementById('ucCalculatorResults');
        const ucStandardAllowanceSpan = document.getElementById('ucStandardAllowance');
        const ucChildElementsSpan = document.getElementById('ucChildElements');
        const ucDisabilityElementSpan = document.getElementById('ucDisabilityElement');
        const ucHousingElementSpan = document.getElementById('ucHousingElement');
        const ucTotalElementsSpan = document.getElementById('ucTotalElements');
        const ucWorkAllowanceSpan = document.getElementById('ucWorkAllowance');
        const ucEarningsDeductionSpan = document.getElementById('ucEarningsDeduction');
        const ucNetPaymentSpan = document.getElementById('ucNetPayment');
        const addEstimatedUCtoCalendarBtn = document.getElementById('addEstimatedUCtoCalendarBtn');
        const importPayEstimatorEarningsBtn = document.getElementById('importPayEstimatorEarningsBtn'); // New import button

        // Confirm UC Add Modal Elements (New)
        const confirmUcAddModal = document.getElementById('confirmUcAddModal');
        const closeConfirmUcAddModalBtn = document.getElementById('closeConfirmUcAddModalBtn');
        const modalEstimatedUcPaymentSpan = document.getElementById('modalEstimatedUcPayment');
        const nextUcPayDateInput = document.getElementById('nextUcPayDateInput');
        const confirmUcFrequencySelect = document.getElementById('confirmUcFrequencySelect');
        const confirmAddUcBtn = document.getElementById('confirmAddUcBtn');

        const calendarViewToggle = document.getElementById('calendarViewToggle'); // New toggle switch element
        const menuToggleBtn = document.getElementById('menuToggleBtn'); // New menu toggle button

        // Mobile Nav Modal Elements (New)
        const mobileNavModal = document.getElementById('mobileNavModal');
        const closeMobileNavModalBtn = document.getElementById('closeMobileNavModalBtn');
        const mobileNavButtons = document.querySelectorAll('#mobileNavModal .mobile-nav-button'); // Select buttons inside mobile nav modal

        // Amount Available Help Modal Elements
        const amountAvailableHelpBtn = document.getElementById('amountAvailableHelpBtn');
        const amountAvailableHelpModal = document.getElementById('amountAvailableHelpModal');
        const closeAmountAvailableHelpModalBtn = document.getElementById('closeAmountAvailableHelpModalBtn');


        let selectedDate = null; // Date of the day clicked on the calendar
        let editingTransactionId = null; // ID of the transaction being edited
        let editingTransactionInstanceDate = null; // The specific date of the instance being edited

        let estimatedNetPayValue = 0; // To store net pay from estimator
        let estimatedPayFrequencyValue = 'weekly'; // To store frequency from estimator
        let estimatedUcPaymentValue = 0; // To store UC payment from estimator

        // Global references for current and adjacent day elements in daily view
        let currentDailyContentEl = null;
        let adjacentDailyContentEl = null;
        
        // No longer need currentMonthContentEl and adjacentMonthContentEl as calendarDaysEl is directly manipulated.

        // Swipe/Scroll gesture tracking variables
        let touchStartX = 0;
        let touchStartY = 0; // New: Y-coordinate for touch start
        let touchCurrentX = 0;
        let touchCurrentY = 0; // New: Y-coordinate for current touch
        let isGestureActive = false; // New: True when a touch gesture is in progress
        let gestureType = 'none'; // New: 'none', 'scroll', 'swipe'
        const gestureThreshold = 10; // New: Minimum pixels to move to determine gesture type

        // Scrollbar width calculation for modal fix
        let scrollbarWidth = 0;
        function getScrollbarWidth() {
            const outer = document.createElement('div');
            outer.style.visibility = 'hidden';
            outer.style.overflow = 'scroll';
            outer.style.msOverflowStyle = 'scrollbar';
            document.body.appendChild(outer);
            const inner = document.createElement('div');
            outer.appendChild(inner);
            const width = outer.offsetWidth - inner.offsetWidth;
            outer.parentNode.removeChild(outer);
            return width;
        }

        // Generic modal open/close functions to handle scrollbar shift
        function openModal(modalElement) {
            if (scrollbarWidth === 0) {
                scrollbarWidth = getScrollbarWidth();
            }
            document.body.style.paddingRight = `${scrollbarWidth}px`;
            document.body.classList.add('modal-open');
            modalElement.classList.add('show');
        }

        function closeModal(modalElement) {
            modalElement.classList.remove('show');
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = ''; // Reset padding
        }


        // --- Date Utility Functions ---
        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getFirstDayOfMonth(year, month) {
            return new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday, etc.
        }

        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = (d.getMonth() + 1).toString().padStart(2, '0');
            const day = d.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseDate(dateString) {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day);
        }

        // Checks if a given date is a weekend (Sat/Sun) or a bank holiday
        function isWorkingDay(date) {
            const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
            if (dayOfWeek === 0 || dayOfWeek === 6) { // Weekend
                return false;
            }
            const formattedDate = formatDate(date);
            if (bankHolidays.includes(formattedDate)) { // Bank Holiday
                return false;
            }
            return true;
        }

        // Finds the next available working day, including the current date if it's a working day
        function getNextWorkingDay(date) {
            let currentCheckDate = new Date(date);
            currentCheckDate.setHours(0, 0, 0, 0); // Normalize to start of day

            while (!isWorkingDay(currentCheckDate)) {
                currentCheckDate.setDate(currentCheckDate.getDate() + 1);
            }
            return currentCheckDate;
        }

        /**
         * Calculates the cumulative balance up to a specific target date (inclusive).
         * This function now incorporates manual balance updates.
         * Returns the final balance.
         */
        function calculateBalanceUpToDate(targetDate) {
            const allTransactions = JSON.parse(localStorage.getItem('transactions')) || [];
            const balanceUpdates = JSON.parse(localStorage.getItem('balanceUpdates')) || [];

            targetDate.setHours(0, 0, 0, 0); // Normalize target date

            let cumulativeBalance = 0;
            let effectiveCalculationStartDate = null; // The actual date from which we start applying transactions
            let balanceUpdateOnTargetDate = false; // Flag to indicate if a balance update exists for the targetDate

            // 1. Find the most recent balance update on or before the targetDate
            const relevantBalanceUpdate = balanceUpdates
                .filter(update => parseDate(update.date).getTime() <= targetDate.getTime())
                .sort((a, b) => parseDate(b.date).getTime() - parseDate(a.date).getTime())[0];

            if (relevantBalanceUpdate) {
                cumulativeBalance = relevantBalanceUpdate.amount;
                effectiveCalculationStartDate = parseDate(relevantBalanceUpdate.date);
                effectiveCalculationStartDate.setHours(0,0,0,0);

                if (effectiveCalculationStartDate.getTime() === targetDate.getTime()) {
                    balanceUpdateOnTargetDate = true; // The balance for targetDate is explicitly set
                }
            } else {
                // No balance update found on or before targetDate.
                // Start from the earliest transaction date, or today if no transactions.
                if (allTransactions.length > 0) {
                    effectiveCalculationStartDate = allTransactions.reduce((minDate, t) => {
                        const txDate = parseDate(t.date);
                        return txDate < minDate ? txDate : minDate;
                    }, parseDate(allTransactions[0].date)); // Initialize with first transaction date
                    effectiveCalculationStartDate.setHours(0,0,0,0);
                } else {
                    // No balance updates and no transactions. Balance is 0.
                    return 0;
                }
            }

            // If the effective start date is after the target date, return the initial balance.
            // This handles cases where the only balance update is after the target date.
            if (effectiveCalculationStartDate.getTime() > targetDate.getTime()) {
                return cumulativeBalance;
            }

            // If there was a balance update *on* the target date, we don't need to iterate and add transactions for that day.
            // The `cumulativeBalance` is already the final balance for that day.
            if (balanceUpdateOnTargetDate) {
                return cumulativeBalance;
            }

            let currentDateIterator = new Date(effectiveCalculationStartDate);
            // If the balance update was *before* the target date, we need to start iterating from the day *after* the balance update.
            if (relevantBalanceUpdate && effectiveCalculationStartDate.getTime() < targetDate.getTime()) {
                currentDateIterator.setDate(currentDateIterator.getDate() + 1);
            }


            while (currentDateIterator.getTime() <= targetDate.getTime()) {
                let dailyNet = 0;
                const formattedCurrentDate = formatDate(currentDateIterator);

                allTransactions.forEach(t => {
                    const transactionStartDate = parseDate(t.date);
                    transactionStartDate.setHours(0,0,0,0);

                    // A transaction is relevant if it started on or before the current day
                    if (transactionStartDate.getTime() > currentDateIterator.getTime()) {
                        return; // Transaction hasn't started yet
                    }
                    // And it hasn't ended before the current day
                    if (t.endDate && parseDate(t.endDate).getTime() < currentDateIterator.getTime()) {
                        return; // Transaction has ended
                    }

                    let isNominallyEffectiveToday = false;
                    const diffTime = currentDateIterator.getTime() - transactionStartDate.getTime();
                    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                    switch (t.repeat) {
                        case 'none':
                            // For non-repeating, it must match the transaction's exact date
                            if (t.date === formattedCurrentDate) {
                                isNominallyEffectiveToday = true;
                            }
                            break;
                        case 'daily':
                            isNominallyEffectiveToday = true;
                            break;
                        case 'weekly':
                            // Check if the day of the week matches AND it's a multiple of 7 days from start
                            if (currentDateIterator.getDay() === transactionStartDate.getDay() && diffDays % 7 === 0) {
                                isNominallyEffectiveToday = true;
                            }
                            break;
                        case 'bi-weekly':
                            // Check if the day of the week matches AND it's a multiple of 14 days from start
                            if (currentDateIterator.getDay() === transactionStartDate.getDay() && diffDays % 14 === 0) {
                                isNominallyEffectiveToday = true;
                            }
                            break;
                        case 'four-weekly':
                            // Check if the day of the week matches AND it's a multiple of 28 days from start
                            if (currentDateIterator.getDay() === transactionStartDate.getDay() && diffDays % 28 === 0) {
                                isNominallyEffectiveToday = true;
                            }
                            break;
                        case 'monthly':
                            // Check if the day of the month matches (or is adjusted to month end), and it's on or after transaction start date
                            const nominalDayOfMonth = transactionStartDate.getDate();
                            const currentMonth = currentDateIterator.getMonth();
                            const currentYear = currentDateIterator.getFullYear();

                            let potentialDate = new Date(currentYear, currentMonth, nominalDayOfMonth);
                            // If the nominal day is past the end of the current month (e.g., 31st in Feb), use last day of month
                            if (potentialDate.getMonth() !== currentMonth) {
                                potentialDate = new Date(currentYear, currentMonth + 1, 0); // Last day of current month
                            }

                            if (potentialDate.getTime() === currentDateIterator.getTime() && potentialDate.getTime() >= transactionStartDate.getTime()) {
                                isNominallyEffectiveToday = true;
                            }
                            break;
                    }

                    if (isNominallyEffectiveToday) {
                        const effectiveDate = getNextWorkingDay(currentDateIterator);
                        if (formatDate(effectiveDate) === formattedCurrentDate) { // Check if the effective date is the current day
                            dailyNet += (t.type === 'income' ? t.amount : -t.amount);
                        }
                    }
                });

                cumulativeBalance += dailyNet; // Apply daily net for all days in the iteration range

                currentDateIterator.setDate(currentDateIterator.getDate() + 1);
            }
            return cumulativeBalance;
        }


        /**
         * Returns an array of transactions effective on a specific date.
         * @param {string} dateString - The date inYYYY-MM-DD format.
         * @returns {Array} List of transactions effective on that date.
         */
        function getTransactionsEffectiveOnDate(dateString) {
            const allTransactions = JSON.parse(localStorage.getItem('transactions')) || [];
            const selectedDayDate = parseDate(dateString);
            selectedDayDate.setHours(0, 0, 0, 0);

            const effectiveTransactions = [];

            allTransactions.forEach(t => {
                const transactionDate = parseDate(t.date);
                transactionDate.setHours(0, 0, 0, 0);

                // Check if the current date is within the transaction's active period (start and end date)
                if (transactionDate.getTime() > selectedDayDate.getTime()) {
                    return; // Transaction hasn't started yet
                }
                if (t.endDate && parseDate(t.endDate).getTime() < selectedDayDate.getTime()) {
                    return; // Transaction has ended
                }

                let nominalOccurrenceDate = null;
                const diffTime = selectedDayDate.getTime() - transactionDate.getTime();
                const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                switch (t.repeat) {
                    case 'none':
                        if (t.date === dateString) {
                            nominalOccurrenceDate = selectedDayDate;
                        }
                        break;
                    case 'daily':
                        nominalOccurrenceDate = selectedDayDate;
                        break;
                    case 'weekly':
                        if (selectedDayDate.getDay() === transactionDate.getDay() && diffDays % 7 === 0) {
                            nominalOccurrenceDate = selectedDayDate;
                        }
                        break;
                    case 'bi-weekly':
                        if (selectedDayDate.getDay() === transactionDate.getDay() && diffDays % 14 === 0) {
                            nominalOccurrenceDate = selectedDayDate;
                        }
                        break;
                    case 'four-weekly':
                        if (selectedDayDate.getDay() === transactionDate.getDay() && diffDays % 28 === 0) {
                            nominalOccurrenceDate = selectedDayDate;
                        }
                        break;
                    case 'monthly':
                        const nominalDayOfMonth = transactionDate.getDate();
                        const currentMonth = selectedDayDate.getMonth();
                        const currentYear = selectedDayDate.getFullYear();

                        let potentialDate = new Date(currentYear, currentMonth, nominalDayOfMonth);
                        // If the nominal day is past the end of the current month (e.g., 31st in Feb), use last day of month
                        if (potentialDate.getMonth() !== currentMonth) {
                            potentialDate = new Date(currentYear, currentMonth + 1, 0); // Last day of current month
                        }

                        if (potentialDate.getTime() === selectedDayDate.getTime() && potentialDate.getTime() >= transactionDate.getTime()) {
                            nominalOccurrenceDate = selectedDayDate;
                        }
                        break;
                }

                if (nominalOccurrenceDate) {
                    const effectiveDate = getNextWorkingDay(nominalOccurrenceDate);
                    if (formatDate(effectiveDate) === dateString) {
                        effectiveTransactions.push(t);
                    }
                }
            });
            return effectiveTransactions.sort((a, b) => a.name.localeCompare(b.name));
        }


        // --- Calendar Rendering ---
        function renderCalendar() {
            // Ensure calendarDaysEl is ready for monthly view
            calendarDaysEl.innerHTML = ''; // Clear existing content
            calendarContentWrapper.classList.remove('calendar-daily-view-container');
            calendarGridHeaderRow.style.display = 'grid';
            calendarDaysEl.classList.remove('daily-view-active');
            // Ensure calendarDaysEl has the grid class itself if it somehow lost it, though CSS should handle this
            calendarDaysEl.classList.add('calendar-grid-days'); // Make sure this class is always on the main container for monthly view
            calendarDaysEl.style.transform = 'translateX(0)'; // Reset transform for monthly view container
            calendarDaysEl.style.transition = 'none'; // Disable transition before new content is rendered

            currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });
            // prevMonthBtn.textContent = '< Prev'; // Removed: Keep original text
            // nextMonthBtn.textContent = 'Next >'; // Removed: Keep original text

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const firstDayIndex = getFirstDayOfMonth(currentYear, currentMonth); // 0 (Sun) - 6 (Sat)

            // Add blank days for the start of the month
            for (let i = 0; i < firstDayIndex; i++) {
                const blankDay = document.createElement('div');
                blankDay.className = 'calendar-day inactive';
                calendarDaysEl.appendChild(blankDay);
            }

            const today = new Date();
            const todayFormatted = formatDate(today);

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const formattedDate = formatDate(date);

                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.dataset.date = formattedDate;

                if (formattedDate === todayFormatted) {
                    dayEl.classList.add('today');
                }

                // Only render cumulative balance in monthly view
                dayEl.innerHTML = `<div class="calendar-day-number">${day}</div><div class="calendar-day-cumulative"></div>`;

                const cumulativeEl = dayEl.querySelector('.calendar-day-cumulative');

                // Get the balance for this specific day using the new calculation logic
                const balanceForThisDay = calculateBalanceUpToDate(date);
                
                // Format cumulative balance: abbreviate if >= 1000, rounding down to 1 decimal place
                let formattedCumulativeBalance;
                if (Math.abs(balanceForThisDay) >= 1000) {
                    // Round down to nearest 1 decimal place for thousands
                    formattedCumulativeBalance = `£${(Math.floor(balanceForThisDay / 100) / 10).toFixed(1)}k`;
                } else {
                    // Round down to the nearest whole pound for display
                    formattedCumulativeBalance = `£${Math.floor(balanceForThisDay).toFixed(0)}`;
                }
                
                cumulativeEl.textContent = formattedCumulativeBalance;
                if (balanceForThisDay >= 0) { /* Use original balance for color logic */
                    cumulativeEl.classList.add('positive');
                    cumulativeEl.classList.remove('negative');
                } else {
                    cumulativeEl.classList.add('negative');
                    cumulativeEl.classList.remove('positive');
                }

                // Changed: Clicking a day in monthly view now opens daily view
                dayEl.addEventListener('click', () => {
                    currentCalendarView = 'daily';
                    currentDailyDate = date; // Set the clicked date as the current daily date
                    calendarViewToggle.checked = true; // Update the toggle switch
                    updateCalendarView(); // Re-render in daily view
                });
                calendarDaysEl.appendChild(dayEl);
            }
        }

        // Function to render the daily view content into a container
        function renderDailyViewContent(date, parentElement, initialTransform = 'translateX(0)') {
            const formattedDate = formatDate(date);
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day today'; // Always highlight current day in daily view
            dayEl.dataset.date = formattedDate;

            // Display full date in the day number area, now including weekday
            dayEl.innerHTML = `
                <div class="calendar-day-number">${date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
                <div class="calendar-day-transactions"></div>
                <div class="calendar-day-cumulative"></div>
                <button class="btn-primary">Add New Transaction</button> <!-- Changed class to btn-primary -->
            `;

            const transactionsForDayEl = dayEl.querySelector('.calendar-day-transactions');
            const cumulativeEl = dayEl.querySelector('.calendar-day-cumulative');
            const addTransactionDailyBtn = dayEl.querySelector('.btn-primary'); // Select by new class

            const balanceForThisDay = calculateBalanceUpToDate(date);
            // Round down to the nearest whole pound for display in daily view
            const roundedBalanceForDisplay = Math.floor(balanceForThisDay);

            const transactionsOnThisDayForDisplay = getTransactionsEffectiveOnDate(formattedDate);

            if (transactionsOnThisDayForDisplay.length > 0) {
                transactionsForDayEl.innerHTML = ''; // Clear "No entries"
                transactionsOnThisDayForDisplay.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'modal-transaction-item flex justify-between items-center py-1';
                    const repeatText = t.repeat !== 'none' ? ` (Repeats ${t.repeat})` : '';
                    const displayType = t.type === 'income' ? '+' : '-';
                    const displayAmount = `${displayType}£${t.amount.toFixed(2)}`;

                    div.innerHTML = `
                        <div>
                            <p class="font-semibold text-sm">${t.name}</p>
                            <p class="text-xs text-gray-600">${displayAmount}${repeatText}</p>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="btn-edit" data-id="${t.id}" data-instance-date="${formattedDate}">Edit</button>
                            <button class="btn-delete" data-id="${t.id}">Delete</button>
                        </div>
                    `;
                    div.querySelector('.btn-edit').addEventListener('click', (e) => {
                        openEditTransactionModal(parseInt(e.target.dataset.id), e.target.dataset.instanceDate);
                    });
                    div.querySelector('.btn-delete').addEventListener('click', (e) => {
                        const transactionIdToDelete = parseInt(e.target.dataset.id);
                        transactions = transactions.filter(tx => tx.id !== transactionIdToDelete);
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                        showMessage('Transaction deleted!');
                        updateCalendarView(); // Re-render daily view after deletion
                    });
                    transactionsForDayEl.appendChild(div);
                });
            } else {
                transactionsForDayEl.innerHTML = '<p class="text-gray-400 text-left py-4">No entries</p>'; // Changed to text-left
            }

            cumulativeEl.textContent = `£${roundedBalanceForDisplay.toFixed(0)}`;
            if (roundedBalanceForDisplay >= 0) {
                cumulativeEl.classList.add('positive');
                cumulativeEl.classList.remove('negative');
            } else {
                cumulativeEl.classList.add('negative');
                cumulativeEl.classList.remove('positive');
            }

            addTransactionDailyBtn.addEventListener('click', () => openAddTransactionModal(formattedDate));

            const dailyViewContentWrapper = document.createElement('div');
            dailyViewContentWrapper.className = 'daily-view-content';
            dailyViewContentWrapper.style.transform = initialTransform;
            dailyViewContentWrapper.appendChild(dayEl);
            parentElement.appendChild(dailyViewContentWrapper);

            return dailyViewContentWrapper; // Return the new wrapper element
        }

        function updateCalendarView() {
            if (currentCalendarView === 'monthly') {
                // Clean up daily view elements if switching from daily
                if (currentDailyContentEl && currentDailyContentEl.parentNode) {
                    currentDailyContentEl.parentNode.removeChild(currentDailyContentEl);
                    currentDailyContentEl = null;
                }
                if (adjacentDailyContentEl && adjacentDailyContentEl.parentNode) {
                    adjacentDailyContentEl.parentNode.removeChild(adjacentDailyContentEl);
                    adjacentDailyContentEl = null;
                }
                
                // Clear calendarDaysEl before rendering new month content
                calendarDaysEl.innerHTML = ''; 
                calendarContentWrapper.classList.remove('calendar-daily-view-container');
                calendarGridHeaderRow.style.display = 'grid';
                calendarDaysEl.classList.remove('daily-view-active');
                // Ensure calendarDaysEl has the grid class itself if it somehow lost it, though CSS should handle this
                calendarDaysEl.classList.add('calendar-grid-days'); // Make sure this class is always on the main container for monthly view
                calendarDaysEl.style.transform = 'translateX(0)'; // Reset transform for monthly view container
                calendarDaysEl.style.transition = 'none'; // Disable transition before new content is rendered

                currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });
                // prevMonthBtn.textContent = '< Prev'; // Removed: Keep original text
                // nextMonthBtn.textContent = 'Next >'; // Removed: Keep original text

                const daysInMonth = getDaysInMonth(currentYear, currentMonth);
                const firstDayIndex = getFirstDayOfMonth(currentYear, currentMonth); // 0 (Sun) - 6 (Sat)

                // Add blank days for the start of the month
                for (let i = 0; i < firstDayIndex; i++) {
                    const blankDay = document.createElement('div');
                    blankDay.className = 'calendar-day inactive';
                    calendarDaysEl.appendChild(blankDay);
                }

                const today = new Date();
                const todayFormatted = formatDate(today);

                // Add days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentYear, currentMonth, day);
                    const formattedDate = formatDate(date);

                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.dataset.date = formattedDate;

                    if (formattedDate === todayFormatted) {
                        dayEl.classList.add('today');
                    }

                    // Only render cumulative balance in monthly view
                    dayEl.innerHTML = `<div class="calendar-day-number">${day}</div><div class="calendar-day-cumulative"></div>`;

                    const cumulativeEl = dayEl.querySelector('.calendar-day-cumulative');

                    // Get the balance for this specific day using the new calculation logic
                    const balanceForThisDay = calculateBalanceUpToDate(date);
                    
                    // Format cumulative balance: abbreviate if >= 1000, rounding down to 1 decimal place
                    let formattedCumulativeBalance;
                    if (Math.abs(balanceForThisDay) >= 1000) {
                        // Round down to nearest 1 decimal place for thousands
                        formattedCumulativeBalance = `£${(Math.floor(balanceForThisDay / 100) / 10).toFixed(1)}k`;
                    } else {
                        // Round down to the nearest whole pound for display
                        formattedCumulativeBalance = `£${Math.floor(balanceForThisDay).toFixed(0)}`;
                    }
                    
                    cumulativeEl.textContent = formattedCumulativeBalance;
                    if (balanceForThisDay >= 0) { /* Use original balance for color logic */
                        cumulativeEl.classList.add('positive');
                        cumulativeEl.classList.remove('negative');
                    } else {
                        cumulativeEl.classList.add('negative');
                        cumulativeEl.classList.remove('positive');
                    }

                    // Changed: Clicking a day in monthly view now opens daily view
                    dayEl.addEventListener('click', () => {
                        currentCalendarView = 'daily';
                        currentDailyDate = date; // Set the clicked date as the current daily date
                        calendarViewToggle.checked = true; // Update the toggle switch
                        updateCalendarView(); // Re-render in daily view
                    });
                    calendarDaysEl.appendChild(dayEl);
                }
            } else { // daily view
                // Clean up monthly view elements if switching from monthly
                // The currentMonthContentEl is no longer used, as renderCalendar directly populates calendarDaysEl.
                // So, we just need to ensure calendarDaysEl is cleared for daily view.
                
                // Ensure calendarDaysEl is set up for daily view
                calendarDaysEl.innerHTML = ''; // Clear any existing content
                calendarContentWrapper.classList.add('calendar-daily-view-container');
                calendarGridHeaderRow.style.display = 'none';
                calendarDaysEl.classList.add('daily-view-active'); // Add new class for styling
                
                // Render the current day
                currentDailyContentEl = renderDailyViewContent(currentDailyDate, calendarDaysEl);

                // Update header to only show month and year
                currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });
            }
        }

        calendarViewToggle.addEventListener('change', () => {
            currentCalendarView = calendarViewToggle.checked ? 'daily' : 'monthly';
            if (currentCalendarView === 'daily') {
                // When switching to daily view, set the currentDailyDate to the first day of the current month,
                // or today's date if today is within the current month.
                const today = new Date();
                if (today.getMonth() === currentMonth && today.getFullYear() === currentYear) {
                    currentDailyDate = new Date(currentYear, currentMonth, today.getDate());
                } else {
                    currentDailyDate = new Date(currentYear, currentMonth, 1);
                }
            }
            updateCalendarView();
        });

        // Event handlers for navigation buttons
        prevMonthBtn.addEventListener('click', () => {
            if (currentCalendarView === 'monthly') {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                updateCalendarView();
            } else { // daily view
                // Simulate a swipe to the right for "Prev Day"
                if (currentDailyContentEl) currentDailyContentEl.style.transition = 'transform 0.2s ease-out';
                if (adjacentDailyContentEl) adjacentDailyContentEl.style.transition = 'transform 0.2s ease-out';

                const prevDay = new Date(currentDailyDate);
                prevDay.setDate(prevDay.getDate() - 1);
                
                // If there's an existing adjacent element, remove it
                if (adjacentDailyContentEl && adjacentDailyContentEl.parentNode) {
                    adjacentDailyContentEl.parentNode.removeChild(adjacentDailyContentEl);
                    adjacentDailyContentEl = null;
                }
                adjacentDailyContentEl = renderDailyViewContent(prevDay, calendarDaysEl, 'translateX(-100%)'); // Render new day off-screen left

                if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(100%)'; // Slide current day out right
                if (adjacentDailyContentEl) adjacentDailyContentEl.style.transform = 'translateX(0)'; // Slide new day in

                // Update date after animation starts
                currentDailyDate.setDate(currentDailyDate.getDate() - 1);
                currentMonth = currentDailyDate.getMonth();
                currentYear = currentDailyDate.getFullYear();
                // Always update header to only show month and year
                currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });
                // Clean up old element after transition
                if (currentDailyContentEl) {
                    currentDailyContentEl.addEventListener('transitionend', function handler() {
                        currentDailyContentEl.removeEventListener('transitionend', handler);
                        if (currentDailyContentEl.parentNode) {
                            currentDailyContentEl.parentNode.removeChild(currentDailyContentEl);
                        }
                        // The adjacentDailyContentEl becomes the new current
                        currentDailyContentEl = adjacentDailyContentEl;
                        adjacentDailyContentEl = null; // Clear adjacent
                    }, { once: true }); // Use once: true to ensure listener is removed
                }
            }
        });

        nextMonthBtn.addEventListener('click', () => {
            if (currentCalendarView === 'monthly') {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                updateCalendarView();
            } else { // daily view
                // Simulate a swipe to the left for "Next Day"
                if (currentDailyContentEl) currentDailyContentEl.style.transition = 'transform 0.2s ease-out';
                if (adjacentDailyContentEl) adjacentDailyContentEl.style.transition = 'transform 0.2s ease-out';

                const nextDay = new Date(currentDailyDate);
                nextDay.setDate(nextDay.getDate() + 1);

                // If there's an existing adjacent element, remove it
                if (adjacentDailyContentEl && adjacentDailyContentEl.parentNode) {
                    adjacentDailyContentEl.parentNode.removeChild(adjacentDailyContentEl);
                    adjacentDailyContentEl = null;
                }
                adjacentDailyContentEl = renderDailyViewContent(nextDay, calendarDaysEl, 'translateX(100%)'); // Render new day off-screen right

                if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(-100%)'; // Slide current day out left
                if (adjacentDailyContentEl) adjacentDailyContentEl.style.transform = 'translateX(0)'; // Slide new day in

                // Update date after animation starts
                currentDailyDate.setDate(currentDailyDate.getDate() + 1);
                currentMonth = currentDailyDate.getMonth();
                currentYear = currentDailyDate.getFullYear();
                // Always update header to only show month and year
                currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });

                // Clean up old element after transition
                if (currentDailyContentEl) {
                    currentDailyContentEl.addEventListener('transitionend', function handler() {
                        currentDailyContentEl.removeEventListener('transitionend', handler);
                        if (currentDailyContentEl.parentNode) {
                            currentDailyContentEl.parentNode.removeChild(currentDailyContentEl);
                        }
                        // The adjacentDailyContentEl becomes the new current
                        currentDailyContentEl = adjacentDailyContentEl;
                        adjacentDailyContentEl = null; // Clear adjacent
                    }, { once: true }); // Use once: true to ensure listener is removed
                }
            }
        });

        // Mobile swipe/scroll gesture handling
        function isMobileView() {
            return window.innerWidth < 768; // Tailwind's 'md' breakpoint
        }

        calendarContentWrapper.addEventListener('touchstart', (e) => {
            if (isMobileView()) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY; // Store initial Y
                touchCurrentX = touchStartX;
                touchCurrentY = touchStartY;
                isGestureActive = true;
                gestureType = 'none'; // Reset gesture type
                
                // Disable transitions at the start of any touch to allow direct manipulation
                if (currentCalendarView === 'daily') {
                    if (currentDailyContentEl) currentDailyContentEl.style.transition = 'none';
                    if (adjacentDailyContentEl) adjacentDailyContentEl.style.transition = 'none'; // Ensure adjacent is also non-transitioning
                } else if (currentCalendarView === 'monthly') {
                    if (calendarDaysEl) calendarDaysEl.style.transition = 'none';
                }
            }
        }, { passive: false }); // passive: false is crucial for preventDefault

        calendarContentWrapper.addEventListener('touchmove', (e) => {
            if (isMobileView() && isGestureActive) {
                touchCurrentX = e.touches[0].clientX;
                touchCurrentY = e.touches[0].clientY;
                const deltaX = touchCurrentX - touchStartX;
                const deltaY = touchCurrentY - touchStartY;

                if (gestureType === 'none') {
                    // Determine gesture type after minimum movement
                    if (Math.abs(deltaX) > gestureThreshold || Math.abs(deltaY) > gestureThreshold) {
                        if (Math.abs(deltaX) > Math.abs(deltaY)) {
                            gestureType = 'swipe';
                            e.preventDefault(); // Prevent vertical scroll if it's a horizontal swipe
                        } else {
                            gestureType = 'scroll';
                            // Do NOT preventDefault, allow native scrolling
                        }
                    }
                }

                if (gestureType === 'swipe') {
                    e.preventDefault(); // Ensure default is prevented for horizontal swipes

                    if (currentCalendarView === 'daily') {
                        if (currentDailyContentEl) {
                            currentDailyContentEl.style.transform = `translateX(${deltaX}px)`;
                        }

                        // Pre-render adjacent day if not already rendered
                        if (!adjacentDailyContentEl) {
                            const adjacentDate = new Date(currentDailyDate);
                            if (deltaX < 0) { // Swiping left, so next day
                                adjacentDate.setDate(adjacentDate.getDate() + 1);
                                adjacentDailyContentEl = renderDailyViewContent(adjacentDate, calendarDaysEl, `translateX(${window.innerWidth}px)`);
                            } else { // Swiping right, so previous day
                                adjacentDate.setDate(adjacentDate.getDate() - 1);
                                adjacentDailyContentEl = renderDailyViewContent(adjacentDate, calendarDaysEl, `translateX(-${window.innerWidth}px)`);
                            }
                            if (adjacentDailyContentEl) {
                                adjacentDailyContentEl.style.transition = 'none'; // Disable transition for the new element
                            }
                        }

                        if (adjacentDailyContentEl) {
                            const initialAdjacentOffset = (deltaX < 0) ? window.innerWidth : -window.innerWidth;
                            adjacentDailyContentEl.style.transform = `translateX(${deltaX + initialAdjacentOffset}px)`;
                        }
                    } else if (currentCalendarView === 'monthly') {
                        // Monthly view swipe logic: apply transform directly to calendarDaysEl
                        if (calendarDaysEl) {
                            calendarDaysEl.style.transform = `translateX(${deltaX}px)`;
                        }
                    }
                }
                // If gestureType is 'scroll', we do nothing here, letting the browser handle it.
            }
        }, { passive: false }); // passive: false is crucial for preventDefault

        calendarContentWrapper.addEventListener('touchend', () => {
            if (isMobileView() && isGestureActive) {
                isGestureActive = false;
                const swipeThreshold = window.innerWidth / 3; // Swipe a third of the screen width
                const swipeDistance = touchCurrentX - touchStartX;

                // Re-enable transitions for snap-back/slide animations
                if (currentCalendarView === 'daily') {
                    if (currentDailyContentEl) currentDailyContentEl.style.transition = 'transform 0.2s ease-out';
                    if (adjacentDailyContentEl) adjacentDailyContentEl.style.transition = 'transform 0.2s ease-out';
                } else if (currentCalendarView === 'monthly') {
                    if (calendarDaysEl) calendarDaysEl.style.transition = 'transform 0.2s ease-out';
                }

                if (gestureType === 'swipe') {
                    if (Math.abs(swipeDistance) > swipeThreshold) {
                        // Swipe successful
                        if (swipeDistance < 0) { // Swiped left (next day/month)
                            if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(-100%)';
                            if (adjacentDailyContentEl) adjacentDailyContentEl.style.transform = 'translateX(0)';
                            if (currentCalendarView === 'monthly' && calendarDaysEl) calendarDaysEl.style.transform = 'translateX(-100%)';

                            if (currentCalendarView === 'daily') {
                                currentDailyDate.setDate(currentDailyDate.getDate() + 1); // Update date
                            } else { // monthly
                                currentMonth++;
                                if (currentMonth > 11) {
                                    currentMonth = 0;
                                    currentYear++;
                                }
                            }
                        } else { // Swiped right (previous day/month)
                            if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(100%)';
                            if (adjacentDailyContentEl) adjacentDailyContentEl.style.transform = 'translateX(0)';
                            if (currentCalendarView === 'monthly' && calendarDaysEl) calendarDaysEl.style.transform = 'translateX(100%)';

                            if (currentCalendarView === 'daily') {
                                currentDailyDate.setDate(currentDailyDate.getDate() - 1); // Update date
                            } else { // monthly
                                currentMonth--;
                                if (currentMonth < 0) {
                                    currentMonth = 11;
                                    currentYear--;
                                }
                            }
                        }

                        // Update header text immediately for visual feedback
                        // Always update header to only show month and year
                        currentMonthYearEl.textContent = new Date(currentYear, currentMonth).toLocaleString('en-GB', { month: 'long', year: 'numeric' });

                        // Clean up old element/re-render after transition completes
                        setTimeout(() => {
                            if (currentCalendarView === 'daily') {
                                if (currentDailyContentEl && currentDailyContentEl.parentNode) {
                                    currentDailyContentEl.parentNode.removeChild(currentDailyContentEl);
                                }
                                currentDailyContentEl = adjacentDailyContentEl;
                                adjacentDailyContentEl = null;
                                // Reset transform for the new current element to ensure it's at 0
                                if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(0)';
                            } else { // monthly
                                if (calendarDaysEl) {
                                    calendarDaysEl.style.transition = 'none'; // Disable transition before snapping back
                                    calendarDaysEl.style.transform = 'translateX(0)'; // Snap back to original position
                                }
                                updateCalendarView(); // Render the new month
                            }
                        }, 200); // Match CSS transition duration
                    } else {
                        // Swipe too short, snap back to original position
                        if (currentCalendarView === 'daily') {
                            if (currentDailyContentEl) currentDailyContentEl.style.transform = 'translateX(0)';
                            if (adjacentDailyContentEl) {
                                const initialAdjacentOffset = (swipeDistance < 0) ? window.innerWidth : -window.innerWidth;
                                adjacentDailyContentEl.style.transform = `translateX(${initialAdjacentOffset}px)`;
                                // Remove adjacent element after it snaps back
                                adjacentDailyContentEl.addEventListener('transitionend', function handler() {
                                    adjacentDailyContentEl.removeEventListener('transitionend', handler);
                                    if (adjacentDailyContentEl.parentNode) {
                                        adjacentDailyContentEl.parentNode.removeChild(adjacentDailyContentEl);
                                    }
                                    adjacentDailyContentEl = null;
                                }, { once: true });
                            }
                        } else { // monthly
                            if (calendarDaysEl) {
                                calendarDaysEl.style.transform = 'translateX(0)';
                            }
                        }
                    }
                }
                // Reset gesture state
                touchStartX = 0;
                touchStartY = 0;
                touchCurrentX = 0;
                touchCurrentY = 0;
                gestureType = 'none';
            }
        });


        // --- Add Transaction Modal Logic ---
        function openAddTransactionModal(date) {
            selectedDate = date;
            addModalDateEl.textContent = new Date(date).toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); // Now includes weekday
            // renderAddModalTransactions(date); // Removed call to render existing transactions
            openModal(addTransactionModal); // Use generic open modal function
            // Attempt to focus an input field to help with iOS PWA touch issues
            setTimeout(() => { // Add a small delay to ensure modal is fully rendered
                addTransactionNameInput.focus();
            }, 100);
        }

        function closeAddModal() {
            closeModal(addTransactionModal); // Use generic close modal function
            // Clear form fields when closing
            addTransactionTypeInput.value = 'expense';
            addTransactionNameInput.value = '';
            addTransactionAmountInput.value = '';
            addTransactionRepeatInput.value = 'none';
            selectedDate = null;
            toggleAddRepeatOptions(); // Ensure repeat options are visible for next open
            updateCalendarView(); // Re-render calendar to reflect changes, based on current view
            renderOverview(); // Also re-render overview in case current day's transactions changed
        }

        // Toggle visibility of repeat options based on transaction type for Add Modal
        function toggleAddRepeatOptions() {
            // Repeat options are always visible now that startingBalance is removed
            addTransactionRepeatGroup.classList.remove('hidden');
        }

        // Removed renderAddModalTransactions function as it's no longer needed

        // --- Edit Transaction Modal Logic ---
        function openEditTransactionModal(transactionId, instanceDate) {
            const originalTx = transactions.find(t => t.id === transactionId);
            if (!originalTx) {
                showMessage('Error: Transaction not found for editing.');
                return;
            }

            editingTransactionId = transactionId;
            editingTransactionInstanceDate = instanceDate; // The date of the specific instance being edited

            editTransactionTypeInput.value = originalTx.type;
            editTransactionNameInput.value = originalTx.name;
            editTransactionAmountInput.value = originalTx.amount;
            editTransactionRepeatInput.value = originalTx.repeat;

            toggleEditRepeatOptions(); // Adjust repeat options visibility

            // closeModal(addTransactionModal); // No need to close add modal if it's not open
            openModal(editTransactionModal); // Show edit modal
        }

        function closeEditModal() {
            closeModal(editTransactionModal); // Use generic close modal function
            editingTransactionId = null;
            editingTransactionInstanceDate = null;
            // renderAddModalTransactions(selectedDate); // Re-render add modal list - not needed anymore
            // openModal(addTransactionModal); // No need to open add modal again
            updateCalendarView(); // Re-render calendar
            renderOverview(); // Re-render overview
        }

        // Toggle visibility of repeat options based on transaction type for Edit Modal
        function toggleEditRepeatOptions() {
            // Repeat options are always visible now that startingBalance is removed
            editTransactionRepeatGroup.classList.remove('hidden');
        }

        // Event listener for transaction type change in Edit Modal
        editTransactionTypeInput.addEventListener('change', toggleEditRepeatOptions);

        // --- Overview Rendering ---
        function renderOverview() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayFormatted = formatDate(today);

            // 1. Today's transactions
            overviewTodaysTransactionsListEl.innerHTML = '';
            const todaysTransactions = getTransactionsEffectiveOnDate(todayFormatted);
            if (todaysTransactions.length === 0) {
                // Changed py-4 to pt-0 for the p tag inside
                overviewTodaysTransactionsListEl.innerHTML = '<p class="text-gray-500 text-left pt-0 text-sm">No transactions for today.</p>';
            } else {
                todaysTransactions.forEach(t => {
                    const div = document.createElement('div');
                    div.className = 'overview-transaction-item';
                    const displayType = t.type === 'income' ? '+' : '-';
                    const displayAmount = `${displayType}£${t.amount.toFixed(2)}`;
                    div.innerHTML = `
                        <span>${t.name}</span>
                        <span class="${t.type === 'income' ? 'text-green-700' : 'text-red-700'}">${displayAmount}</span>
                    `;
                    overviewTodaysTransactionsListEl.appendChild(div);
                });
            }

            // 2. Current Balance
            const currentBalance = calculateBalanceUpToDate(today);
            overviewCurrentBalanceEl.textContent = `£${currentBalance.toFixed(2)}`;
            overviewCurrentBalanceEl.classList.remove('positive', 'negative');
            if (currentBalance >= 0) {
                overviewCurrentBalanceEl.classList.add('positive');
            } else {
                overviewCurrentBalanceEl.classList.add('negative');
            }

            // 3. Days until next income transaction & 4. Lowest balance until next income
            let nextIncomeDate = null;
            let nextIncomeAmount = 0;
            
            let lowestBalanceInPeriod = currentBalance; 

            let searchDate = new Date(today);
            searchDate.setDate(searchDate.getDate() + 1); // Start searching from tomorrow

            const maxSearchDays = 365 * 2; // Limit search to 2 years to prevent infinite loops if no income
            let daysSearched = 0;

            while (!nextIncomeDate && daysSearched < maxSearchDays) {
                const transactionsOnSearchDate = getTransactionsEffectiveOnDate(formatDate(searchDate));
                let incomeFoundToday = false;

                transactionsOnSearchDate.forEach(t => {
                    if (t.type === 'income') {
                        incomeFoundToday = true;
                        nextIncomeAmount += t.amount;
                    }
                }
                );

                const balanceAtSearchDate = calculateBalanceUpToDate(searchDate);

                if (balanceAtSearchDate < lowestBalanceInPeriod) {
                    lowestBalanceInPeriod = balanceAtSearchDate;
                }

                if (incomeFoundToday) {
                    nextIncomeDate = searchDate;
                } else {
                    searchDate.setDate(searchDate.getDate() + 1);
                    daysSearched++;
                }
            }

            if (nextIncomeDate) {
                const diffDays = Math.round((nextIncomeDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                overviewNextIncomeStatementEl.textContent = `You will be paid £${nextIncomeAmount.toFixed(2)} in ${diffDays} day${diffDays === 1 ? '' : 's'}.`;
                
                overviewLowestBalanceEl.textContent = `£${lowestBalanceInPeriod.toFixed(2)}`;
                // Ensure value styling is applied
                overviewLowestBalanceEl.classList.remove('text-sm', 'text-gray-600'); // Remove message styling
                overviewLowestBalanceEl.classList.add('font-bold', 'text-xl'); // Add value styling
                overviewLowestBalanceEl.style.fontSize = ''; // Remove inline font size if set

                if (lowestBalanceInPeriod >= 0) {
                    overviewLowestBalanceEl.classList.add('positive');
                } else {
                    overviewLowestBalanceEl.classList.add('negative');
                }
            } else {
                overviewNextIncomeStatementEl.textContent = 'No future income found within 2 years.';
                
                overviewLowestBalanceEl.textContent = `Please provide your next expected income to see the funds that could be available.`;
                // Ensure message styling is applied
                overviewLowestBalanceEl.classList.remove('font-bold', 'text-xl'); // Remove value styling
                overviewLowestBalanceEl.classList.add('text-sm', 'text-gray-600'); // Add message styling
                overviewLowestBalanceEl.style.fontSize = '1.1rem'; // Set custom font size
            }

            // 5. Render Pie Chart
            renderPieChart();
        }

        // --- Pie Chart Logic ---
        function renderPieChart() {
            const currentMonthStart = new Date(currentYear, currentMonth, 1);
            const currentMonthEnd = new Date(currentYear, currentMonth + 1, 0); // Last day of current month

            let totalIncome = 0;
            let totalExpenses = 0;

            // Iterate through each day of the current month to accurately sum up repeating transactions
            let dayIterator = new Date(currentMonthStart);
            while (dayIterator.getTime() <= currentMonthEnd.getTime()) {
                const dailyTransactions = getTransactionsEffectiveOnDate(formatDate(dayIterator));
                dailyTransactions.forEach(t => {
                    if (t.type === 'income') {
                        totalIncome += t.amount;
                    } else {
                        totalExpenses += t.amount;
                    }
                });
                dayIterator.setDate(dayIterator.getDate() + 1);
            }

            if (totalIncome === 0 && totalExpenses === 0) {
                pieChartDescription.classList.remove('hidden');
                incomeExpensePieChartCanvas.classList.add('hidden');
                if (incomeExpensePieChartInstance) {
                    incomeExpensePieChartInstance.destroy();
                    incomeExpensePieChartInstance = null;
                }
            } else {
                pieChartDescription.classList.add('hidden');
                incomeExpensePieChartCanvas.classList.remove('hidden');

                if (incomeExpensePieChartInstance) {
                    incomeExpensePieChartInstance.destroy(); // Destroy previous chart instance
                }

                const ctx = incomeExpensePieChartCanvas.getContext('2d');
                incomeExpensePieChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Income', 'Expenses'],
                        datasets: [{
                            data: [totalIncome, totalExpenses],
                            backgroundColor: [
                                '#6366f1', // Income (Indigo 500)
                                '#a5b4fc'  // Expenses (Indigo 300)
                            ],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Set to false to allow container to define height
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    font: {
                                        size: 14,
                                        family: 'Inter'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += '£' + context.parsed.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // --- Pay Estimator Logic ---

        // UK Tax Year 2024/2025 (simplified)
        const TAX_YEAR_START_MONTH = 3; // April (0-indexed is 3)
        const TAX_YEAR_START_DAY = 6; // 6th April

        const UK_TAX_THRESHOLDS = {
            personalAllowance: 12570,
            basicRateBand: 37700, // 50270 - 12570
            higherRateBand: 74870, // 125140 - 50270
        };

        const UK_TAX_RATES = {
            basic: 0.20,
            higher: 0.40,
            additional: 0.45,
        };

        const UK_NI_THRESHOLDS_ANNUAL = {
            primaryThreshold: 12570, // No NI below this
            upperEarningsLimit: 50270, // 10% between PT and UEL
        };

        const UK_NI_RATES = {
            basic: 0.10, // 10% for earnings between PT and UEL
            additional: 0.02, // 2% for earnings above UEL
        };

        function calculateIncomeTax(annualGrossPay) {
            let tax = 0;
            let taxableIncome = Math.max(0, annualGrossPay - UK_TAX_THRESHOLDS.personalAllowance);

            // Basic Rate
            if (taxableIncome > 0) {
                const basicRateTaxable = Math.min(taxableIncome, UK_TAX_THRESHOLDS.basicRateBand);
                tax += basicRateTaxable * UK_TAX_RATES.basic;
                taxableIncome -= basicRateTaxable;
            }

            // Higher Rate
            if (taxableIncome > 0) {
                const higherRateTaxable = Math.min(taxableIncome, UK_TAX_THRESHOLDS.higherRateBand);
                tax += higherRateTaxable * UK_TAX_RATES.higher;
                taxableIncome -= higherRateTaxable;
            }

            // Additional Rate
            if (taxableIncome > 0) {
                tax += taxableIncome * UK_TAX_RATES.additional;
            }
            return tax;
        }

        function calculateNationalInsurance(annualGrossPay) {
            let ni = 0;
            const pt = UK_NI_THRESHOLDS_ANNUAL.primaryThreshold;
            const uel = UK_NI_THRESHOLDS_ANNUAL.upperEarningsLimit;

            // Earnings between Primary Threshold and Upper Earnings Limit
            if (annualGrossPay > pt) {
                const earningsInBasicBand = Math.min(annualGrossPay, uel) - pt;
                ni += earningsInBasicBand * UK_NI_RATES.basic;
            }

            // Earnings above Upper Earnings Limit
            if (annualGrossPay > uel) {
                const earningsInAdditionalBand = annualGrossPay - uel;
                ni += earningsInAdditionalBand * UK_NI_RATES.additional;
            }
            return ni;
        }

        function calculatePay() {
            const rateAmount = parseFloat(payRateAmountInput.value);
            const rateUnit = payRateUnitSelect.value;
            const contractedUnits = parseFloat(contractedUnitsInput.value);
            const payFrequency = payFrequencySelect.value;

            if (isNaN(rateAmount) || rateAmount <= 0) {
                showMessage('Please enter a valid positive rate amount.');
                return null; // Return null to indicate failure
            }
            if (rateUnit !== 'annually' && rateUnit !== 'monthly' && (isNaN(contractedUnits) || contractedUnits <= 0)) {
                showMessage('Please enter valid positive contracted units.');
                return null; // Return null to indicate failure
            }

            let annualGrossPay = 0;

            switch (rateUnit) {
                case 'hourly':
                    // Assuming contractedUnits is hours per week
                    annualGrossPay = rateAmount * contractedUnits * 52; // 52 weeks in a year
                    break;
                case 'daily':
                    // Assuming contractedUnits is days per week
                    annualGrossPay = rateAmount * contractedUnits * 52; // 52 weeks in a year
                    break;
                case 'weekly':
                    annualGrossPay = rateAmount * 52;
                    break;
                case 'monthly':
                    annualGrossPay = rateAmount * 12;
                    break;
                case 'annually':
                    annualGrossPay = rateAmount;
                    break;
                case 'project':
                    // Assuming contractedUnits is projects per year
                    annualGrossPay = rateAmount * contractedUnits;
                    break;
            }

            const annualTax = calculateIncomeTax(annualGrossPay);
            const annualNI = calculateNationalInsurance(annualGrossPay);
            const annualNetPay = annualGrossPay - annualTax - annualNI;

            let grossPay = 0;
            let niDeduction = 0;
            let taxDeduction = 0;
            let netPay = 0;

            switch (payFrequency) {
                case 'weekly':
                    grossPay = annualGrossPay / 52;
                    niDeduction = annualNI / 52;
                    taxDeduction = annualTax / 52;
                    netPay = annualNetPay / 52;
                    break;
                case 'bi-weekly':
                    grossPay = annualGrossPay / 26;
                    niDeduction = annualNI / 26;
                    taxDeduction = annualTax / 26;
                    netPay = annualNetPay / 26;
                    break;
                case 'four-weekly':
                    grossPay = annualGrossPay / 13; // 52 weeks / 4 weeks = 13 periods
                    niDeduction = annualNI / 13;
                    taxDeduction = annualTax / 13;
                    netPay = annualNetPay / 13;
                    break;
                case 'monthly':
                    grossPay = annualGrossPay / 12;
                    niDeduction = annualNI / 12;
                    taxDeduction = annualTax / 12;
                    netPay = annualNetPay / 12;
                    break;
                case 'annually':
                    grossPay = annualGrossPay;
                    niDeduction = annualNI;
                    taxDeduction = annualTax;
                    netPay = annualNetPay;
                    break;
            }

            grossPayResultSpan.textContent = `£${grossPay.toFixed(2)}`;
            niDeductionResultSpan.textContent = `£${niDeduction.toFixed(2)}`;
            taxDeductionResultSpan.textContent = `£${taxDeduction.toFixed(2)}`;
            netPayResultSpan.textContent = `£${netPay.toFixed(2)}`;
            payEstimatorResultsDiv.classList.remove('hidden');

            return { grossPay, niDeduction, taxDeduction, netPay, payFrequency };
        }

        function updateContractedUnitsLabel() {
            const rateUnit = payRateUnitSelect.value;
            contractedUnitsGroup.classList.remove('hidden'); // Show by default

            switch (rateUnit) {
                case 'hourly':
                    contractedUnitsLabel.textContent = 'Hours per Week:';
                    contractedUnitsInput.placeholder = 'e.g., 40';
                    break;
                case 'daily':
                    contractedUnitsLabel.textContent = 'Days per Week:';
                    contractedUnitsInput.placeholder = 'e.g., 5';
                    break;
                case 'weekly':
                    contractedUnitsGroup.classList.add('hidden'); // Hide for weekly
                    break;
                case 'monthly':
                    contractedUnitsGroup.classList.add('hidden'); // Hide for monthly
                    break;
                case 'annually':
                    contractedUnitsGroup.classList.add('hidden'); // Hide for annually
                    break;
                case 'project':
                    contractedUnitsLabel.textContent = 'Projects per Year (Avg):';
                    contractedUnitsInput.placeholder = 'e.g., 12';
                    break;
            }
        }

        payRateUnitSelect.addEventListener('change', updateContractedUnitsLabel);
        calculatePayBtn.addEventListener('click', calculatePay);

        addEstimatedPayToCalendarBtn.addEventListener('click', () => {
            const payData = calculatePay(); // Recalculate to get current values
            if (!payData) return; // If calculation failed, do nothing

            estimatedNetPayValue = payData.netPay;
            estimatedPayFrequencyValue = payData.payFrequency;

            modalEstimatedNetPaySpan.textContent = `£${estimatedNetPayValue.toFixed(2)}`;
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            nextPayDateInput.value = formatDate(tomorrow);
            
            confirmPayFrequencySelect.value = estimatedPayFrequencyValue;

            openModal(confirmPayAddModal); // Use generic open modal function
        });

        confirmAddPayBtn.addEventListener('click', () => {
            const selectedNextPayDate = nextPayDateInput.value;
            const confirmedFrequency = confirmPayFrequencySelect.value;

            if (!selectedNextPayDate) {
                showMessage('Please select a next pay day.');
                return;
            }

            if (estimatedNetPayValue <= 0) {
                showMessage('Net pay must be positive to add to calendar.');
                return;
            }
            
            const newTransaction = {
                id: Date.now(),
                type: 'income',
                name: `Estimated Net Pay (${confirmedFrequency})`,
                amount: estimatedNetPayValue,
                date: selectedNextPayDate, // Use the date from the modal
                repeat: confirmedFrequency, // Use the frequency from the modal
                endDate: null
            };

            transactions.push(newTransaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            showMessage(`Estimated net pay of £${estimatedNetPayValue.toFixed(2)} added to calendar for ${selectedNextPayDate}!`);
            
            closeModal(confirmPayAddModal); // Use generic close modal function
            updateCalendarView(); // Re-render calendar based on current view
            renderOverview();
        });

        closeConfirmPayAddModalBtn.addEventListener('click', () => closeModal(confirmPayAddModal));
        confirmPayAddModal.addEventListener('click', (e) => {
            if (e.target === confirmPayAddModal) {
                closeModal(confirmPayAddModal);
            }
        });

        // --- Universal Credit Logic ---
        const UC_RATES = {
            standardAllowance: {
                singleUnder25: 311.68,
                single25Over: 393.45,
                coupleBothUnder25: 488.82,
                coupleOneOrBoth25Over: 617.60
            },
            childElement: {
                firstChildBefore2017: 333.87, // Or only child
                otherChild: 287.92 // Second child and subsequent
            },
            disabilityElement: {
                lcw: 156.11,
                lcwra: 416.19
            },
            workAllowance: {
                noHousing: 379.00,
                withHousing: 631.00
            },
            taperRate: 0.55 // 55%
        };

        function calculateUniversalCredit() {
            const claimStatus = document.querySelector('input[name="ucClaimStatus"]:checked').value;
            let ageGroupP1 = document.querySelector('input[name="ucAge"]:checked')?.value; // Default for single, optional chaining for safety
            let ageGroupP2 = null;

            if (claimStatus === 'couple') {
                ageGroupP1 = document.querySelector('input[name="ucAgeP1"]:checked')?.value; // Corrected selector
                ageGroupP2 = document.querySelector('input[name="ucAgeP2"]:checked')?.value; // Corrected selector
            }

            const numChildren = parseInt(ucNumChildrenInput.value);
            const childBornBefore2017 = ucChildBornBefore2017Checkbox.checked;
            const disabilityStatus = ucDisabilityStatusSelect.value;
            const monthlyRent = parseFloat(ucMonthlyRentInput.value);
            const monthlyEarnings = parseFloat(ucMonthlyEarningsInput.value);

            let totalElements = 0;
            let standardAllowance = 0;
            let childElements = 0;
            let disabilityElement = 0;
            let housingElement = 0;
            let workAllowance = 0;
            let earningsDeduction = 0;
            let netUC = 0;

            // 1. Standard Allowance
            if (claimStatus === 'single') {
                standardAllowance = (ageGroupP1 === 'under25') ? UC_RATES.standardAllowance.singleUnder25 : UC_RATES.standardAllowance.single25Over;
            } else { // couple
                if (ageGroupP1 === 'under25' && ageGroupP2 === 'under25') {
                    standardAllowance = UC_RATES.standardAllowance.coupleBothUnder25;
                } else {
                    standardAllowance = UC_RATES.standardAllowance.coupleOneOrBoth25Over;
                }
            }
            totalElements += standardAllowance;

            // 2. Child Elements
            if (numChildren > 0) {
                if (childBornBefore2017) {
                    childElements += UC_RATES.childElement.firstChildBefore2017;
                    if (numChildren > 1) {
                        childElements += (numChildren - 1) * UC_RATES.childElement.otherChild;
                    }
                } else {
                    childElements += numChildren * UC_RATES.childElement.otherChild;
                }
            }
            totalElements += childElements;

            // 3. Disability Element
            if (disabilityStatus === 'lcw') {
                disabilityElement = UC_RATES.disabilityElement.lcw;
            } else if (disabilityStatus === 'lcwra') {
                disabilityElement = UC_RATES.disabilityElement.lcwra;
            }
            totalElements += disabilityElement;

            // 4. Housing Element
            housingElement = monthlyRent; // Simplified: Assumes full rent is covered, no LHA limits
            totalElements += housingElement;

            // 5. Work Allowance
            const hasChildrenOrDisability = (numChildren > 0 || disabilityStatus !== 'none');
            if (hasChildrenOrDisability) {
                workAllowance = (monthlyRent > 0) ? UC_RATES.workAllowance.withHousing : UC_RATES.workAllowance.noHousing;
            } else {
                workAllowance = 0; // No work allowance if no children and no disability
            }

            // 6. Earnings Deduction
            let earningsAfterWorkAllowance = Math.max(0, monthlyEarnings - workAllowance);
            earningsDeduction = earningsAfterWorkAllowance * UC_RATES.taperRate;

            // 7. Net UC Payment
            netUC = totalElements - earningsDeduction;
            netUC = Math.max(0, netUC); // UC cannot be negative

            ucStandardAllowanceSpan.textContent = `£${standardAllowance.toFixed(2)}`;
            ucChildElementsSpan.textContent = `£${childElements.toFixed(2)}`;
            ucDisabilityElementSpan.textContent = `£${disabilityElement.toFixed(2)}`;
            ucHousingElementSpan.textContent = `£${housingElement.toFixed(2)}`;
            ucTotalElementsSpan.textContent = `£${totalElements.toFixed(2)}`;
            ucWorkAllowanceSpan.textContent = `£${workAllowance.toFixed(2)}`;
            ucEarningsDeductionSpan.textContent = `£${earningsDeduction.toFixed(2)}`;
            ucNetPaymentSpan.textContent = `£${netUC.toFixed(2)}`;
            ucNetPaymentSpan.classList.toggle('negative', netUC < 0); // Apply negative class if needed
            ucCalculatorResultsDiv.classList.remove('hidden');

            return netUC;
        }

        // Event listeners for UC inputs to update age group visibility
        ucClaimStatusRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'single') {
                    ucAgeGroupSingleDiv.classList.remove('hidden');
                    ucAgeGroupCoupleDiv.classList.add('hidden');
                } else {
                    ucAgeGroupSingleDiv.classList.add('hidden');
                    ucAgeGroupCoupleDiv.classList.remove('hidden');
                }
            });
        });

        calculateUCBtn.addEventListener('click', calculateUniversalCredit);

        addEstimatedUCtoCalendarBtn.addEventListener('click', () => {
            estimatedUcPaymentValue = calculateUniversalCredit(); // Recalculate UC
            if (estimatedUcPaymentValue <= 0) {
                showMessage('Estimated Universal Credit must be positive to add to calendar.');
                return;
            }

            modalEstimatedUcPaymentSpan.textContent = `£${estimatedUcPaymentValue.toFixed(2)}`;
            
            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            nextUcPayDateInput.value = formatDate(tomorrow);
            
            // UC is always monthly, so pre-select monthly
            confirmUcFrequencySelect.value = 'monthly';

            openModal(confirmUcAddModal); // Use generic open modal function
        });

        confirmAddUcBtn.addEventListener('click', () => {
            const selectedNextUcPayDate = nextUcPayDateInput.value;
            const confirmedFrequency = confirmUcFrequencySelect.value; // Will always be monthly for UC

            if (!selectedNextUcPayDate) {
                showMessage('Please select a next UC payment day.');
                return;
            }

            if (estimatedUcPaymentValue <= 0) {
                showMessage('Net UC payment must be positive to add to calendar.');
                return;
            }
            
            const newTransaction = {
                id: Date.now(),
                type: 'income',
                name: `Estimated Universal Credit`,
                amount: estimatedUcPaymentValue,
                date: selectedNextUcPayDate,
                repeat: confirmedFrequency,
                endDate: null
            };

            transactions.push(newTransaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            showMessage(`Estimated UC of £${estimatedUcPaymentValue.toFixed(2)} added to calendar for ${selectedNextUcPayDate}!`);
            
            closeModal(confirmUcAddModal); // Use generic close modal function
            updateCalendarView(); // Re-render calendar based on current view
            renderOverview();
        });

        closeConfirmUcAddModalBtn.addEventListener('click', () => closeModal(confirmUcAddModal));
        confirmUcAddModal.addEventListener('click', (e) => {
            if (e.target === confirmUcAddModal) {
                closeModal(confirmUcAddModal);
            }
        });

        // New: Import Pay Estimator Earnings
        importPayEstimatorEarningsBtn.addEventListener('click', () => {
            const payData = calculatePay(); // Recalculate pay to get latest net pay
            if (payData && payData.netPay > 0) {
                // Convert net pay to monthly if it's not already monthly
                let monthlyNetPay = payData.netPay;
                switch (payData.payFrequency) {
                    case 'weekly':
                        monthlyNetPay = payData.netPay * (52 / 12);
                        break;
                    case 'bi-weekly':
                        monthlyNetPay = payData.netPay * (26 / 12);
                        break;
                    case 'four-weekly':
                        monthlyNetPay = payData.netPay * (13 / 12);
                        break;
                    case 'annually':
                        monthlyNetPay = payData.netPay / 12;
                        break;
                    // 'monthly' is already monthly
                }
                ucMonthlyEarningsInput.value = monthlyNetPay.toFixed(2);
                showMessage(`Monthly net earnings (£${monthlyNetPay.toFixed(2)}) imported from Pay Estimator!`);
            } else {
                showMessage('Please calculate a positive net pay in the Pay Estimator first.');
            }
        });


        // --- Event Listeners ---
        // Close modal buttons now use the generic closeModal function
        closeAddModalBtn.addEventListener('click', closeAddModal);
        addTransactionModal.addEventListener('click', (e) => {
            if (e.target === addTransactionModal) { // Close if clicked outside content
                closeAddModal();
            }
        });

        closeEditModalBtn.addEventListener('click', closeEditModal);
        editTransactionModal.addEventListener('click', (e) => {
            if (e.target === editTransactionModal) { // Close if clicked outside content
                closeEditModal();
            }
        });

        // Event listener for new Update Balance Button
        updateBalanceBtn.addEventListener('click', () => {
            const today = new Date();
            // Pre-fill with current balance if available, otherwise empty
            const currentBalance = calculateBalanceUpToDate(today);
            newBalanceAmountInput.value = currentBalance.toFixed(2);
            openModal(updateBalanceModal); // Use generic open modal function
        });

        function closeUpdateBalanceModal() {
            closeModal(updateBalanceModal); // Use generic close modal function
            newBalanceAmountInput.value = ''; // Clear input
            renderOverview(); // Re-render overview to reflect new balance
            updateCalendarView(); // Re-render calendar as well
        }

        closeUpdateBalanceModalBtn.addEventListener('click', closeUpdateBalanceModal);
        updateBalanceModal.addEventListener('click', (e) => {
            if (e.target === updateBalanceModal) {
                closeUpdateBalanceModal();
            }
        });

        saveBalanceBtn.addEventListener('click', () => {
            const newBalance = parseFloat(newBalanceAmountInput.value);
            if (isNaN(newBalance)) {
                showMessage('Please enter a valid number for your balance.');
                return;
            }

            const today = new Date();
            const todayFormatted = formatDate(today);

            // Remove any existing balance update for today, then add the new one
            balanceUpdates = balanceUpdates.filter(update => update.date !== todayFormatted);
            balanceUpdates.push({ date: todayFormatted, amount: newBalance });
            localStorage.setItem('balanceUpdates', JSON.stringify(balanceUpdates));

            showMessage('Balance updated successfully!');
            closeUpdateBalanceModal();
        });


        addTransactionTypeInput.addEventListener('change', toggleAddRepeatOptions);

        // Unified function for adding a transaction
        function handleAddTransaction(e) {
            // Prevent default behavior for touch events
            if (e.type === 'touchend') {
                e.preventDefault();
                e.stopPropagation(); // Stop event propagation for touch events
            }

            // Explicitly blur the select element to ensure it loses focus
            addTransactionRepeatInput.blur();

            const type = addTransactionTypeInput.value;
            const name = addTransactionNameInput.value.trim();
            const amount = parseFloat(addTransactionAmountInput.value);
            let repeat = addTransactionRepeatInput.value;

            if (!name || isNaN(amount) || amount <= 0) {
                showMessage('Please enter a valid name/source and a positive amount.');
                return;
            }

            const newTransaction = {
                id: Date.now(), // Unique ID for deletion
                type,
                name,
                amount,
                date: selectedDate, // Date of first occurrence
                repeat,
                endDate: null // Default to null for indefinite repetition
            };

            transactions.push(newTransaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            showMessage('Transaction added successfully!');
            // After adding, re-render the daily view if it's currently active for the selected date
            if (currentCalendarView === 'daily' && formatDate(currentDailyDate) === selectedDate) {
                updateCalendarView();
            }
            closeAddModal(); // Close the modal automatically after adding a transaction
        }

        // Attach both click and touchend listeners to the add transaction button
        addTransactionBtn.addEventListener('click', handleAddTransaction);
        addTransactionBtn.addEventListener('touchend', handleAddTransaction);


        saveEditedTransactionBtn.addEventListener('click', () => {
            const newType = editTransactionTypeInput.value;
            const newName = editTransactionNameInput.value.trim();
            const newAmount = parseFloat(editTransactionAmountInput.value);
            const newRepeat = editTransactionRepeatInput.value;
            // The scope is now always "thisAndFuture"

            if (!newName || isNaN(newAmount) || newAmount <= 0) {
                showMessage('Please enter a valid name/source and a positive amount.');
                return;
            }

            let originalTx = transactions.find(t => t.id === editingTransactionId);
            if (!originalTx) {
                showMessage('Error: Original transaction not found.');
                return;
            }

            const originalTxStartDate = parseDate(originalTx.date);
            const instanceDate = parseDate(editingTransactionInstanceDate);

            // Logic for "This event and all future events"
            if (originalTx.repeat === 'none' || originalTxStartDate.getTime() === instanceDate.getTime()) {
                // If it's a non-repeating transaction, or editing the very first instance of a repeating one
                originalTx.type = newType;
                originalTx.name = newName;
                originalTx.amount = newAmount;
                originalTx.repeat = newRepeat;
                originalTx.endDate = null; // If repeat is none, endDate remains null. If it's repeating, it repeats indefinitely from this point.
                showMessage('Changes applied to this event and all future events.');
            } else {
                // Editing a future instance of a repeating transaction - split it
                const newOriginalTxEndDate = new Date(instanceDate);
                newOriginalTxEndDate.setDate(newOriginalTxEndDate.getDate() - 1); // End original one day before instance date
                originalTx.endDate = formatDate(newOriginalTxEndDate);

                const newRepeatingTx = {
                    id: Date.now(),
                    type: newType,
                    name: newName,
                    amount: newAmount,
                    date: editingTransactionInstanceDate, // New repeating transaction starts from here
                    repeat: newRepeat,
                    endDate: null
                };
                transactions.push(newRepeatingTx);
                showMessage('Changes applied to this event and all future events (transaction split).');
            }

            localStorage.setItem('transactions', JSON.stringify(transactions));
            closeEditModal(); // Close edit modal, which will trigger re-render of add modal and calendar
        });

        // Function to handle tab switching logic (used by both desktop and mobile nav)
        function switchTab(tabName) {
            // Remove active class from all desktop tab buttons and hide all content
            desktopTabButtons.forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to the corresponding desktop button (if it exists)
            const targetDesktopButton = document.querySelector(`#desktopTabButtons .tab-button[data-tab="${tabName}"]`);
            if (targetDesktopButton) {
                targetDesktopButton.classList.add('active');
            }
            
            // Show corresponding content
            const targetTabContent = document.getElementById(tabName + 'TabContent');
            if (targetTabContent) {
                targetTabContent.classList.add('active');
            }

            // Perform tab-specific rendering/initialization
            if (tabName === 'overview') {
                renderOverview();
            } else if (tabName === 'calendar') {
                updateCalendarView();
            } else if (tabName === 'pay-estimator') {
                updateContractedUnitsLabel();
                payEstimatorResultsDiv.classList.add('hidden');
            } else if (tabName === 'universal-credit') {
                const currentClaimStatus = document.querySelector('input[name="ucClaimStatus"]:checked').value;
                if (currentClaimStatus === 'single') {
                    ucAgeGroupSingleDiv.classList.remove('hidden');
                    ucAgeGroupCoupleDiv.classList.add('hidden');
                } else {
                    ucAgeGroupSingleDiv.classList.add('hidden');
                    ucAgeGroupCoupleDiv.classList.remove('hidden');
                }
                ucCalculatorResultsDiv.classList.add('hidden');
            }
        }

        // Desktop tab switching logic
        desktopTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        // Mobile menu toggle button
        menuToggleBtn.addEventListener('click', () => {
            openModal(mobileNavModal);
        });

        // Close mobile nav modal button
        closeMobileNavModalBtn.addEventListener('click', () => closeModal(mobileNavModal));
        mobileNavModal.addEventListener('click', (e) => {
            if (e.target === mobileNavModal) { // Close if clicked outside content
                closeModal(mobileNavModal);
            }
        });

        // Mobile nav buttons inside the modal
        mobileNavButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
                closeModal(mobileNavModal); // Close the modal after selecting a tab
            });
        });

        // Amount Available Help Modal Listeners
        amountAvailableHelpBtn.addEventListener('click', () => {
            openModal(amountAvailableHelpModal);
        });
        closeAmountAvailableHelpModalBtn.addEventListener('click', () => {
            closeModal(amountAvailableHelpModal);
        });
        amountAvailableHelpModal.addEventListener('click', (e) => {
            if (e.target === amountAvailableHelpModal) {
                closeModal(amountAvailableHelpModal);
            }
        });


        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchBankHolidays(); // Fetch bank holidays on load
            // Set Overview as the default active tab
            switchTab('overview');
            // Only render monthly calendar initially, daily view will be rendered on toggle
            updateCalendarView(); 
        });

    </script>
</body>
</html>
